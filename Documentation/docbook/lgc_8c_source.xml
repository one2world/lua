<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<section xmlns="http://docbook.org/ns/docbook" version="5.0" xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="_lgc_8c_source" xml:lang="zh">
<title>D:/gitworkspace/lua/lgc.c</title>
<programlisting>00001 <emphasis role="comment">/*</emphasis>
00002 <emphasis role="comment">**&#32;$Id:&#32;lgc.c&#32;$</emphasis>
00003 <emphasis role="comment">**&#32;Garbage&#32;Collector</emphasis>
00004 <emphasis role="comment">**&#32;See&#32;Copyright&#32;Notice&#32;in&#32;lua.h</emphasis>
00005 <emphasis role="comment">*/</emphasis>
00006 
<anchor xml:id="_lgc_8c_source_1l00007"/><link linkend="_lgc_8c_1a61d084c4959fdcc23103ae67105b3472">00007</link> <emphasis role="preprocessor">#define&#32;lgc_c</emphasis>
<anchor xml:id="_lgc_8c_source_1l00008"/><link linkend="_lgc_8c_1abf0b3947b59218777a8e928a10be205b">00008</link> <emphasis role="preprocessor">#define&#32;LUA_CORE</emphasis>
00009 
00010 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="_lprefix_8h">lprefix.h</link>&quot;</emphasis>
00011 
00012 <emphasis role="preprocessor">#include&#32;&lt;stdio.h&gt;</emphasis>
00013 <emphasis role="preprocessor">#include&#32;&lt;string.h&gt;</emphasis>
00014 
00015 
00016 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="_lua_8h">lua.h</link>&quot;</emphasis>
00017 
00018 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="_ldebug_8h">ldebug.h</link>&quot;</emphasis>
00019 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="_ldo_8h">ldo.h</link>&quot;</emphasis>
00020 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="_lfunc_8h">lfunc.h</link>&quot;</emphasis>
00021 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="_lgc_8h">lgc.h</link>&quot;</emphasis>
00022 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="_lmem_8h">lmem.h</link>&quot;</emphasis>
00023 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="_lobject_8h">lobject.h</link>&quot;</emphasis>
00024 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="_lstate_8h">lstate.h</link>&quot;</emphasis>
00025 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="_lstring_8h">lstring.h</link>&quot;</emphasis>
00026 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="_ltable_8h">ltable.h</link>&quot;</emphasis>
00027 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="_ltm_8h">ltm.h</link>&quot;</emphasis>
00028 
00029 
00030 <emphasis role="comment">/*</emphasis>
00031 <emphasis role="comment">**&#32;Maximum&#32;number&#32;of&#32;elements&#32;to&#32;sweep&#32;in&#32;each&#32;single&#32;step.</emphasis>
00032 <emphasis role="comment">**&#32;(Large&#32;enough&#32;to&#32;dissipate&#32;fixed&#32;overheads&#32;but&#32;small&#32;enough</emphasis>
00033 <emphasis role="comment">**&#32;to&#32;allow&#32;small&#32;steps&#32;for&#32;the&#32;collector.)</emphasis>
00034 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00035"/><link linkend="_lgc_8c_1ac31abb557425090d41f055c797049ba8">00035</link> <emphasis role="preprocessor">#define&#32;GCSWEEPMAX&#32;&#32;100</emphasis>
00036 
00037 <emphasis role="comment">/*</emphasis>
00038 <emphasis role="comment">**&#32;Maximum&#32;number&#32;of&#32;finalizers&#32;to&#32;call&#32;in&#32;each&#32;single&#32;step.</emphasis>
00039 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00040"/><link linkend="_lgc_8c_1ac3a3667112bce0a226dbef4640edee94">00040</link> <emphasis role="preprocessor">#define&#32;GCFINMAX&#32;&#32;&#32;&#32;10</emphasis>
00041 
00042 
00043 <emphasis role="comment">/*</emphasis>
00044 <emphasis role="comment">**&#32;Cost&#32;of&#32;calling&#32;one&#32;finalizer.</emphasis>
00045 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00046"/><link linkend="_lgc_8c_1a84dfd5e385ed6792c171df6b6a972179">00046</link> <emphasis role="preprocessor">#define&#32;GCFINALIZECOST&#32;&#32;50</emphasis>
00047 
00048 
00049 <emphasis role="comment">/*</emphasis>
00050 <emphasis role="comment">**&#32;The&#32;equivalent,&#32;in&#32;bytes,&#32;of&#32;one&#32;unit&#32;of&#32;&quot;work&quot;&#32;(visiting&#32;a&#32;slot,</emphasis>
00051 <emphasis role="comment">**&#32;sweeping&#32;an&#32;object,&#32;etc.)</emphasis>
00052 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00053"/><link linkend="_lgc_8c_1a2f1af1a74ed552d994ae1a8f830bd6d2">00053</link> <emphasis role="preprocessor">#define&#32;WORK2MEM&#32;&#32;&#32;&#32;sizeof(TValue)</emphasis>
00054 
00055 
00056 <emphasis role="comment">/*</emphasis>
00057 <emphasis role="comment">**&#32;macro&#32;to&#32;adjust&#32;&apos;pause&apos;:&#32;&apos;pause&apos;&#32;is&#32;actually&#32;used&#32;like</emphasis>
00058 <emphasis role="comment">**&#32;&apos;pause&#32;/&#32;PAUSEADJ&apos;&#32;(value&#32;chosen&#32;by&#32;tests)</emphasis>
00059 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00060"/><link linkend="_lgc_8c_1a79ef06ea1e24ee7e3d343f67e954d68c">00060</link> <emphasis role="preprocessor">#define&#32;PAUSEADJ&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;100</emphasis>
00061 
00062 
00063 <emphasis role="comment">/*&#32;mask&#32;with&#32;all&#32;color&#32;bits&#32;*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00064"/><link linkend="_lgc_8c_1a31f875711ff997274eb999d7fe8ec639">00064</link> <emphasis role="preprocessor">#define&#32;maskcolors&#32;&#32;(bitmask(BLACKBIT)&#32;|&#32;WHITEBITS)</emphasis>
00065 
00066 <emphasis role="comment">/*&#32;mask&#32;with&#32;all&#32;GC&#32;bits&#32;*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00067"/><link linkend="_lgc_8c_1a3ea4c714396849e66d63d88a8987f149">00067</link> <emphasis role="preprocessor">#define&#32;maskgcbits&#32;&#32;&#32;&#32;&#32;&#32;(maskcolors&#32;|&#32;AGEBITS)</emphasis>
00068 
00069 
00070 <emphasis role="comment">/*&#32;macro&#32;to&#32;erase&#32;all&#32;color&#32;bits&#32;then&#32;set&#32;only&#32;the&#32;current&#32;white&#32;bit&#32;*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00071"/><link linkend="_lgc_8c_1ada061b1d508c516b2e53f546521b3eeb">00071</link> <emphasis role="preprocessor">#define&#32;makewhite(g,x)&#32;&#32;\</emphasis>
00072 <emphasis role="preprocessor">&#32;&#32;(x-&gt;marked&#32;=&#32;cast_byte((x-&gt;marked&#32;&amp;&#32;~maskcolors)&#32;|&#32;luaC_white(g)))</emphasis>
00073 
00074 <emphasis role="comment">/*&#32;make&#32;an&#32;object&#32;gray&#32;(neither&#32;white&#32;nor&#32;black)&#32;*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00075"/><link linkend="_lgc_8c_1ac0d91118389ea51c074e2baf41e03ccb">00075</link> <emphasis role="preprocessor">#define&#32;set2gray(x)&#32;resetbits(x-&gt;marked,&#32;maskcolors)</emphasis>
00076 
00077 
00078 <emphasis role="comment">/*&#32;make&#32;an&#32;object&#32;black&#32;(coming&#32;from&#32;any&#32;color)&#32;*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00079"/><link linkend="_lgc_8c_1a1cb0182cfa6e73b1665658a79c297d46">00079</link> <emphasis role="preprocessor">#define&#32;set2black(x)&#32;&#32;\</emphasis>
00080 <emphasis role="preprocessor">&#32;&#32;(x-&gt;marked&#32;=&#32;cast_byte((x-&gt;marked&#32;&amp;&#32;~WHITEBITS)&#32;|&#32;bitmask(BLACKBIT)))</emphasis>
00081 
00082 
<anchor xml:id="_lgc_8c_source_1l00083"/><link linkend="_lgc_8c_1a84251731518ce7f66d49363eb9f0f594">00083</link> <emphasis role="preprocessor">#define&#32;valiswhite(x)&#32;&#32;&#32;(iscollectable(x)&#32;&amp;&amp;&#32;iswhite(gcvalue(x)))</emphasis>
00084 
<anchor xml:id="_lgc_8c_source_1l00085"/><link linkend="_lgc_8c_1a4e2cb724f6d35593354bd90084b87d49">00085</link> <emphasis role="preprocessor">#define&#32;keyiswhite(n)&#32;&#32;&#32;(keyiscollectable(n)&#32;&amp;&amp;&#32;iswhite(gckey(n)))</emphasis>
00086 
00087 
00088 <emphasis role="comment">/*</emphasis>
00089 <emphasis role="comment">**&#32;Protected&#32;access&#32;to&#32;objects&#32;in&#32;values</emphasis>
00090 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00091"/><link linkend="_lgc_8c_1a7c7f051ea3f0945577e90c480ebeee88">00091</link> <emphasis role="preprocessor">#define&#32;gcvalueN(o)&#32;&#32;&#32;&#32;&#32;(iscollectable(o)&#32;?&#32;gcvalue(o)&#32;:&#32;NULL)</emphasis>
00092 
00093 
<anchor xml:id="_lgc_8c_source_1l00094"/><link linkend="_lgc_8c_1a2dd4136ac29665568973c074bc450849">00094</link> <emphasis role="preprocessor">#define&#32;markvalue(g,o)&#32;{&#32;checkliveness(g-&gt;mainthread,o);&#32;\</emphasis>
00095 <emphasis role="preprocessor">&#32;&#32;if&#32;(valiswhite(o))&#32;reallymarkobject(g,gcvalue(o));&#32;}</emphasis>
00096 
<anchor xml:id="_lgc_8c_source_1l00097"/><link linkend="_lgc_8c_1a177a5a645b1409b4f1c20e3c84018d40">00097</link> <emphasis role="preprocessor">#define&#32;markkey(g,&#32;n)&#32;&#32;&#32;{&#32;if&#32;keyiswhite(n)&#32;reallymarkobject(g,gckey(n));&#32;}</emphasis>
00098 
<anchor xml:id="_lgc_8c_source_1l00099"/><link linkend="_lgc_8c_1a6ae72c43e48b29944e55933df7f15482">00099</link> <emphasis role="preprocessor">#define&#32;markobject(g,t)&#32;{&#32;if&#32;(iswhite(t))&#32;reallymarkobject(g,&#32;obj2gco(t));&#32;}</emphasis>
00100 
00101 <emphasis role="comment">/*</emphasis>
00102 <emphasis role="comment">**&#32;mark&#32;an&#32;object&#32;that&#32;can&#32;be&#32;NULL&#32;(either&#32;because&#32;it&#32;is&#32;really&#32;optional,</emphasis>
00103 <emphasis role="comment">**&#32;or&#32;it&#32;was&#32;stripped&#32;as&#32;debug&#32;info,&#32;or&#32;inside&#32;an&#32;uncompleted&#32;structure)</emphasis>
00104 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00105"/><link linkend="_lgc_8c_1af9d4ee7e422989e2c45413745252211b">00105</link> <emphasis role="preprocessor">#define&#32;markobjectN(g,t)&#32;&#32;&#32;&#32;{&#32;if&#32;(t)&#32;markobject(g,t);&#32;}</emphasis>
00106 
00107 <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1aacf3c8ee0eebd5d5b1cd09da000ad53c">reallymarkobject</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*o);
00108 <emphasis role="keyword">static</emphasis>&#32;<link linkend="_llimits_8h_1aac8c50ca0aa51c80523376da77c2c4d8">lu_mem</link>&#32;<link linkend="_lgc_8c_1a41eded2c85eaf7e1911cd95da36882d9">atomic</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L);
00109 <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1aea46d650b68fac11368a752058b80ab7">entersweep</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L);
00110 
00111 
00112 <emphasis role="comment">/*</emphasis>
00113 <emphasis role="comment">**&#32;{======================================================</emphasis>
00114 <emphasis role="comment">**&#32;Generic&#32;functions</emphasis>
00115 <emphasis role="comment">**&#32;=======================================================</emphasis>
00116 <emphasis role="comment">*/</emphasis>
00117 
00118 
00119 <emphasis role="comment">/*</emphasis>
00120 <emphasis role="comment">**&#32;one&#32;after&#32;last&#32;element&#32;in&#32;a&#32;hash&#32;array</emphasis>
00121 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00122"/><link linkend="_lgc_8c_1a43ef7b8388b613e737dd3ec7eb493f47">00122</link> <emphasis role="preprocessor">#define&#32;gnodelast(h)&#32;&#32;&#32;&#32;gnode(h,&#32;cast_sizet(sizenode(h)))</emphasis>
00123 
00124 
<anchor xml:id="_lgc_8c_source_1l00125"/><link linkend="_lgc_8c_1a10a95d9a52dbdb6f36c090f5e2870007">00125</link> <emphasis role="keyword">static</emphasis>&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;**<link linkend="_lgc_8c_1a10a95d9a52dbdb6f36c090f5e2870007">getgclist</link>&#32;(<link linkend="_struct_g_c_object">GCObject</link>&#32;*o)&#32;{
00126 &#32;&#32;<emphasis role="keywordflow">switch</emphasis>&#32;(o-&gt;tt)&#32;{
00127 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1afaf24d5b79b9027ad768d023778669df">LUA_VTABLE</link>:&#32;<emphasis role="keywordflow">return</emphasis>&#32;&amp;<link linkend="_lstate_8h_1a4f233ba369144fad9fd5fc6c513da1ac">gco2t</link>(o)-&gt;gclist;
00128 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1a5d0e6e41ea93960667095501aa5745c1">LUA_VLCL</link>:&#32;<emphasis role="keywordflow">return</emphasis>&#32;&amp;<link linkend="_lstate_8h_1adaac0379079b200986d6ae72b65aefaf">gco2lcl</link>(o)-&gt;gclist;
00129 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1a2361d923ddb7fc1468b978fe043e35c2">LUA_VCCL</link>:&#32;<emphasis role="keywordflow">return</emphasis>&#32;&amp;<link linkend="_lstate_8h_1a1dcf2ea170c68fe70adb5af7ae04c71e">gco2ccl</link>(o)-&gt;gclist;
00130 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1ad224258ccc4e8f79f148d54d32ddbd00">LUA_VTHREAD</link>:&#32;<emphasis role="keywordflow">return</emphasis>&#32;&amp;<link linkend="_lstate_8h_1a52c467e11bd40cad5ca78372f7f67b4d">gco2th</link>(o)-&gt;gclist;
00131 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1a1c6c32cba3e6d0c897f68ceb273dd757">LUA_VPROTO</link>:&#32;<emphasis role="keywordflow">return</emphasis>&#32;&amp;<link linkend="_lstate_8h_1a8792af5dd4539a71f6ed8ddb31d079c3">gco2p</link>(o)-&gt;gclist;
00132 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1af45b44d4031e7e869195dd97759d2ca3">LUA_VUSERDATA</link>:&#32;{
00133 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_struct_udata">Udata</link>&#32;*u&#32;=&#32;<link linkend="_lstate_8h_1a55e9a228ad0d3a82ee9cfc353002fd8a">gco2u</link>(o);
00134 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(u-&gt;<link linkend="_struct_udata_1a73b0125a5ce1394f28d43c93751a9db5">nuvalue</link>&#32;&gt;&#32;0);
00135 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;&amp;u-&gt;<link linkend="_struct_udata_1a9e83d376257d9d775ce3e9c6f40ef0f1">gclist</link>;
00136 &#32;&#32;&#32;&#32;}
00137 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">default</emphasis>:&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(0);&#32;<emphasis role="keywordflow">return</emphasis>&#32;0;
00138 &#32;&#32;}
00139 }
00140 
00141 
00142 <emphasis role="comment">/*</emphasis>
00143 <emphasis role="comment">**&#32;Link&#32;a&#32;collectable&#32;object&#32;&apos;o&apos;&#32;with&#32;a&#32;known&#32;type&#32;into&#32;the&#32;list&#32;&apos;p&apos;.</emphasis>
00144 <emphasis role="comment">**&#32;(Must&#32;be&#32;a&#32;macro&#32;to&#32;access&#32;the&#32;&apos;gclist&apos;&#32;field&#32;in&#32;different&#32;types.)</emphasis>
00145 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00146"/><link linkend="_lgc_8c_1ad63f9d59a67a756d3c3540d9795cdcbe">00146</link> <emphasis role="preprocessor">#define&#32;linkgclist(o,p)&#32;linkgclist_(obj2gco(o),&#32;&amp;(o)-&gt;gclist,&#32;&amp;(p))</emphasis>
00147 
<anchor xml:id="_lgc_8c_source_1l00148"/><link linkend="_lgc_8c_1a26a89a256432393ba07aeaebbf36128e">00148</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a26a89a256432393ba07aeaebbf36128e">linkgclist_</link>&#32;(<link linkend="_struct_g_c_object">GCObject</link>&#32;*o,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;**pnext,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;**list)&#32;{
00149 &#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(!<link linkend="_lgc_8h_1ad417e22072630b33cf74a3055b27d8d7">isgray</link>(o));&#32;&#32;<emphasis role="comment">/*&#32;cannot&#32;be&#32;in&#32;a&#32;gray&#32;list&#32;*/</emphasis>
00150 &#32;&#32;*pnext&#32;=&#32;*list;
00151 &#32;&#32;*list&#32;=&#32;o;
00152 &#32;&#32;<link linkend="_lgc_8c_1ac0d91118389ea51c074e2baf41e03ccb">set2gray</link>(o);&#32;&#32;<emphasis role="comment">/*&#32;now&#32;it&#32;is&#32;*/</emphasis>
00153 }
00154 
00155 
00156 <emphasis role="comment">/*</emphasis>
00157 <emphasis role="comment">**&#32;Link&#32;a&#32;generic&#32;collectable&#32;object&#32;&apos;o&apos;&#32;into&#32;the&#32;list&#32;&apos;p&apos;.</emphasis>
00158 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00159"/><link linkend="_lgc_8c_1a69a219e9e1a524d24173ef477419f87c">00159</link> <emphasis role="preprocessor">#define&#32;linkobjgclist(o,p)&#32;linkgclist_(obj2gco(o),&#32;getgclist(o),&#32;&amp;(p))</emphasis>
00160 
00161 
00162 
00163 <emphasis role="comment">/*</emphasis>
00164 <emphasis role="comment">**&#32;Clear&#32;keys&#32;for&#32;empty&#32;entries&#32;in&#32;tables.&#32;If&#32;entry&#32;is&#32;empty</emphasis>
00165 <emphasis role="comment">**&#32;and&#32;its&#32;key&#32;is&#32;not&#32;marked,&#32;mark&#32;its&#32;entry&#32;as&#32;dead.&#32;This&#32;allows&#32;the</emphasis>
00166 <emphasis role="comment">**&#32;collection&#32;of&#32;the&#32;key,&#32;but&#32;keeps&#32;its&#32;entry&#32;in&#32;the&#32;table&#32;(its&#32;removal</emphasis>
00167 <emphasis role="comment">**&#32;could&#32;break&#32;a&#32;chain).&#32;The&#32;main&#32;feature&#32;of&#32;a&#32;dead&#32;key&#32;is&#32;that&#32;it&#32;must</emphasis>
00168 <emphasis role="comment">**&#32;be&#32;different&#32;from&#32;any&#32;other&#32;value,&#32;to&#32;do&#32;not&#32;disturb&#32;searches.</emphasis>
00169 <emphasis role="comment">**&#32;Other&#32;places&#32;never&#32;manipulate&#32;dead&#32;keys,&#32;because&#32;its&#32;associated&#32;empty</emphasis>
00170 <emphasis role="comment">**&#32;value&#32;is&#32;enough&#32;to&#32;signal&#32;that&#32;the&#32;entry&#32;is&#32;logically&#32;empty.</emphasis>
00171 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00172"/><link linkend="_lgc_8c_1ae5b5bd4c69910951078ac627fa1654da">00172</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1ae5b5bd4c69910951078ac627fa1654da">clearkey</link>&#32;(<link linkend="_union_node">Node</link>&#32;*n)&#32;{
00173 &#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(<link linkend="_lobject_8h_1a5345ae49ed16dfecdfef95ec5399b000">isempty</link>(<link linkend="_ltable_8h_1acbbecd9bd8fbb72a17f6e2f5acf7113d">gval</link>(n)));
00174 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8c_1a4e2cb724f6d35593354bd90084b87d49">keyiswhite</link>(n))
00175 &#32;&#32;&#32;&#32;<link linkend="_lobject_8h_1af8e25f008b9446cacc6cd5e2e5508f5d">setdeadkey</link>(n);&#32;&#32;<emphasis role="comment">/*&#32;unused&#32;and&#32;unmarked&#32;key;&#32;remove&#32;it&#32;*/</emphasis>
00176 }
00177 
00178 
00179 <emphasis role="comment">/*</emphasis>
00180 <emphasis role="comment">**&#32;tells&#32;whether&#32;a&#32;key&#32;or&#32;value&#32;can&#32;be&#32;cleared&#32;from&#32;a&#32;weak</emphasis>
00181 <emphasis role="comment">**&#32;table.&#32;Non-collectable&#32;objects&#32;are&#32;never&#32;removed&#32;from&#32;weak</emphasis>
00182 <emphasis role="comment">**&#32;tables.&#32;Strings&#32;behave&#32;as&#32;&apos;values&apos;,&#32;so&#32;are&#32;never&#32;removed&#32;too.&#32;for</emphasis>
00183 <emphasis role="comment">**&#32;other&#32;objects:&#32;if&#32;really&#32;collected,&#32;cannot&#32;keep&#32;them;&#32;for&#32;objects</emphasis>
00184 <emphasis role="comment">**&#32;being&#32;finalized,&#32;keep&#32;them&#32;in&#32;keys,&#32;but&#32;not&#32;in&#32;values</emphasis>
00185 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00186"/><link linkend="_lgc_8c_1acae02b6cdb8288e654682baf4117e8ab">00186</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_lgc_8c_1acae02b6cdb8288e654682baf4117e8ab">iscleared</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g,&#32;<emphasis role="keyword">const</emphasis>&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*o)&#32;{
00187 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(o&#32;==&#32;NULL)&#32;<emphasis role="keywordflow">return</emphasis>&#32;0;&#32;&#32;<emphasis role="comment">/*&#32;non-collectable&#32;value&#32;*/</emphasis>
00188 &#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lobject_8h_1a40d12e88a0d8249d226109e0d6d70dd6">novariant</link>(o-&gt;tt)&#32;==&#32;<link linkend="_lua_8h_1a57de20d87bb5131a3159f2bd52e3fab6">LUA_TSTRING</link>)&#32;{
00189 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a6ae72c43e48b29944e55933df7f15482">markobject</link>(g,&#32;o);&#32;&#32;<emphasis role="comment">/*&#32;strings&#32;are&#32;&apos;values&apos;,&#32;so&#32;are&#32;never&#32;weak&#32;*/</emphasis>
00190 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;0;
00191 &#32;&#32;}
00192 &#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;<emphasis role="keywordflow">return</emphasis>&#32;<link linkend="_lgc_8h_1a4c0ce78d476460d2e54914301f4a4bf7">iswhite</link>(o);
00193 }
00194 
00195 
00196 <emphasis role="comment">/*</emphasis>
00197 <emphasis role="comment">**&#32;Barrier&#32;that&#32;moves&#32;collector&#32;forward,&#32;that&#32;is,&#32;marks&#32;the&#32;white&#32;object</emphasis>
00198 <emphasis role="comment">**&#32;&apos;v&apos;&#32;being&#32;pointed&#32;by&#32;the&#32;black&#32;object&#32;&apos;o&apos;.&#32;&#32;In&#32;the&#32;generational</emphasis>
00199 <emphasis role="comment">**&#32;mode,&#32;&apos;v&apos;&#32;must&#32;also&#32;become&#32;old,&#32;if&#32;&apos;o&apos;&#32;is&#32;old;&#32;however,&#32;it&#32;cannot</emphasis>
00200 <emphasis role="comment">**&#32;be&#32;changed&#32;directly&#32;to&#32;OLD,&#32;because&#32;it&#32;may&#32;still&#32;point&#32;to&#32;non-old</emphasis>
00201 <emphasis role="comment">**&#32;objects.&#32;So,&#32;it&#32;is&#32;marked&#32;as&#32;OLD0.&#32;In&#32;the&#32;next&#32;cycle&#32;it&#32;will&#32;become</emphasis>
00202 <emphasis role="comment">**&#32;OLD1,&#32;and&#32;in&#32;the&#32;next&#32;it&#32;will&#32;finally&#32;become&#32;OLD&#32;(regular&#32;old).&#32;By</emphasis>
00203 <emphasis role="comment">**&#32;then,&#32;any&#32;object&#32;it&#32;points&#32;to&#32;will&#32;also&#32;be&#32;old.&#32;&#32;If&#32;called&#32;in&#32;the</emphasis>
00204 <emphasis role="comment">**&#32;incremental&#32;sweep&#32;phase,&#32;it&#32;clears&#32;the&#32;black&#32;object&#32;to&#32;white&#32;(sweep</emphasis>
00205 <emphasis role="comment">**&#32;it)&#32;to&#32;avoid&#32;other&#32;barrier&#32;calls&#32;for&#32;this&#32;same&#32;object.&#32;(That&#32;cannot</emphasis>
00206 <emphasis role="comment">**&#32;be&#32;done&#32;is&#32;generational&#32;mode,&#32;as&#32;its&#32;sweep&#32;does&#32;not&#32;distinguish</emphasis>
00207 <emphasis role="comment">**&#32;whites&#32;from&#32;deads.)</emphasis>
00208 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00209"/><link linkend="_lgc_8h_1ac5106ee2a18cde8bc3bd92e5891ad8e5">00209</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a72c69b5d5554e0ea4b65e894f2a50793">luaC_barrier_</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*o,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*v)&#32;{
00210 &#32;&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g&#32;=&#32;<link linkend="_lstate_8h_1a103db2de6edf3420c6c6c9a282562406">G</link>(L);
00211 &#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(<link linkend="_lgc_8h_1ac1e4847ad9a91e4cea36520dc9078365">isblack</link>(o)&#32;&amp;&amp;&#32;<link linkend="_lgc_8h_1a4c0ce78d476460d2e54914301f4a4bf7">iswhite</link>(v)&#32;&amp;&amp;&#32;!<link linkend="_lgc_8h_1acc409eb45f598d23d8388fc9e96189ea">isdead</link>(g,&#32;v)&#32;&amp;&amp;&#32;!<link linkend="_lgc_8h_1acc409eb45f598d23d8388fc9e96189ea">isdead</link>(g,&#32;o));
00212 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8h_1a40b40242e96f45f8d04dcf4feb1475ae">keepinvariant</link>(g))&#32;{&#32;&#32;<emphasis role="comment">/*&#32;must&#32;keep&#32;invariant?&#32;*/</emphasis>
00213 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1aacf3c8ee0eebd5d5b1cd09da000ad53c">reallymarkobject</link>(g,&#32;v);&#32;&#32;<emphasis role="comment">/*&#32;restore&#32;invariant&#32;*/</emphasis>
00214 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8h_1a24d47e523ecf2d6e475a34913ce06b05">isold</link>(o))&#32;{
00215 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(!<link linkend="_lgc_8h_1a24d47e523ecf2d6e475a34913ce06b05">isold</link>(v));&#32;&#32;<emphasis role="comment">/*&#32;white&#32;object&#32;could&#32;not&#32;be&#32;old&#32;*/</emphasis>
00216 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8h_1a42f07cc5f8f0a9d97989f7769f00c3f2">setage</link>(v,&#32;<link linkend="_lgc_8h_1a19ac124332eabcbdcb744e14923700b9">G_OLD0</link>);&#32;&#32;<emphasis role="comment">/*&#32;restore&#32;generational&#32;invariant&#32;*/</emphasis>
00217 &#32;&#32;&#32;&#32;}
00218 &#32;&#32;}
00219 &#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;{&#32;&#32;<emphasis role="comment">/*&#32;sweep&#32;phase&#32;*/</emphasis>
00220 &#32;&#32;&#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(<link linkend="_lgc_8h_1a860db734bc919435aba75c30e4fe261b">issweepphase</link>(g));
00221 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(g-&gt;<link linkend="_structglobal___state_1a603b7a85bbaf95ecc2ac48bf08ffe0e6">gckind</link>&#32;==&#32;<link linkend="_lstate_8h_1a52c54e51ee8ad2218ac72b745afc2f7d">KGC_INC</link>)&#32;&#32;<emphasis role="comment">/*&#32;incremental&#32;mode?&#32;*/</emphasis>
00222 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ada061b1d508c516b2e53f546521b3eeb">makewhite</link>(g,&#32;o);&#32;&#32;<emphasis role="comment">/*&#32;mark&#32;&apos;o&apos;&#32;as&#32;white&#32;to&#32;avoid&#32;other&#32;barriers&#32;*/</emphasis>
00223 &#32;&#32;}
00224 }
00225 
00226 
00227 <emphasis role="comment">/*</emphasis>
00228 <emphasis role="comment">**&#32;barrier&#32;that&#32;moves&#32;collector&#32;backward,&#32;that&#32;is,&#32;mark&#32;the&#32;black&#32;object</emphasis>
00229 <emphasis role="comment">**&#32;pointing&#32;to&#32;a&#32;white&#32;object&#32;as&#32;gray&#32;again.</emphasis>
00230 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00231"/><link linkend="_lgc_8h_1a65d1fcc6e437592a5a893406cce7d8e3">00231</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a61ad59cdf3484ff64c0c3cb7a48388ad">luaC_barrierback_</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*o)&#32;{
00232 &#32;&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g&#32;=&#32;<link linkend="_lstate_8h_1a103db2de6edf3420c6c6c9a282562406">G</link>(L);
00233 &#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(<link linkend="_lgc_8h_1ac1e4847ad9a91e4cea36520dc9078365">isblack</link>(o)&#32;&amp;&amp;&#32;!<link linkend="_lgc_8h_1acc409eb45f598d23d8388fc9e96189ea">isdead</link>(g,&#32;o));
00234 &#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>((g-&gt;<link linkend="_structglobal___state_1a603b7a85bbaf95ecc2ac48bf08ffe0e6">gckind</link>&#32;==&#32;<link linkend="_lstate_8h_1aa2765fe939333ebc895ba9cedbaa30a0">KGC_GEN</link>)&#32;==&#32;(<link linkend="_lgc_8h_1a24d47e523ecf2d6e475a34913ce06b05">isold</link>(o)&#32;&amp;&amp;&#32;<link linkend="_lgc_8h_1ae68465c1574c4b45a05a6548ad934235">getage</link>(o)&#32;!=&#32;<link linkend="_lgc_8h_1ae2c1796f4fb3359730723ce0acd2d162">G_TOUCHED1</link>));
00235 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8h_1ae68465c1574c4b45a05a6548ad934235">getage</link>(o)&#32;==&#32;<link linkend="_lgc_8h_1ac2b8a2255c79c9f43f88d1625767e1bf">G_TOUCHED2</link>)&#32;&#32;<emphasis role="comment">/*&#32;already&#32;in&#32;gray&#32;list?&#32;*/</emphasis>
00236 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ac0d91118389ea51c074e2baf41e03ccb">set2gray</link>(o);&#32;&#32;<emphasis role="comment">/*&#32;make&#32;it&#32;gray&#32;to&#32;become&#32;touched1&#32;*/</emphasis>
00237 &#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;&#32;<emphasis role="comment">/*&#32;link&#32;it&#32;in&#32;&apos;grayagain&apos;&#32;and&#32;paint&#32;it&#32;gray&#32;*/</emphasis>
00238 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a69a219e9e1a524d24173ef477419f87c">linkobjgclist</link>(o,&#32;g-&gt;<link linkend="_structglobal___state_1af6b3198325143bc0a9a529e9b14ff29a">grayagain</link>);
00239 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8h_1a24d47e523ecf2d6e475a34913ce06b05">isold</link>(o))&#32;&#32;<emphasis role="comment">/*&#32;generational&#32;mode?&#32;*/</emphasis>
00240 &#32;&#32;&#32;&#32;<link linkend="_lgc_8h_1a42f07cc5f8f0a9d97989f7769f00c3f2">setage</link>(o,&#32;<link linkend="_lgc_8h_1ae2c1796f4fb3359730723ce0acd2d162">G_TOUCHED1</link>);&#32;&#32;<emphasis role="comment">/*&#32;touched&#32;in&#32;current&#32;cycle&#32;*/</emphasis>
00241 }
00242 
00243 
<anchor xml:id="_lgc_8c_source_1l00244"/><link linkend="_lgc_8h_1a242d4a66c025c294ec2c1ec4fe75e804">00244</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a77a9b70a49730bb007a8a9492687d0eb">luaC_fix</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*o)&#32;{
00245 &#32;&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g&#32;=&#32;<link linkend="_lstate_8h_1a103db2de6edf3420c6c6c9a282562406">G</link>(L);
00246 &#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(g-&gt;<link linkend="_structglobal___state_1a3239e7c69845ec6df350dc5b6f1d5291">allgc</link>&#32;==&#32;o);&#32;&#32;<emphasis role="comment">/*&#32;object&#32;must&#32;be&#32;1st&#32;in&#32;&apos;allgc&apos;&#32;list!&#32;*/</emphasis>
00247 &#32;&#32;<link linkend="_lgc_8c_1ac0d91118389ea51c074e2baf41e03ccb">set2gray</link>(o);&#32;&#32;<emphasis role="comment">/*&#32;they&#32;will&#32;be&#32;gray&#32;forever&#32;*/</emphasis>
00248 &#32;&#32;<link linkend="_lgc_8h_1a42f07cc5f8f0a9d97989f7769f00c3f2">setage</link>(o,&#32;<link linkend="_lgc_8h_1a96372e9b92aa939f300e0477ba112716">G_OLD</link>);&#32;&#32;<emphasis role="comment">/*&#32;and&#32;old&#32;forever&#32;*/</emphasis>
00249 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1a3239e7c69845ec6df350dc5b6f1d5291">allgc</link>&#32;=&#32;o-&gt;next;&#32;&#32;<emphasis role="comment">/*&#32;remove&#32;object&#32;from&#32;&apos;allgc&apos;&#32;list&#32;*/</emphasis>
00250 &#32;&#32;o-&gt;next&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1aaae4d624f0c53c83a285c2dc30a26eb5">fixedgc</link>;&#32;&#32;<emphasis role="comment">/*&#32;link&#32;it&#32;to&#32;&apos;fixedgc&apos;&#32;list&#32;*/</emphasis>
00251 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1aaae4d624f0c53c83a285c2dc30a26eb5">fixedgc</link>&#32;=&#32;o;
00252 }
00253 
00254 
00255 <emphasis role="comment">/*</emphasis>
00256 <emphasis role="comment">**&#32;create&#32;a&#32;new&#32;collectable&#32;object&#32;(with&#32;given&#32;type&#32;and&#32;size)&#32;and&#32;link</emphasis>
00257 <emphasis role="comment">**&#32;it&#32;to&#32;&apos;allgc&apos;&#32;list.</emphasis>
00258 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00259"/><link linkend="_lgc_8h_1a08e480a0ddf25233346594d9bbd719e9">00259</link> <link linkend="_struct_g_c_object">GCObject</link>&#32;*<link linkend="_lgc_8c_1abfc8404c5fbd2a1770202fa0b087d451">luaC_newobj</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<emphasis role="keywordtype">int</emphasis>&#32;tt,&#32;<emphasis role="keywordtype">size_t</emphasis>&#32;sz)&#32;{
00260 &#32;&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g&#32;=&#32;<link linkend="_lstate_8h_1a103db2de6edf3420c6c6c9a282562406">G</link>(L);
00261 &#32;&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*o&#32;=&#32;<link linkend="_llimits_8h_1af17d62ec9e237a7644de6b9b34a48a34">cast</link>(<link linkend="_struct_g_c_object">GCObject</link>&#32;*,&#32;<link linkend="_lmem_8h_1a0ce640c4b032a327440e3820365d7167">luaM_newobject</link>(L,&#32;<link linkend="_lobject_8h_1a40d12e88a0d8249d226109e0d6d70dd6">novariant</link>(tt),&#32;sz));
00262 &#32;&#32;o-&gt;marked&#32;=&#32;<link linkend="_lgc_8h_1afaa8a52c4097cf3a5eacd88db94092da">luaC_white</link>(g);
00263 &#32;&#32;o-&gt;tt&#32;=&#32;tt;
00264 &#32;&#32;o-&gt;next&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a3239e7c69845ec6df350dc5b6f1d5291">allgc</link>;
00265 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1a3239e7c69845ec6df350dc5b6f1d5291">allgc</link>&#32;=&#32;o;
00266 &#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;o;
00267 }
00268 
00269 <emphasis role="comment">/*&#32;}======================================================&#32;*/</emphasis>
00270 
00271 
00272 
00273 <emphasis role="comment">/*</emphasis>
00274 <emphasis role="comment">**&#32;{======================================================</emphasis>
00275 <emphasis role="comment">**&#32;Mark&#32;functions</emphasis>
00276 <emphasis role="comment">**&#32;=======================================================</emphasis>
00277 <emphasis role="comment">*/</emphasis>
00278 
00279 
00280 <emphasis role="comment">/*</emphasis>
00281 <emphasis role="comment">**&#32;Mark&#32;an&#32;object.&#32;&#32;Userdata&#32;with&#32;no&#32;user&#32;values,&#32;strings,&#32;and&#32;closed</emphasis>
00282 <emphasis role="comment">**&#32;upvalues&#32;are&#32;visited&#32;and&#32;turned&#32;black&#32;here.&#32;&#32;Open&#32;upvalues&#32;are</emphasis>
00283 <emphasis role="comment">**&#32;already&#32;indirectly&#32;linked&#32;through&#32;their&#32;respective&#32;threads&#32;in&#32;the</emphasis>
00284 <emphasis role="comment">**&#32;&apos;twups&apos;&#32;list,&#32;so&#32;they&#32;don&apos;t&#32;go&#32;to&#32;the&#32;gray&#32;list;&#32;nevertheless,&#32;they</emphasis>
00285 <emphasis role="comment">**&#32;are&#32;kept&#32;gray&#32;to&#32;avoid&#32;barriers,&#32;as&#32;their&#32;values&#32;will&#32;be&#32;revisited</emphasis>
00286 <emphasis role="comment">**&#32;by&#32;the&#32;thread&#32;or&#32;by&#32;&apos;remarkupvals&apos;.&#32;&#32;Other&#32;objects&#32;are&#32;added&#32;to&#32;the</emphasis>
00287 <emphasis role="comment">**&#32;gray&#32;list&#32;to&#32;be&#32;visited&#32;(and&#32;turned&#32;black)&#32;later.&#32;&#32;Both&#32;userdata&#32;and</emphasis>
00288 <emphasis role="comment">**&#32;upvalues&#32;can&#32;call&#32;this&#32;function&#32;recursively,&#32;but&#32;this&#32;recursion&#32;goes</emphasis>
00289 <emphasis role="comment">**&#32;for&#32;at&#32;most&#32;two&#32;levels:&#32;An&#32;upvalue&#32;cannot&#32;refer&#32;to&#32;another&#32;upvalue</emphasis>
00290 <emphasis role="comment">**&#32;(only&#32;closures&#32;can),&#32;and&#32;a&#32;userdata&apos;s&#32;metatable&#32;must&#32;be&#32;a&#32;table.</emphasis>
00291 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00292"/><link linkend="_lgc_8c_1aacf3c8ee0eebd5d5b1cd09da000ad53c">00292</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1aacf3c8ee0eebd5d5b1cd09da000ad53c">reallymarkobject</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*o)&#32;{
00293 &#32;&#32;<emphasis role="keywordflow">switch</emphasis>&#32;(o-&gt;tt)&#32;{
00294 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1a794410ffd7267ef873eb05ac695b1ba6">LUA_VSHRSTR</link>:
00295 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1a6869fcb0a0178b6d70d431eae1683199">LUA_VLNGSTR</link>:&#32;{
00296 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a1cb0182cfa6e73b1665658a79c297d46">set2black</link>(o);&#32;&#32;<emphasis role="comment">/*&#32;nothing&#32;to&#32;visit&#32;*/</emphasis>
00297 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
00298 &#32;&#32;&#32;&#32;}
00299 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1ae982db94518ed52587579ed70d822ad5">LUA_VUPVAL</link>:&#32;{
00300 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_struct_up_val">UpVal</link>&#32;*uv&#32;=&#32;<link linkend="_lstate_8h_1a1633a3ec133e64956014aafd04e31cce">gco2upv</link>(o);
00301 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lfunc_8h_1a26a8ecd7d58d326f7f6f20bc8bc8bb55">upisopen</link>(uv))
00302 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ac0d91118389ea51c074e2baf41e03ccb">set2gray</link>(uv);&#32;&#32;<emphasis role="comment">/*&#32;open&#32;upvalues&#32;are&#32;kept&#32;gray&#32;*/</emphasis>
00303 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>
00304 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a1cb0182cfa6e73b1665658a79c297d46">set2black</link>(o);&#32;&#32;<emphasis role="comment">/*&#32;closed&#32;upvalues&#32;are&#32;visited&#32;here&#32;*/</emphasis>
00305 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a2dd4136ac29665568973c074bc450849">markvalue</link>(g,&#32;uv-&gt;<link linkend="_struct_up_val_1a507ba5be7778a879769a2718d6e4afa3">v</link>);&#32;&#32;<emphasis role="comment">/*&#32;mark&#32;its&#32;content&#32;*/</emphasis>
00306 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
00307 &#32;&#32;&#32;&#32;}
00308 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1af45b44d4031e7e869195dd97759d2ca3">LUA_VUSERDATA</link>:&#32;{
00309 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_struct_udata">Udata</link>&#32;*u&#32;=&#32;<link linkend="_lstate_8h_1a55e9a228ad0d3a82ee9cfc353002fd8a">gco2u</link>(o);
00310 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(u-&gt;<link linkend="_struct_udata_1a73b0125a5ce1394f28d43c93751a9db5">nuvalue</link>&#32;==&#32;0)&#32;{&#32;&#32;<emphasis role="comment">/*&#32;no&#32;user&#32;values?&#32;*/</emphasis>
00311 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1af9d4ee7e422989e2c45413745252211b">markobjectN</link>(g,&#32;u-&gt;<link linkend="_struct_udata_1a7051e0d573f6be65b230b27565a1a901">metatable</link>);&#32;&#32;<emphasis role="comment">/*&#32;mark&#32;its&#32;metatable&#32;*/</emphasis>
00312 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a1cb0182cfa6e73b1665658a79c297d46">set2black</link>(o);&#32;&#32;<emphasis role="comment">/*&#32;nothing&#32;else&#32;to&#32;mark&#32;*/</emphasis>
00313 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
00314 &#32;&#32;&#32;&#32;&#32;&#32;}
00315 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;else...&#32;*/</emphasis>
00316 &#32;&#32;&#32;&#32;}&#32;&#32;<emphasis role="comment">/*&#32;FALLTHROUGH&#32;*/</emphasis>
00317 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1a5d0e6e41ea93960667095501aa5745c1">LUA_VLCL</link>:&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1a2361d923ddb7fc1468b978fe043e35c2">LUA_VCCL</link>:&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1afaf24d5b79b9027ad768d023778669df">LUA_VTABLE</link>:
00318 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1ad224258ccc4e8f79f148d54d32ddbd00">LUA_VTHREAD</link>:&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1a1c6c32cba3e6d0c897f68ceb273dd757">LUA_VPROTO</link>:&#32;{
00319 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a69a219e9e1a524d24173ef477419f87c">linkobjgclist</link>(o,&#32;g-&gt;<link linkend="_structglobal___state_1a212d17a5d31cf9cd949ba66f16d63139">gray</link>);&#32;&#32;<emphasis role="comment">/*&#32;to&#32;be&#32;visited&#32;later&#32;*/</emphasis>
00320 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
00321 &#32;&#32;&#32;&#32;}
00322 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">default</emphasis>:&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(0);&#32;<emphasis role="keywordflow">break</emphasis>;
00323 &#32;&#32;}
00324 }
00325 
00326 
00327 <emphasis role="comment">/*</emphasis>
00328 <emphasis role="comment">**&#32;mark&#32;metamethods&#32;for&#32;basic&#32;types</emphasis>
00329 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00330"/><link linkend="_lgc_8c_1a9e8dd447c32dde7eeb9fc5da83df09b1">00330</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a9e8dd447c32dde7eeb9fc5da83df09b1">markmt</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g)&#32;{
00331 &#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;i;
00332 &#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(i=0;&#32;i&#32;&lt;&#32;<link linkend="_lua_8h_1abf59b4e3180540d3ee3b10da19d02ee7">LUA_NUMTAGS</link>;&#32;i++)
00333 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1af9d4ee7e422989e2c45413745252211b">markobjectN</link>(g,&#32;g-&gt;<link linkend="_structglobal___state_1a28ca6aa5035b863170e13cc0b76e99ee">mt</link>[i]);
00334 }
00335 
00336 
00337 <emphasis role="comment">/*</emphasis>
00338 <emphasis role="comment">**&#32;mark&#32;all&#32;objects&#32;in&#32;list&#32;of&#32;being-finalized</emphasis>
00339 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00340"/><link linkend="_lgc_8c_1afdc11f26c812a8356585e0e6a67b9982">00340</link> <emphasis role="keyword">static</emphasis>&#32;<link linkend="_llimits_8h_1aac8c50ca0aa51c80523376da77c2c4d8">lu_mem</link>&#32;<link linkend="_lgc_8c_1afdc11f26c812a8356585e0e6a67b9982">markbeingfnz</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g)&#32;{
00341 &#32;&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*o;
00342 &#32;&#32;<link linkend="_llimits_8h_1aac8c50ca0aa51c80523376da77c2c4d8">lu_mem</link>&#32;count&#32;=&#32;0;
00343 &#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(o&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a26a1a773fdf19f6aa0be08d5b8395c26">tobefnz</link>;&#32;o&#32;!=&#32;NULL;&#32;o&#32;=&#32;o-&gt;next)&#32;{
00344 &#32;&#32;&#32;&#32;count++;
00345 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a6ae72c43e48b29944e55933df7f15482">markobject</link>(g,&#32;o);
00346 &#32;&#32;}
00347 &#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;count;
00348 }
00349 
00350 
00351 <emphasis role="comment">/*</emphasis>
00352 <emphasis role="comment">**&#32;For&#32;each&#32;non-marked&#32;thread,&#32;simulates&#32;a&#32;barrier&#32;between&#32;each&#32;open</emphasis>
00353 <emphasis role="comment">**&#32;upvalue&#32;and&#32;its&#32;value.&#32;(If&#32;the&#32;thread&#32;is&#32;collected,&#32;the&#32;value&#32;will&#32;be</emphasis>
00354 <emphasis role="comment">**&#32;assigned&#32;to&#32;the&#32;upvalue,&#32;but&#32;then&#32;it&#32;can&#32;be&#32;too&#32;late&#32;for&#32;the&#32;barrier</emphasis>
00355 <emphasis role="comment">**&#32;to&#32;act.&#32;The&#32;&quot;barrier&quot;&#32;does&#32;not&#32;need&#32;to&#32;check&#32;colors:&#32;A&#32;non-marked</emphasis>
00356 <emphasis role="comment">**&#32;thread&#32;must&#32;be&#32;young;&#32;upvalues&#32;cannot&#32;be&#32;older&#32;than&#32;their&#32;threads;&#32;so</emphasis>
00357 <emphasis role="comment">**&#32;any&#32;visited&#32;upvalue&#32;must&#32;be&#32;young&#32;too.)&#32;Also&#32;removes&#32;the&#32;thread&#32;from</emphasis>
00358 <emphasis role="comment">**&#32;the&#32;list,&#32;as&#32;it&#32;was&#32;already&#32;visited.&#32;Removes&#32;also&#32;threads&#32;with&#32;no</emphasis>
00359 <emphasis role="comment">**&#32;upvalues,&#32;as&#32;they&#32;have&#32;nothing&#32;to&#32;be&#32;checked.&#32;(If&#32;the&#32;thread&#32;gets&#32;an</emphasis>
00360 <emphasis role="comment">**&#32;upvalue&#32;later,&#32;it&#32;will&#32;be&#32;linked&#32;in&#32;the&#32;list&#32;again.)</emphasis>
00361 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00362"/><link linkend="_lgc_8c_1a563e20dbbab2390ef4ac0ac254f59b71">00362</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_lgc_8c_1a563e20dbbab2390ef4ac0ac254f59b71">remarkupvals</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g)&#32;{
00363 &#32;&#32;<link linkend="_structlua___state">lua_State</link>&#32;*thread;
00364 &#32;&#32;<link linkend="_structlua___state">lua_State</link>&#32;**p&#32;=&#32;&amp;g-&gt;<link linkend="_structglobal___state_1a3c31ce83747be5e373872d7742afc3d1">twups</link>;
00365 &#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;work&#32;=&#32;0;&#32;&#32;<emphasis role="comment">/*&#32;estimate&#32;of&#32;how&#32;much&#32;work&#32;was&#32;done&#32;here&#32;*/</emphasis>
00366 &#32;&#32;<emphasis role="keywordflow">while</emphasis>&#32;((thread&#32;=&#32;*p)&#32;!=&#32;NULL)&#32;{
00367 &#32;&#32;&#32;&#32;work++;
00368 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(!<link linkend="_lgc_8h_1a4c0ce78d476460d2e54914301f4a4bf7">iswhite</link>(thread)&#32;&amp;&amp;&#32;thread-&gt;<link linkend="_structlua___state_1a762ab4537c3697fa94e74b3c0dffd297">openupval</link>&#32;!=&#32;NULL)
00369 &#32;&#32;&#32;&#32;&#32;&#32;p&#32;=&#32;&amp;thread-&gt;<link linkend="_structlua___state_1a3c31ce83747be5e373872d7742afc3d1">twups</link>;&#32;&#32;<emphasis role="comment">/*&#32;keep&#32;marked&#32;thread&#32;with&#32;upvalues&#32;in&#32;the&#32;list&#32;*/</emphasis>
00370 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;{&#32;&#32;<emphasis role="comment">/*&#32;thread&#32;is&#32;not&#32;marked&#32;or&#32;without&#32;upvalues&#32;*/</emphasis>
00371 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_struct_up_val">UpVal</link>&#32;*uv;
00372 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(!<link linkend="_lgc_8h_1a24d47e523ecf2d6e475a34913ce06b05">isold</link>(thread)&#32;||&#32;thread-&gt;<link linkend="_structlua___state_1a762ab4537c3697fa94e74b3c0dffd297">openupval</link>&#32;==&#32;NULL);
00373 &#32;&#32;&#32;&#32;&#32;&#32;*p&#32;=&#32;thread-&gt;<link linkend="_structlua___state_1a3c31ce83747be5e373872d7742afc3d1">twups</link>;&#32;&#32;<emphasis role="comment">/*&#32;remove&#32;thread&#32;from&#32;the&#32;list&#32;*/</emphasis>
00374 &#32;&#32;&#32;&#32;&#32;&#32;thread-&gt;<link linkend="_structlua___state_1a3c31ce83747be5e373872d7742afc3d1">twups</link>&#32;=&#32;thread;&#32;&#32;<emphasis role="comment">/*&#32;mark&#32;that&#32;it&#32;is&#32;out&#32;of&#32;list&#32;*/</emphasis>
00375 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(uv&#32;=&#32;thread-&gt;<link linkend="_structlua___state_1a762ab4537c3697fa94e74b3c0dffd297">openupval</link>;&#32;uv&#32;!=&#32;NULL;&#32;uv&#32;=&#32;uv-&gt;<link linkend="_struct_up_val_1ae88bb25a10ec80f8fa19750a76390923">u</link>.<link linkend="_struct_up_val_1a70efd6629df78085a967d85ee0a8e673">open</link>.next)&#32;{
00376 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(<link linkend="_lgc_8h_1ae68465c1574c4b45a05a6548ad934235">getage</link>(uv)&#32;&lt;=&#32;<link linkend="_lgc_8h_1ae68465c1574c4b45a05a6548ad934235">getage</link>(thread));
00377 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;work++;
00378 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(!<link linkend="_lgc_8h_1a4c0ce78d476460d2e54914301f4a4bf7">iswhite</link>(uv))&#32;{&#32;&#32;<emphasis role="comment">/*&#32;upvalue&#32;already&#32;visited?&#32;*/</emphasis>
00379 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(<link linkend="_lfunc_8h_1a26a8ecd7d58d326f7f6f20bc8bc8bb55">upisopen</link>(uv)&#32;&amp;&amp;&#32;<link linkend="_lgc_8h_1ad417e22072630b33cf74a3055b27d8d7">isgray</link>(uv));
00380 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a2dd4136ac29665568973c074bc450849">markvalue</link>(g,&#32;uv-&gt;<link linkend="_struct_up_val_1a507ba5be7778a879769a2718d6e4afa3">v</link>);&#32;&#32;<emphasis role="comment">/*&#32;mark&#32;its&#32;value&#32;*/</emphasis>
00381 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}
00382 &#32;&#32;&#32;&#32;&#32;&#32;}
00383 &#32;&#32;&#32;&#32;}
00384 &#32;&#32;}
00385 &#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;work;
00386 }
00387 
00388 
<anchor xml:id="_lgc_8c_source_1l00389"/><link linkend="_lgc_8c_1a1811355ed318887d7fd2fdbdc3767eea">00389</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a1811355ed318887d7fd2fdbdc3767eea">cleargraylists</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g)&#32;{
00390 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1a212d17a5d31cf9cd949ba66f16d63139">gray</link>&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1af6b3198325143bc0a9a529e9b14ff29a">grayagain</link>&#32;=&#32;NULL;
00391 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1a26d09b5385bf38c15ca56a9e44b5ef6d">weak</link>&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a97f9bda9b7e1f18bb0c68608e6609c89">allweak</link>&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1aac8b3202114d8c99a73328fff0c3c79c">ephemeron</link>&#32;=&#32;NULL;
00392 }
00393 
00394 
00395 <emphasis role="comment">/*</emphasis>
00396 <emphasis role="comment">**&#32;mark&#32;root&#32;set&#32;and&#32;reset&#32;all&#32;gray&#32;lists,&#32;to&#32;start&#32;a&#32;new&#32;collection</emphasis>
00397 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00398"/><link linkend="_lgc_8c_1abc346fb7129981227c874ba0e22a480f">00398</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1abc346fb7129981227c874ba0e22a480f">restartcollection</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g)&#32;{
00399 &#32;&#32;<link linkend="_lgc_8c_1a1811355ed318887d7fd2fdbdc3767eea">cleargraylists</link>(g);
00400 &#32;&#32;<link linkend="_lgc_8c_1a6ae72c43e48b29944e55933df7f15482">markobject</link>(g,&#32;g-&gt;<link linkend="_structglobal___state_1a90da27c9046a3da7fed43ef75957e379">mainthread</link>);
00401 &#32;&#32;<link linkend="_lgc_8c_1a2dd4136ac29665568973c074bc450849">markvalue</link>(g,&#32;&amp;g-&gt;<link linkend="_structglobal___state_1af2551dd930744b33fb4c2964076101fe">l_registry</link>);
00402 &#32;&#32;<link linkend="_lgc_8c_1a9e8dd447c32dde7eeb9fc5da83df09b1">markmt</link>(g);
00403 &#32;&#32;<link linkend="_lgc_8c_1afdc11f26c812a8356585e0e6a67b9982">markbeingfnz</link>(g);&#32;&#32;<emphasis role="comment">/*&#32;mark&#32;any&#32;finalizing&#32;object&#32;left&#32;from&#32;previous&#32;cycle&#32;*/</emphasis>
00404 }
00405 
00406 <emphasis role="comment">/*&#32;}======================================================&#32;*/</emphasis>
00407 
00408 
00409 <emphasis role="comment">/*</emphasis>
00410 <emphasis role="comment">**&#32;{======================================================</emphasis>
00411 <emphasis role="comment">**&#32;Traverse&#32;functions</emphasis>
00412 <emphasis role="comment">**&#32;=======================================================</emphasis>
00413 <emphasis role="comment">*/</emphasis>
00414 
00415 
00416 <emphasis role="comment">/*</emphasis>
00417 <emphasis role="comment">**&#32;Check&#32;whether&#32;object&#32;&apos;o&apos;&#32;should&#32;be&#32;kept&#32;in&#32;the&#32;&apos;grayagain&apos;&#32;list&#32;for</emphasis>
00418 <emphasis role="comment">**&#32;post-processing&#32;by&#32;&apos;correctgraylist&apos;.&#32;(It&#32;could&#32;put&#32;all&#32;old&#32;objects</emphasis>
00419 <emphasis role="comment">**&#32;in&#32;the&#32;list&#32;and&#32;leave&#32;all&#32;the&#32;work&#32;to&#32;&apos;correctgraylist&apos;,&#32;but&#32;it&#32;is</emphasis>
00420 <emphasis role="comment">**&#32;more&#32;efficient&#32;to&#32;avoid&#32;adding&#32;elements&#32;that&#32;will&#32;be&#32;removed.)&#32;Only</emphasis>
00421 <emphasis role="comment">**&#32;TOUCHED1&#32;objects&#32;need&#32;to&#32;be&#32;in&#32;the&#32;list.&#32;TOUCHED2&#32;doesn&apos;t&#32;need&#32;to&#32;go</emphasis>
00422 <emphasis role="comment">**&#32;back&#32;to&#32;a&#32;gray&#32;list,&#32;but&#32;then&#32;it&#32;must&#32;become&#32;OLD.&#32;(That&#32;is&#32;what</emphasis>
00423 <emphasis role="comment">**&#32;&apos;correctgraylist&apos;&#32;does&#32;when&#32;it&#32;finds&#32;a&#32;TOUCHED2&#32;object.)</emphasis>
00424 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00425"/><link linkend="_lgc_8c_1a59186fdb26bd492886fdc8c3ffd17232">00425</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a59186fdb26bd492886fdc8c3ffd17232">genlink</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*o)&#32;{
00426 &#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(<link linkend="_lgc_8h_1ac1e4847ad9a91e4cea36520dc9078365">isblack</link>(o));
00427 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8h_1ae68465c1574c4b45a05a6548ad934235">getage</link>(o)&#32;==&#32;<link linkend="_lgc_8h_1ae2c1796f4fb3359730723ce0acd2d162">G_TOUCHED1</link>)&#32;{&#32;&#32;<emphasis role="comment">/*&#32;touched&#32;in&#32;this&#32;cycle?&#32;*/</emphasis>
00428 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a69a219e9e1a524d24173ef477419f87c">linkobjgclist</link>(o,&#32;g-&gt;<link linkend="_structglobal___state_1af6b3198325143bc0a9a529e9b14ff29a">grayagain</link>);&#32;&#32;<emphasis role="comment">/*&#32;link&#32;it&#32;back&#32;in&#32;&apos;grayagain&apos;&#32;*/</emphasis>
00429 &#32;&#32;}&#32;&#32;<emphasis role="comment">/*&#32;everything&#32;else&#32;do&#32;not&#32;need&#32;to&#32;be&#32;linked&#32;back&#32;*/</emphasis>
00430 &#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8h_1ae68465c1574c4b45a05a6548ad934235">getage</link>(o)&#32;==&#32;<link linkend="_lgc_8h_1ac2b8a2255c79c9f43f88d1625767e1bf">G_TOUCHED2</link>)
00431 &#32;&#32;&#32;&#32;<link linkend="_lgc_8h_1a61d44df5c26bb4efcf4e19b500933bbb">changeage</link>(o,&#32;<link linkend="_lgc_8h_1ac2b8a2255c79c9f43f88d1625767e1bf">G_TOUCHED2</link>,&#32;<link linkend="_lgc_8h_1a96372e9b92aa939f300e0477ba112716">G_OLD</link>);&#32;&#32;<emphasis role="comment">/*&#32;advance&#32;age&#32;*/</emphasis>
00432 }
00433 
00434 
00435 <emphasis role="comment">/*</emphasis>
00436 <emphasis role="comment">**&#32;Traverse&#32;a&#32;table&#32;with&#32;weak&#32;values&#32;and&#32;link&#32;it&#32;to&#32;proper&#32;list.&#32;During</emphasis>
00437 <emphasis role="comment">**&#32;propagate&#32;phase,&#32;keep&#32;it&#32;in&#32;&apos;grayagain&apos;&#32;list,&#32;to&#32;be&#32;revisited&#32;in&#32;the</emphasis>
00438 <emphasis role="comment">**&#32;atomic&#32;phase.&#32;In&#32;the&#32;atomic&#32;phase,&#32;if&#32;table&#32;has&#32;any&#32;white&#32;value,</emphasis>
00439 <emphasis role="comment">**&#32;put&#32;it&#32;in&#32;&apos;weak&apos;&#32;list,&#32;to&#32;be&#32;cleared.</emphasis>
00440 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00441"/><link linkend="_lgc_8c_1ae8dc436daacca264cf45cb9652c68430">00441</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1ae8dc436daacca264cf45cb9652c68430">traverseweakvalue</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g,&#32;<link linkend="_struct_table">Table</link>&#32;*h)&#32;{
00442 &#32;&#32;<link linkend="_union_node">Node</link>&#32;*n,&#32;*limit&#32;=&#32;<link linkend="_lgc_8c_1a43ef7b8388b613e737dd3ec7eb493f47">gnodelast</link>(h);
00443 &#32;&#32;<emphasis role="comment">/*&#32;if&#32;there&#32;is&#32;array&#32;part,&#32;assume&#32;it&#32;may&#32;have&#32;white&#32;values&#32;(it&#32;is&#32;not</emphasis>
00444 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;worth&#32;traversing&#32;it&#32;now&#32;just&#32;to&#32;check)&#32;*/</emphasis>
00445 &#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;hasclears&#32;=&#32;(h-&gt;<link linkend="_struct_table_1aeb72dd9354afd8407f0325f034747110">alimit</link>&#32;&gt;&#32;0);
00446 &#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(n&#32;=&#32;<link linkend="_ltable_8h_1a644cfa3b6d4be1782e818a8340b5f78b">gnode</link>(h,&#32;0);&#32;n&#32;&lt;&#32;limit;&#32;n++)&#32;{&#32;&#32;<emphasis role="comment">/*&#32;traverse&#32;hash&#32;part&#32;*/</emphasis>
00447 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lobject_8h_1a5345ae49ed16dfecdfef95ec5399b000">isempty</link>(<link linkend="_ltable_8h_1acbbecd9bd8fbb72a17f6e2f5acf7113d">gval</link>(n)))&#32;&#32;<emphasis role="comment">/*&#32;entry&#32;is&#32;empty?&#32;*/</emphasis>
00448 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ae5b5bd4c69910951078ac627fa1654da">clearkey</link>(n);&#32;&#32;<emphasis role="comment">/*&#32;clear&#32;its&#32;key&#32;*/</emphasis>
00449 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;{
00450 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(!<link linkend="_lobject_8h_1a64e2e5b8ce53a1dc7a528b13947d7ff3">keyisnil</link>(n));
00451 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a177a5a645b1409b4f1c20e3c84018d40">markkey</link>(g,&#32;n);
00452 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(!hasclears&#32;&amp;&amp;&#32;<link linkend="_lgc_8c_1acae02b6cdb8288e654682baf4117e8ab">iscleared</link>(g,&#32;<link linkend="_lgc_8c_1a7c7f051ea3f0945577e90c480ebeee88">gcvalueN</link>(<link linkend="_ltable_8h_1acbbecd9bd8fbb72a17f6e2f5acf7113d">gval</link>(n))))&#32;&#32;<emphasis role="comment">/*&#32;a&#32;white&#32;value?&#32;*/</emphasis>
00453 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;hasclears&#32;=&#32;1;&#32;&#32;<emphasis role="comment">/*&#32;table&#32;will&#32;have&#32;to&#32;be&#32;cleared&#32;*/</emphasis>
00454 &#32;&#32;&#32;&#32;}
00455 &#32;&#32;}
00456 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(g-&gt;<link linkend="_structglobal___state_1aec22885c483e649f2d65368c3507cd9a">gcstate</link>&#32;==&#32;<link linkend="_lgc_8h_1a7c7806ab609fa3c19ed9c2b688e10730">GCSatomic</link>&#32;&amp;&amp;&#32;hasclears)
00457 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ad63f9d59a67a756d3c3540d9795cdcbe">linkgclist</link>(h,&#32;g-&gt;<link linkend="_structglobal___state_1a26d09b5385bf38c15ca56a9e44b5ef6d">weak</link>);&#32;&#32;<emphasis role="comment">/*&#32;has&#32;to&#32;be&#32;cleared&#32;later&#32;*/</emphasis>
00458 &#32;&#32;<emphasis role="keywordflow">else</emphasis>
00459 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ad63f9d59a67a756d3c3540d9795cdcbe">linkgclist</link>(h,&#32;g-&gt;<link linkend="_structglobal___state_1af6b3198325143bc0a9a529e9b14ff29a">grayagain</link>);&#32;&#32;<emphasis role="comment">/*&#32;must&#32;retraverse&#32;it&#32;in&#32;atomic&#32;phase&#32;*/</emphasis>
00460 }
00461 
00462 
00463 <emphasis role="comment">/*</emphasis>
00464 <emphasis role="comment">**&#32;Traverse&#32;an&#32;ephemeron&#32;table&#32;and&#32;link&#32;it&#32;to&#32;proper&#32;list.&#32;Returns&#32;true</emphasis>
00465 <emphasis role="comment">**&#32;iff&#32;any&#32;object&#32;was&#32;marked&#32;during&#32;this&#32;traversal&#32;(which&#32;implies&#32;that</emphasis>
00466 <emphasis role="comment">**&#32;convergence&#32;has&#32;to&#32;continue).&#32;During&#32;propagation&#32;phase,&#32;keep&#32;table</emphasis>
00467 <emphasis role="comment">**&#32;in&#32;&apos;grayagain&apos;&#32;list,&#32;to&#32;be&#32;visited&#32;again&#32;in&#32;the&#32;atomic&#32;phase.&#32;In</emphasis>
00468 <emphasis role="comment">**&#32;the&#32;atomic&#32;phase,&#32;if&#32;table&#32;has&#32;any&#32;white-&gt;white&#32;entry,&#32;it&#32;has&#32;to</emphasis>
00469 <emphasis role="comment">**&#32;be&#32;revisited&#32;during&#32;ephemeron&#32;convergence&#32;(as&#32;that&#32;key&#32;may&#32;turn</emphasis>
00470 <emphasis role="comment">**&#32;black).&#32;Otherwise,&#32;if&#32;it&#32;has&#32;any&#32;white&#32;key,&#32;table&#32;has&#32;to&#32;be&#32;cleared</emphasis>
00471 <emphasis role="comment">**&#32;(in&#32;the&#32;atomic&#32;phase).&#32;In&#32;generational&#32;mode,&#32;some&#32;tables</emphasis>
00472 <emphasis role="comment">**&#32;must&#32;be&#32;kept&#32;in&#32;some&#32;gray&#32;list&#32;for&#32;post-processing;&#32;this&#32;is&#32;done</emphasis>
00473 <emphasis role="comment">**&#32;by&#32;&apos;genlink&apos;.</emphasis>
00474 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00475"/><link linkend="_lgc_8c_1aad4294f43d919ea5950d992599d1a445">00475</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_lgc_8c_1aad4294f43d919ea5950d992599d1a445">traverseephemeron</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g,&#32;<link linkend="_struct_table">Table</link>&#32;*h,&#32;<emphasis role="keywordtype">int</emphasis>&#32;inv)&#32;{
00476 &#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;marked&#32;=&#32;0;&#32;&#32;<emphasis role="comment">/*&#32;true&#32;if&#32;an&#32;object&#32;is&#32;marked&#32;in&#32;this&#32;traversal&#32;*/</emphasis>
00477 &#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;hasclears&#32;=&#32;0;&#32;&#32;<emphasis role="comment">/*&#32;true&#32;if&#32;table&#32;has&#32;white&#32;keys&#32;*/</emphasis>
00478 &#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;hasww&#32;=&#32;0;&#32;&#32;<emphasis role="comment">/*&#32;true&#32;if&#32;table&#32;has&#32;entry&#32;&quot;white-key&#32;-&gt;&#32;white-value&quot;&#32;*/</emphasis>
00479 &#32;&#32;<emphasis role="keywordtype">unsigned</emphasis>&#32;<emphasis role="keywordtype">int</emphasis>&#32;i;
00480 &#32;&#32;<emphasis role="keywordtype">unsigned</emphasis>&#32;<emphasis role="keywordtype">int</emphasis>&#32;asize&#32;=&#32;<link linkend="_ltable_8c_1a8f20a204b7a78780847939086b847781">luaH_realasize</link>(h);
00481 &#32;&#32;<emphasis role="keywordtype">unsigned</emphasis>&#32;<emphasis role="keywordtype">int</emphasis>&#32;nsize&#32;=&#32;<link linkend="_lobject_8h_1a2fbf715e78eaa889ed0fb9d4514e736a">sizenode</link>(h);
00482 &#32;&#32;<emphasis role="comment">/*&#32;traverse&#32;array&#32;part&#32;*/</emphasis>
00483 &#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(i&#32;=&#32;0;&#32;i&#32;&lt;&#32;asize;&#32;i++)&#32;{
00484 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8c_1a84251731518ce7f66d49363eb9f0f594">valiswhite</link>(&amp;h-&gt;<link linkend="_struct_table_1a6ce25078468c6681674e2f56432a27b9">array</link>[i]))&#32;{
00485 &#32;&#32;&#32;&#32;&#32;&#32;marked&#32;=&#32;1;
00486 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1aacf3c8ee0eebd5d5b1cd09da000ad53c">reallymarkobject</link>(g,&#32;<link linkend="_lobject_8h_1a05cdf6070135f10ad37e1048a730b634">gcvalue</link>(&amp;h-&gt;<link linkend="_struct_table_1a6ce25078468c6681674e2f56432a27b9">array</link>[i]));
00487 &#32;&#32;&#32;&#32;}
00488 &#32;&#32;}
00489 &#32;&#32;<emphasis role="comment">/*&#32;traverse&#32;hash&#32;part;&#32;if&#32;&apos;inv&apos;,&#32;traverse&#32;descending</emphasis>
00490 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;(see&#32;&apos;convergeephemerons&apos;)&#32;*/</emphasis>
00491 &#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(i&#32;=&#32;0;&#32;i&#32;&lt;&#32;nsize;&#32;i++)&#32;{
00492 &#32;&#32;&#32;&#32;<link linkend="_union_node">Node</link>&#32;*n&#32;=&#32;inv&#32;?&#32;<link linkend="_ltable_8h_1a644cfa3b6d4be1782e818a8340b5f78b">gnode</link>(h,&#32;nsize&#32;-&#32;1&#32;-&#32;i)&#32;:&#32;<link linkend="_ltable_8h_1a644cfa3b6d4be1782e818a8340b5f78b">gnode</link>(h,&#32;i);
00493 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lobject_8h_1a5345ae49ed16dfecdfef95ec5399b000">isempty</link>(<link linkend="_ltable_8h_1acbbecd9bd8fbb72a17f6e2f5acf7113d">gval</link>(n)))&#32;&#32;<emphasis role="comment">/*&#32;entry&#32;is&#32;empty?&#32;*/</emphasis>
00494 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ae5b5bd4c69910951078ac627fa1654da">clearkey</link>(n);&#32;&#32;<emphasis role="comment">/*&#32;clear&#32;its&#32;key&#32;*/</emphasis>
00495 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8c_1acae02b6cdb8288e654682baf4117e8ab">iscleared</link>(g,&#32;<link linkend="_lobject_8h_1a228a192019c3bf44b6027d8f4a38c904">gckeyN</link>(n)))&#32;{&#32;&#32;<emphasis role="comment">/*&#32;key&#32;is&#32;not&#32;marked&#32;(yet)?&#32;*/</emphasis>
00496 &#32;&#32;&#32;&#32;&#32;&#32;hasclears&#32;=&#32;1;&#32;&#32;<emphasis role="comment">/*&#32;table&#32;must&#32;be&#32;cleared&#32;*/</emphasis>
00497 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8c_1a84251731518ce7f66d49363eb9f0f594">valiswhite</link>(<link linkend="_ltable_8h_1acbbecd9bd8fbb72a17f6e2f5acf7113d">gval</link>(n)))&#32;&#32;<emphasis role="comment">/*&#32;value&#32;not&#32;marked&#32;yet?&#32;*/</emphasis>
00498 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;hasww&#32;=&#32;1;&#32;&#32;<emphasis role="comment">/*&#32;white-white&#32;entry&#32;*/</emphasis>
00499 &#32;&#32;&#32;&#32;}
00500 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8c_1a84251731518ce7f66d49363eb9f0f594">valiswhite</link>(<link linkend="_ltable_8h_1acbbecd9bd8fbb72a17f6e2f5acf7113d">gval</link>(n)))&#32;{&#32;&#32;<emphasis role="comment">/*&#32;value&#32;not&#32;marked&#32;yet?&#32;*/</emphasis>
00501 &#32;&#32;&#32;&#32;&#32;&#32;marked&#32;=&#32;1;
00502 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1aacf3c8ee0eebd5d5b1cd09da000ad53c">reallymarkobject</link>(g,&#32;<link linkend="_lobject_8h_1a05cdf6070135f10ad37e1048a730b634">gcvalue</link>(<link linkend="_ltable_8h_1acbbecd9bd8fbb72a17f6e2f5acf7113d">gval</link>(n)));&#32;&#32;<emphasis role="comment">/*&#32;mark&#32;it&#32;now&#32;*/</emphasis>
00503 &#32;&#32;&#32;&#32;}
00504 &#32;&#32;}
00505 &#32;&#32;<emphasis role="comment">/*&#32;link&#32;table&#32;into&#32;proper&#32;list&#32;*/</emphasis>
00506 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(g-&gt;<link linkend="_structglobal___state_1aec22885c483e649f2d65368c3507cd9a">gcstate</link>&#32;==&#32;<link linkend="_lgc_8h_1a2ed301793747f3a2d0a7fc7d64d482fd">GCSpropagate</link>)
00507 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ad63f9d59a67a756d3c3540d9795cdcbe">linkgclist</link>(h,&#32;g-&gt;<link linkend="_structglobal___state_1af6b3198325143bc0a9a529e9b14ff29a">grayagain</link>);&#32;&#32;<emphasis role="comment">/*&#32;must&#32;retraverse&#32;it&#32;in&#32;atomic&#32;phase&#32;*/</emphasis>
00508 &#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;<emphasis role="keywordflow">if</emphasis>&#32;(hasww)&#32;&#32;<emphasis role="comment">/*&#32;table&#32;has&#32;white-&gt;white&#32;entries?&#32;*/</emphasis>
00509 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ad63f9d59a67a756d3c3540d9795cdcbe">linkgclist</link>(h,&#32;g-&gt;<link linkend="_structglobal___state_1aac8b3202114d8c99a73328fff0c3c79c">ephemeron</link>);&#32;&#32;<emphasis role="comment">/*&#32;have&#32;to&#32;propagate&#32;again&#32;*/</emphasis>
00510 &#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;<emphasis role="keywordflow">if</emphasis>&#32;(hasclears)&#32;&#32;<emphasis role="comment">/*&#32;table&#32;has&#32;white&#32;keys?&#32;*/</emphasis>
00511 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ad63f9d59a67a756d3c3540d9795cdcbe">linkgclist</link>(h,&#32;g-&gt;<link linkend="_structglobal___state_1a97f9bda9b7e1f18bb0c68608e6609c89">allweak</link>);&#32;&#32;<emphasis role="comment">/*&#32;may&#32;have&#32;to&#32;clean&#32;white&#32;keys&#32;*/</emphasis>
00512 &#32;&#32;<emphasis role="keywordflow">else</emphasis>
00513 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a59186fdb26bd492886fdc8c3ffd17232">genlink</link>(g,&#32;<link linkend="_lstate_8h_1a254ca29aba03e47440082d4591a9734e">obj2gco</link>(h));&#32;&#32;<emphasis role="comment">/*&#32;check&#32;whether&#32;collector&#32;still&#32;needs&#32;to&#32;see&#32;it&#32;*/</emphasis>
00514 &#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;marked;
00515 }
00516 
00517 
<anchor xml:id="_lgc_8c_source_1l00518"/><link linkend="_lgc_8c_1a3c018ffdc54c29a2ff8f44d32703a7c6">00518</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a3c018ffdc54c29a2ff8f44d32703a7c6">traversestrongtable</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g,&#32;<link linkend="_struct_table">Table</link>&#32;*h)&#32;{
00519 &#32;&#32;<link linkend="_union_node">Node</link>&#32;*n,&#32;*limit&#32;=&#32;<link linkend="_lgc_8c_1a43ef7b8388b613e737dd3ec7eb493f47">gnodelast</link>(h);
00520 &#32;&#32;<emphasis role="keywordtype">unsigned</emphasis>&#32;<emphasis role="keywordtype">int</emphasis>&#32;i;
00521 &#32;&#32;<emphasis role="keywordtype">unsigned</emphasis>&#32;<emphasis role="keywordtype">int</emphasis>&#32;asize&#32;=&#32;<link linkend="_ltable_8c_1a8f20a204b7a78780847939086b847781">luaH_realasize</link>(h);
00522 &#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(i&#32;=&#32;0;&#32;i&#32;&lt;&#32;asize;&#32;i++)&#32;&#32;<emphasis role="comment">/*&#32;traverse&#32;array&#32;part&#32;*/</emphasis>
00523 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a2dd4136ac29665568973c074bc450849">markvalue</link>(g,&#32;&amp;h-&gt;<link linkend="_struct_table_1a6ce25078468c6681674e2f56432a27b9">array</link>[i]);
00524 &#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(n&#32;=&#32;<link linkend="_ltable_8h_1a644cfa3b6d4be1782e818a8340b5f78b">gnode</link>(h,&#32;0);&#32;n&#32;&lt;&#32;limit;&#32;n++)&#32;{&#32;&#32;<emphasis role="comment">/*&#32;traverse&#32;hash&#32;part&#32;*/</emphasis>
00525 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lobject_8h_1a5345ae49ed16dfecdfef95ec5399b000">isempty</link>(<link linkend="_ltable_8h_1acbbecd9bd8fbb72a17f6e2f5acf7113d">gval</link>(n)))&#32;&#32;<emphasis role="comment">/*&#32;entry&#32;is&#32;empty?&#32;*/</emphasis>
00526 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ae5b5bd4c69910951078ac627fa1654da">clearkey</link>(n);&#32;&#32;<emphasis role="comment">/*&#32;clear&#32;its&#32;key&#32;*/</emphasis>
00527 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;{
00528 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(!<link linkend="_lobject_8h_1a64e2e5b8ce53a1dc7a528b13947d7ff3">keyisnil</link>(n));
00529 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a177a5a645b1409b4f1c20e3c84018d40">markkey</link>(g,&#32;n);
00530 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a2dd4136ac29665568973c074bc450849">markvalue</link>(g,&#32;<link linkend="_ltable_8h_1acbbecd9bd8fbb72a17f6e2f5acf7113d">gval</link>(n));
00531 &#32;&#32;&#32;&#32;}
00532 &#32;&#32;}
00533 &#32;&#32;<link linkend="_lgc_8c_1a59186fdb26bd492886fdc8c3ffd17232">genlink</link>(g,&#32;<link linkend="_lstate_8h_1a254ca29aba03e47440082d4591a9734e">obj2gco</link>(h));
00534 }
00535 
00536 
<anchor xml:id="_lgc_8c_source_1l00537"/><link linkend="_lgc_8c_1a86c4c1008df3c908a9cca3cf72abc195">00537</link> <emphasis role="keyword">static</emphasis>&#32;<link linkend="_llimits_8h_1aac8c50ca0aa51c80523376da77c2c4d8">lu_mem</link>&#32;<link linkend="_lgc_8c_1a86c4c1008df3c908a9cca3cf72abc195">traversetable</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g,&#32;<link linkend="_struct_table">Table</link>&#32;*h)&#32;{
00538 &#32;&#32;<emphasis role="keyword">const</emphasis>&#32;<emphasis role="keywordtype">char</emphasis>&#32;*weakkey,&#32;*weakvalue;
00539 &#32;&#32;<emphasis role="keyword">const</emphasis>&#32;<link linkend="_struct_t_value">TValue</link>&#32;*mode&#32;=&#32;<link linkend="_ltm_8h_1ab067446141992fa1bfa2f1ca720197fc">gfasttm</link>(g,&#32;h-&gt;<link linkend="_struct_table_1a7051e0d573f6be65b230b27565a1a901">metatable</link>,&#32;<link linkend="_ltm_8h_1a69e345ae253d250b61a03f1d6871c8d1a5cd07c76b9aff7450d8052363ff2db4e">TM_MODE</link>);
00540 &#32;&#32;<link linkend="_lgc_8c_1af9d4ee7e422989e2c45413745252211b">markobjectN</link>(g,&#32;h-&gt;<link linkend="_struct_table_1a7051e0d573f6be65b230b27565a1a901">metatable</link>);
00541 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(mode&#32;&amp;&amp;&#32;<link linkend="_lobject_8h_1a9bdf057a0de8da2ffae3ac35662dd255">ttisstring</link>(mode)&#32;&amp;&amp;&#32;&#32;<emphasis role="comment">/*&#32;is&#32;there&#32;a&#32;weak&#32;mode?&#32;*/</emphasis>
00542 &#32;&#32;&#32;&#32;&#32;&#32;(<link linkend="_llimits_8h_1a52a5166d7dc0590b63a9331cfc0f4564">cast_void</link>(weakkey&#32;=&#32;strchr(<link linkend="_lobject_8h_1ac2c9eedf3ff2c3042445b3b534f161e1">svalue</link>(mode),&#32;<emphasis role="charliteral">&apos;k&apos;</emphasis>)),
00543 &#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_llimits_8h_1a52a5166d7dc0590b63a9331cfc0f4564">cast_void</link>(weakvalue&#32;=&#32;strchr(<link linkend="_lobject_8h_1ac2c9eedf3ff2c3042445b3b534f161e1">svalue</link>(mode),&#32;<emphasis role="charliteral">&apos;v&apos;</emphasis>)),
00544 &#32;&#32;&#32;&#32;&#32;&#32;&#32;(weakkey&#32;||&#32;weakvalue)))&#32;{&#32;&#32;<emphasis role="comment">/*&#32;is&#32;really&#32;weak?&#32;*/</emphasis>
00545 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(!weakkey)&#32;&#32;<emphasis role="comment">/*&#32;strong&#32;keys?&#32;*/</emphasis>
00546 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ae8dc436daacca264cf45cb9652c68430">traverseweakvalue</link>(g,&#32;h);
00547 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;<emphasis role="keywordflow">if</emphasis>&#32;(!weakvalue)&#32;&#32;<emphasis role="comment">/*&#32;strong&#32;values?&#32;*/</emphasis>
00548 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1aad4294f43d919ea5950d992599d1a445">traverseephemeron</link>(g,&#32;h,&#32;0);
00549 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;&#32;<emphasis role="comment">/*&#32;all&#32;weak&#32;*/</emphasis>
00550 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ad63f9d59a67a756d3c3540d9795cdcbe">linkgclist</link>(h,&#32;g-&gt;<link linkend="_structglobal___state_1a97f9bda9b7e1f18bb0c68608e6609c89">allweak</link>);&#32;&#32;<emphasis role="comment">/*&#32;nothing&#32;to&#32;traverse&#32;now&#32;*/</emphasis>
00551 &#32;&#32;}
00552 &#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;&#32;<emphasis role="comment">/*&#32;not&#32;weak&#32;*/</emphasis>
00553 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a3c018ffdc54c29a2ff8f44d32703a7c6">traversestrongtable</link>(g,&#32;h);
00554 &#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;1&#32;+&#32;h-&gt;<link linkend="_struct_table_1aeb72dd9354afd8407f0325f034747110">alimit</link>&#32;+&#32;2&#32;*&#32;<link linkend="_ltable_8h_1af3ab680af234ee7ea0f7e6078b4b73bf">allocsizenode</link>(h);
00555 }
00556 
00557 
<anchor xml:id="_lgc_8c_source_1l00558"/><link linkend="_lgc_8c_1a7a5280b620352ed9282f78028779c968">00558</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_lgc_8c_1a7a5280b620352ed9282f78028779c968">traverseudata</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g,&#32;<link linkend="_struct_udata">Udata</link>&#32;*u)&#32;{
00559 &#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;i;
00560 &#32;&#32;<link linkend="_lgc_8c_1af9d4ee7e422989e2c45413745252211b">markobjectN</link>(g,&#32;u-&gt;<link linkend="_struct_udata_1a7051e0d573f6be65b230b27565a1a901">metatable</link>);&#32;&#32;<emphasis role="comment">/*&#32;mark&#32;its&#32;metatable&#32;*/</emphasis>
00561 &#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(i&#32;=&#32;0;&#32;i&#32;&lt;&#32;u-&gt;<link linkend="_struct_udata_1a73b0125a5ce1394f28d43c93751a9db5">nuvalue</link>;&#32;i++)
00562 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a2dd4136ac29665568973c074bc450849">markvalue</link>(g,&#32;&amp;u-&gt;<link linkend="_struct_udata_1a751e2c4ac119ed2ef754f3d01ecae2b9">uv</link>[i].<link linkend="_union_u_value_1aef7fd1c15e5ef9ae255e21967603fd34">uv</link>);
00563 &#32;&#32;<link linkend="_lgc_8c_1a59186fdb26bd492886fdc8c3ffd17232">genlink</link>(g,&#32;<link linkend="_lstate_8h_1a254ca29aba03e47440082d4591a9734e">obj2gco</link>(u));
00564 &#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;1&#32;+&#32;u-&gt;<link linkend="_struct_udata_1a73b0125a5ce1394f28d43c93751a9db5">nuvalue</link>;
00565 }
00566 
00567 
00568 <emphasis role="comment">/*</emphasis>
00569 <emphasis role="comment">**&#32;Traverse&#32;a&#32;prototype.&#32;(While&#32;a&#32;prototype&#32;is&#32;being&#32;build,&#32;its</emphasis>
00570 <emphasis role="comment">**&#32;arrays&#32;can&#32;be&#32;larger&#32;than&#32;needed;&#32;the&#32;extra&#32;slots&#32;are&#32;filled&#32;with</emphasis>
00571 <emphasis role="comment">**&#32;NULL,&#32;so&#32;the&#32;use&#32;of&#32;&apos;markobjectN&apos;)</emphasis>
00572 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00573"/><link linkend="_lgc_8c_1a19be424be90fc7025deae5ccfdcab62b">00573</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_lgc_8c_1a19be424be90fc7025deae5ccfdcab62b">traverseproto</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g,&#32;<link linkend="_struct_proto">Proto</link>&#32;*f)&#32;{
00574 &#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;i;
00575 &#32;&#32;<link linkend="_lgc_8c_1af9d4ee7e422989e2c45413745252211b">markobjectN</link>(g,&#32;f-&gt;<link linkend="_struct_proto_1a47b5f25d6c53f3892e43702659c6de69">source</link>);
00576 &#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(i&#32;=&#32;0;&#32;i&#32;&lt;&#32;f-&gt;<link linkend="_struct_proto_1a207b8b69ed4d393dd3c20925febd29e4">sizek</link>;&#32;i++)&#32;&#32;<emphasis role="comment">/*&#32;mark&#32;literals&#32;*/</emphasis>
00577 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a2dd4136ac29665568973c074bc450849">markvalue</link>(g,&#32;&amp;f-&gt;<link linkend="_struct_proto_1a5287370e219b50fe677549b4aafdc81d">k</link>[i]);
00578 &#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(i&#32;=&#32;0;&#32;i&#32;&lt;&#32;f-&gt;<link linkend="_struct_proto_1a2e13a98343ef0d1233bb3e62ae519c5f">sizeupvalues</link>;&#32;i++)&#32;&#32;<emphasis role="comment">/*&#32;mark&#32;upvalue&#32;names&#32;*/</emphasis>
00579 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1af9d4ee7e422989e2c45413745252211b">markobjectN</link>(g,&#32;f-&gt;<link linkend="_struct_proto_1ac3b891662880254a7e0a3dc0afa86254">upvalues</link>[i].<link linkend="_struct_upvaldesc_1aa249fce0e5297641aa43f45e48bb1548">name</link>);
00580 &#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(i&#32;=&#32;0;&#32;i&#32;&lt;&#32;f-&gt;<link linkend="_struct_proto_1aea0f5dcb02517aa08aa2ffa58c396260">sizep</link>;&#32;i++)&#32;&#32;<emphasis role="comment">/*&#32;mark&#32;nested&#32;protos&#32;*/</emphasis>
00581 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1af9d4ee7e422989e2c45413745252211b">markobjectN</link>(g,&#32;f-&gt;<link linkend="_struct_proto_1ab7af98f98f5cf674f6be5e3fc855af43">p</link>[i]);
00582 &#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(i&#32;=&#32;0;&#32;i&#32;&lt;&#32;f-&gt;<link linkend="_struct_proto_1af9147ae18b522811714aeb19036f639d">sizelocvars</link>;&#32;i++)&#32;&#32;<emphasis role="comment">/*&#32;mark&#32;local-variable&#32;names&#32;*/</emphasis>
00583 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1af9d4ee7e422989e2c45413745252211b">markobjectN</link>(g,&#32;f-&gt;<link linkend="_struct_proto_1a7a727780b57a02cd42e7ef902f6e7f90">locvars</link>[i].<link linkend="_struct_loc_var_1ac2450e0899ac889b040f20956221cd83">varname</link>);
00584 &#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;1&#32;+&#32;f-&gt;<link linkend="_struct_proto_1a207b8b69ed4d393dd3c20925febd29e4">sizek</link>&#32;+&#32;f-&gt;<link linkend="_struct_proto_1a2e13a98343ef0d1233bb3e62ae519c5f">sizeupvalues</link>&#32;+&#32;f-&gt;<link linkend="_struct_proto_1aea0f5dcb02517aa08aa2ffa58c396260">sizep</link>&#32;+&#32;f-&gt;<link linkend="_struct_proto_1af9147ae18b522811714aeb19036f639d">sizelocvars</link>;
00585 }
00586 
00587 
<anchor xml:id="_lgc_8c_source_1l00588"/><link linkend="_lgc_8c_1aa85f9809abfe94fcd3bbec6e2c46b104">00588</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_lgc_8c_1aa85f9809abfe94fcd3bbec6e2c46b104">traverseCclosure</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g,&#32;<link linkend="_struct_c_closure">CClosure</link>&#32;*cl)&#32;{
00589 &#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;i;
00590 &#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(i&#32;=&#32;0;&#32;i&#32;&lt;&#32;cl-&gt;nupvalues;&#32;i++)&#32;&#32;<emphasis role="comment">/*&#32;mark&#32;its&#32;upvalues&#32;*/</emphasis>
00591 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a2dd4136ac29665568973c074bc450849">markvalue</link>(g,&#32;&amp;cl-&gt;<link linkend="_struct_c_closure_1a5d6ca5386d338c19af338be60a375dd4">upvalue</link>[i]);
00592 &#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;1&#32;+&#32;cl-&gt;nupvalues;
00593 }
00594 
00595 <emphasis role="comment">/*</emphasis>
00596 <emphasis role="comment">**&#32;Traverse&#32;a&#32;Lua&#32;closure,&#32;marking&#32;its&#32;prototype&#32;and&#32;its&#32;upvalues.</emphasis>
00597 <emphasis role="comment">**&#32;(Both&#32;can&#32;be&#32;NULL&#32;while&#32;closure&#32;is&#32;being&#32;created.)</emphasis>
00598 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00599"/><link linkend="_lgc_8c_1a61e584daad5b6a41777ade0e72e559b3">00599</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_lgc_8c_1a61e584daad5b6a41777ade0e72e559b3">traverseLclosure</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g,&#32;<link linkend="_struct_l_closure">LClosure</link>&#32;*cl)&#32;{
00600 &#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;i;
00601 &#32;&#32;<link linkend="_lgc_8c_1af9d4ee7e422989e2c45413745252211b">markobjectN</link>(g,&#32;cl-&gt;<link linkend="_struct_l_closure_1aed1f50b9bdc5ce4c7cfa49529472b42c">p</link>);&#32;&#32;<emphasis role="comment">/*&#32;mark&#32;its&#32;prototype&#32;*/</emphasis>
00602 &#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(i&#32;=&#32;0;&#32;i&#32;&lt;&#32;cl-&gt;nupvalues;&#32;i++)&#32;{&#32;&#32;<emphasis role="comment">/*&#32;visit&#32;its&#32;upvalues&#32;*/</emphasis>
00603 &#32;&#32;&#32;&#32;<link linkend="_struct_up_val">UpVal</link>&#32;*uv&#32;=&#32;cl-&gt;<link linkend="_struct_l_closure_1aa4734795813776a46167fe712dfd9506">upvals</link>[i];
00604 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1af9d4ee7e422989e2c45413745252211b">markobjectN</link>(g,&#32;uv);&#32;&#32;<emphasis role="comment">/*&#32;mark&#32;upvalue&#32;*/</emphasis>
00605 &#32;&#32;}
00606 &#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;1&#32;+&#32;cl-&gt;nupvalues;
00607 }
00608 
00609 
00610 <emphasis role="comment">/*</emphasis>
00611 <emphasis role="comment">**&#32;Traverse&#32;a&#32;thread,&#32;marking&#32;the&#32;elements&#32;in&#32;the&#32;stack&#32;up&#32;to&#32;its&#32;top</emphasis>
00612 <emphasis role="comment">**&#32;and&#32;cleaning&#32;the&#32;rest&#32;of&#32;the&#32;stack&#32;in&#32;the&#32;final&#32;traversal.&#32;That</emphasis>
00613 <emphasis role="comment">**&#32;ensures&#32;that&#32;the&#32;entire&#32;stack&#32;have&#32;valid&#32;(non-dead)&#32;objects.</emphasis>
00614 <emphasis role="comment">**&#32;Threads&#32;have&#32;no&#32;barriers.&#32;In&#32;gen.&#32;mode,&#32;old&#32;threads&#32;must&#32;be&#32;visited</emphasis>
00615 <emphasis role="comment">**&#32;at&#32;every&#32;cycle,&#32;because&#32;they&#32;might&#32;point&#32;to&#32;young&#32;objects.&#32;&#32;In&#32;inc.</emphasis>
00616 <emphasis role="comment">**&#32;mode,&#32;the&#32;thread&#32;can&#32;still&#32;be&#32;modified&#32;before&#32;the&#32;end&#32;of&#32;the&#32;cycle,</emphasis>
00617 <emphasis role="comment">**&#32;and&#32;therefore&#32;it&#32;must&#32;be&#32;visited&#32;again&#32;in&#32;the&#32;atomic&#32;phase.&#32;To&#32;ensure</emphasis>
00618 <emphasis role="comment">**&#32;these&#32;visits,&#32;threads&#32;must&#32;return&#32;to&#32;a&#32;gray&#32;list&#32;if&#32;they&#32;are&#32;not&#32;new</emphasis>
00619 <emphasis role="comment">**&#32;(which&#32;can&#32;only&#32;happen&#32;in&#32;generational&#32;mode)&#32;or&#32;if&#32;the&#32;traverse&#32;is&#32;in</emphasis>
00620 <emphasis role="comment">**&#32;the&#32;propagate&#32;phase&#32;(which&#32;can&#32;only&#32;happen&#32;in&#32;incremental&#32;mode).</emphasis>
00621 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00622"/><link linkend="_lgc_8c_1a5759d7a25445fd28e24980d7f35a99b2">00622</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_lgc_8c_1a5759d7a25445fd28e24980d7f35a99b2">traversethread</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g,&#32;<link linkend="_structlua___state">lua_State</link>&#32;*th)&#32;{
00623 &#32;&#32;<link linkend="_struct_up_val">UpVal</link>&#32;*uv;
00624 &#32;&#32;<link linkend="_union_stack_value">StkId</link>&#32;o&#32;=&#32;th-&gt;<link linkend="_structlua___state_1a8d64aaa9257b553aae2e3e193c80a83f">stack</link>;
00625 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8h_1a24d47e523ecf2d6e475a34913ce06b05">isold</link>(th)&#32;||&#32;g-&gt;<link linkend="_structglobal___state_1aec22885c483e649f2d65368c3507cd9a">gcstate</link>&#32;==&#32;<link linkend="_lgc_8h_1a2ed301793747f3a2d0a7fc7d64d482fd">GCSpropagate</link>)
00626 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ad63f9d59a67a756d3c3540d9795cdcbe">linkgclist</link>(th,&#32;g-&gt;<link linkend="_structglobal___state_1af6b3198325143bc0a9a529e9b14ff29a">grayagain</link>);&#32;&#32;<emphasis role="comment">/*&#32;insert&#32;into&#32;&apos;grayagain&apos;&#32;list&#32;*/</emphasis>
00627 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(o&#32;==&#32;NULL)
00628 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;1;&#32;&#32;<emphasis role="comment">/*&#32;stack&#32;not&#32;completely&#32;built&#32;yet&#32;*/</emphasis>
00629 &#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(g-&gt;<link linkend="_structglobal___state_1aec22885c483e649f2d65368c3507cd9a">gcstate</link>&#32;==&#32;<link linkend="_lgc_8h_1a7c7806ab609fa3c19ed9c2b688e10730">GCSatomic</link>&#32;||
00630 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;th-&gt;<link linkend="_structlua___state_1a762ab4537c3697fa94e74b3c0dffd297">openupval</link>&#32;==&#32;NULL&#32;||&#32;<link linkend="_lfunc_8h_1a3e7e5157cf6e329e4a5609e70b65101f">isintwups</link>(th));
00631 &#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(;&#32;o&#32;&lt;&#32;th-&gt;<link linkend="_structlua___state_1afeb5dbe379fc406b35fe5f8a5fcfc5d7">top</link>;&#32;o++)&#32;&#32;<emphasis role="comment">/*&#32;mark&#32;live&#32;elements&#32;in&#32;the&#32;stack&#32;*/</emphasis>
00632 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a2dd4136ac29665568973c074bc450849">markvalue</link>(g,&#32;<link linkend="_lobject_8h_1a8c21cbb67def90b23342840cd08a5cfd">s2v</link>(o));
00633 &#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(uv&#32;=&#32;th-&gt;<link linkend="_structlua___state_1a762ab4537c3697fa94e74b3c0dffd297">openupval</link>;&#32;uv&#32;!=&#32;NULL;&#32;uv&#32;=&#32;uv-&gt;<link linkend="_struct_up_val_1ae88bb25a10ec80f8fa19750a76390923">u</link>.<link linkend="_struct_up_val_1a70efd6629df78085a967d85ee0a8e673">open</link>.next)
00634 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a6ae72c43e48b29944e55933df7f15482">markobject</link>(g,&#32;uv);&#32;&#32;<emphasis role="comment">/*&#32;open&#32;upvalues&#32;cannot&#32;be&#32;collected&#32;*/</emphasis>
00635 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(g-&gt;<link linkend="_structglobal___state_1aec22885c483e649f2d65368c3507cd9a">gcstate</link>&#32;==&#32;<link linkend="_lgc_8h_1a7c7806ab609fa3c19ed9c2b688e10730">GCSatomic</link>)&#32;{&#32;&#32;<emphasis role="comment">/*&#32;final&#32;traversal?&#32;*/</emphasis>
00636 &#32;&#32;&#32;&#32;<link linkend="_union_stack_value">StkId</link>&#32;lim&#32;=&#32;th-&gt;<link linkend="_structlua___state_1a8d64aaa9257b553aae2e3e193c80a83f">stack</link>&#32;+&#32;th-&gt;<link linkend="_structlua___state_1a7fe5de65ffba2cb8917943b5811ae1cf">stacksize</link>;&#32;&#32;<emphasis role="comment">/*&#32;real&#32;end&#32;of&#32;stack&#32;*/</emphasis>
00637 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(;&#32;o&#32;&lt;&#32;lim;&#32;o++)&#32;&#32;<emphasis role="comment">/*&#32;clear&#32;not-marked&#32;stack&#32;slice&#32;*/</emphasis>
00638 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lobject_8h_1ad9034def7bbc1965ec3d714d84620b07">setnilvalue</link>(<link linkend="_lobject_8h_1a8c21cbb67def90b23342840cd08a5cfd">s2v</link>(o));
00639 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;&apos;remarkupvals&apos;&#32;may&#32;have&#32;removed&#32;thread&#32;from&#32;&apos;twups&apos;&#32;list&#32;*/</emphasis>
00640 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(!<link linkend="_lfunc_8h_1a3e7e5157cf6e329e4a5609e70b65101f">isintwups</link>(th)&#32;&amp;&amp;&#32;th-&gt;<link linkend="_structlua___state_1a762ab4537c3697fa94e74b3c0dffd297">openupval</link>&#32;!=&#32;NULL)&#32;{
00641 &#32;&#32;&#32;&#32;&#32;&#32;th-&gt;<link linkend="_structlua___state_1a3c31ce83747be5e373872d7742afc3d1">twups</link>&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a3c31ce83747be5e373872d7742afc3d1">twups</link>;&#32;&#32;<emphasis role="comment">/*&#32;link&#32;it&#32;back&#32;to&#32;the&#32;list&#32;*/</emphasis>
00642 &#32;&#32;&#32;&#32;&#32;&#32;g-&gt;<link linkend="_structglobal___state_1a3c31ce83747be5e373872d7742afc3d1">twups</link>&#32;=&#32;th;
00643 &#32;&#32;&#32;&#32;}
00644 &#32;&#32;}
00645 &#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;<emphasis role="keywordflow">if</emphasis>&#32;(!g-&gt;<link linkend="_structglobal___state_1ae6cc757dac1c965fb147c2886d48e1fa">gcemergency</link>)
00646 &#32;&#32;&#32;&#32;<link linkend="_ldo_8c_1a219aa86777779dccae2c1bf9008db70a">luaD_shrinkstack</link>(th);&#32;<emphasis role="comment">/*&#32;do&#32;not&#32;change&#32;stack&#32;in&#32;emergency&#32;cycle&#32;*/</emphasis>
00647 &#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;1&#32;+&#32;th-&gt;<link linkend="_structlua___state_1a7fe5de65ffba2cb8917943b5811ae1cf">stacksize</link>;
00648 }
00649 
00650 
00651 <emphasis role="comment">/*</emphasis>
00652 <emphasis role="comment">**&#32;traverse&#32;one&#32;gray&#32;object,&#32;turning&#32;it&#32;to&#32;black.</emphasis>
00653 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00654"/><link linkend="_lgc_8c_1a817005bec4f6438093ec8bff63363f25">00654</link> <emphasis role="keyword">static</emphasis>&#32;<link linkend="_llimits_8h_1aac8c50ca0aa51c80523376da77c2c4d8">lu_mem</link>&#32;<link linkend="_lgc_8c_1a817005bec4f6438093ec8bff63363f25">propagatemark</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g)&#32;{
00655 &#32;&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*o&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a212d17a5d31cf9cd949ba66f16d63139">gray</link>;
00656 &#32;&#32;<link linkend="_lgc_8h_1a990de0d171d8b5425a5515d0bff78789">nw2black</link>(o);
00657 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1a212d17a5d31cf9cd949ba66f16d63139">gray</link>&#32;=&#32;*<link linkend="_lgc_8c_1a10a95d9a52dbdb6f36c090f5e2870007">getgclist</link>(o);&#32;&#32;<emphasis role="comment">/*&#32;remove&#32;from&#32;&apos;gray&apos;&#32;list&#32;*/</emphasis>
00658 &#32;&#32;<emphasis role="keywordflow">switch</emphasis>&#32;(o-&gt;tt)&#32;{
00659 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1afaf24d5b79b9027ad768d023778669df">LUA_VTABLE</link>:&#32;<emphasis role="keywordflow">return</emphasis>&#32;<link linkend="_lgc_8c_1a86c4c1008df3c908a9cca3cf72abc195">traversetable</link>(g,&#32;<link linkend="_lstate_8h_1a4f233ba369144fad9fd5fc6c513da1ac">gco2t</link>(o));
00660 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1af45b44d4031e7e869195dd97759d2ca3">LUA_VUSERDATA</link>:&#32;<emphasis role="keywordflow">return</emphasis>&#32;<link linkend="_lgc_8c_1a7a5280b620352ed9282f78028779c968">traverseudata</link>(g,&#32;<link linkend="_lstate_8h_1a55e9a228ad0d3a82ee9cfc353002fd8a">gco2u</link>(o));
00661 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1a5d0e6e41ea93960667095501aa5745c1">LUA_VLCL</link>:&#32;<emphasis role="keywordflow">return</emphasis>&#32;<link linkend="_lgc_8c_1a61e584daad5b6a41777ade0e72e559b3">traverseLclosure</link>(g,&#32;<link linkend="_lstate_8h_1adaac0379079b200986d6ae72b65aefaf">gco2lcl</link>(o));
00662 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1a2361d923ddb7fc1468b978fe043e35c2">LUA_VCCL</link>:&#32;<emphasis role="keywordflow">return</emphasis>&#32;<link linkend="_lgc_8c_1aa85f9809abfe94fcd3bbec6e2c46b104">traverseCclosure</link>(g,&#32;<link linkend="_lstate_8h_1a1dcf2ea170c68fe70adb5af7ae04c71e">gco2ccl</link>(o));
00663 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1a1c6c32cba3e6d0c897f68ceb273dd757">LUA_VPROTO</link>:&#32;<emphasis role="keywordflow">return</emphasis>&#32;<link linkend="_lgc_8c_1a19be424be90fc7025deae5ccfdcab62b">traverseproto</link>(g,&#32;<link linkend="_lstate_8h_1a8792af5dd4539a71f6ed8ddb31d079c3">gco2p</link>(o));
00664 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1ad224258ccc4e8f79f148d54d32ddbd00">LUA_VTHREAD</link>:&#32;<emphasis role="keywordflow">return</emphasis>&#32;<link linkend="_lgc_8c_1a5759d7a25445fd28e24980d7f35a99b2">traversethread</link>(g,&#32;<link linkend="_lstate_8h_1a52c467e11bd40cad5ca78372f7f67b4d">gco2th</link>(o));
00665 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">default</emphasis>:&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(0);&#32;<emphasis role="keywordflow">return</emphasis>&#32;0;
00666 &#32;&#32;}
00667 }
00668 
00669 
<anchor xml:id="_lgc_8c_source_1l00670"/><link linkend="_lgc_8c_1a344b3515bc8cbe737fbdd9fa1521d17d">00670</link> <emphasis role="keyword">static</emphasis>&#32;<link linkend="_llimits_8h_1aac8c50ca0aa51c80523376da77c2c4d8">lu_mem</link>&#32;<link linkend="_lgc_8c_1a344b3515bc8cbe737fbdd9fa1521d17d">propagateall</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g)&#32;{
00671 &#32;&#32;<link linkend="_llimits_8h_1aac8c50ca0aa51c80523376da77c2c4d8">lu_mem</link>&#32;tot&#32;=&#32;0;
00672 &#32;&#32;<emphasis role="keywordflow">while</emphasis>&#32;(g-&gt;<link linkend="_structglobal___state_1a212d17a5d31cf9cd949ba66f16d63139">gray</link>)
00673 &#32;&#32;&#32;&#32;tot&#32;+=&#32;<link linkend="_lgc_8c_1a817005bec4f6438093ec8bff63363f25">propagatemark</link>(g);
00674 &#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;tot;
00675 }
00676 
00677 
00678 <emphasis role="comment">/*</emphasis>
00679 <emphasis role="comment">**&#32;Traverse&#32;all&#32;ephemeron&#32;tables&#32;propagating&#32;marks&#32;from&#32;keys&#32;to&#32;values.</emphasis>
00680 <emphasis role="comment">**&#32;Repeat&#32;until&#32;it&#32;converges,&#32;that&#32;is,&#32;nothing&#32;new&#32;is&#32;marked.&#32;&apos;dir&apos;</emphasis>
00681 <emphasis role="comment">**&#32;inverts&#32;the&#32;direction&#32;of&#32;the&#32;traversals,&#32;trying&#32;to&#32;speed&#32;up</emphasis>
00682 <emphasis role="comment">**&#32;convergence&#32;on&#32;chains&#32;in&#32;the&#32;same&#32;table.</emphasis>
00683 <emphasis role="comment">**</emphasis>
00684 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00685"/><link linkend="_lgc_8c_1a467150a6e5a6ef4402432c4964817ffc">00685</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a467150a6e5a6ef4402432c4964817ffc">convergeephemerons</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g)&#32;{
00686 &#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;changed;
00687 &#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;dir&#32;=&#32;0;
00688 &#32;&#32;<emphasis role="keywordflow">do</emphasis>&#32;{
00689 &#32;&#32;&#32;&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*w;
00690 &#32;&#32;&#32;&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*<link linkend="_llex_8c_1a8ab976102fb046f9974c53caaf5a1995">next</link>&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1aac8b3202114d8c99a73328fff0c3c79c">ephemeron</link>;&#32;&#32;<emphasis role="comment">/*&#32;get&#32;ephemeron&#32;list&#32;*/</emphasis>
00691 &#32;&#32;&#32;&#32;g-&gt;<link linkend="_structglobal___state_1aac8b3202114d8c99a73328fff0c3c79c">ephemeron</link>&#32;=&#32;NULL;&#32;&#32;<emphasis role="comment">/*&#32;tables&#32;may&#32;return&#32;to&#32;this&#32;list&#32;when&#32;traversed&#32;*/</emphasis>
00692 &#32;&#32;&#32;&#32;changed&#32;=&#32;0;
00693 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">while</emphasis>&#32;((w&#32;=&#32;<link linkend="_llex_8c_1a8ab976102fb046f9974c53caaf5a1995">next</link>)&#32;!=&#32;NULL)&#32;{&#32;&#32;<emphasis role="comment">/*&#32;for&#32;each&#32;ephemeron&#32;table&#32;*/</emphasis>
00694 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_struct_table">Table</link>&#32;*h&#32;=&#32;<link linkend="_lstate_8h_1a4f233ba369144fad9fd5fc6c513da1ac">gco2t</link>(w);
00695 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_llex_8c_1a8ab976102fb046f9974c53caaf5a1995">next</link>&#32;=&#32;h-&gt;<link linkend="_struct_table_1a9e83d376257d9d775ce3e9c6f40ef0f1">gclist</link>;&#32;&#32;<emphasis role="comment">/*&#32;list&#32;is&#32;rebuilt&#32;during&#32;loop&#32;*/</emphasis>
00696 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8h_1a990de0d171d8b5425a5515d0bff78789">nw2black</link>(h);&#32;&#32;<emphasis role="comment">/*&#32;out&#32;of&#32;the&#32;list&#32;(for&#32;now)&#32;*/</emphasis>
00697 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8c_1aad4294f43d919ea5950d992599d1a445">traverseephemeron</link>(g,&#32;h,&#32;dir))&#32;{&#32;&#32;<emphasis role="comment">/*&#32;marked&#32;some&#32;value?&#32;*/</emphasis>
00698 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a344b3515bc8cbe737fbdd9fa1521d17d">propagateall</link>(g);&#32;&#32;<emphasis role="comment">/*&#32;propagate&#32;changes&#32;*/</emphasis>
00699 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;changed&#32;=&#32;1;&#32;&#32;<emphasis role="comment">/*&#32;will&#32;have&#32;to&#32;revisit&#32;all&#32;ephemeron&#32;tables&#32;*/</emphasis>
00700 &#32;&#32;&#32;&#32;&#32;&#32;}
00701 &#32;&#32;&#32;&#32;}
00702 &#32;&#32;&#32;&#32;dir&#32;=&#32;!dir;&#32;&#32;<emphasis role="comment">/*&#32;invert&#32;direction&#32;next&#32;time&#32;*/</emphasis>
00703 &#32;&#32;}&#32;<emphasis role="keywordflow">while</emphasis>&#32;(changed);&#32;&#32;<emphasis role="comment">/*&#32;repeat&#32;until&#32;no&#32;more&#32;changes&#32;*/</emphasis>
00704 }
00705 
00706 <emphasis role="comment">/*&#32;}======================================================&#32;*/</emphasis>
00707 
00708 
00709 <emphasis role="comment">/*</emphasis>
00710 <emphasis role="comment">**&#32;{======================================================</emphasis>
00711 <emphasis role="comment">**&#32;Sweep&#32;Functions</emphasis>
00712 <emphasis role="comment">**&#32;=======================================================</emphasis>
00713 <emphasis role="comment">*/</emphasis>
00714 
00715 
00716 <emphasis role="comment">/*</emphasis>
00717 <emphasis role="comment">**&#32;clear&#32;entries&#32;with&#32;unmarked&#32;keys&#32;from&#32;all&#32;weaktables&#32;in&#32;list&#32;&apos;l&apos;</emphasis>
00718 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00719"/><link linkend="_lgc_8c_1a56ce6be91da7747cf9d93826cf5c8f28">00719</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a56ce6be91da7747cf9d93826cf5c8f28">clearbykeys</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*l)&#32;{
00720 &#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(;&#32;l;&#32;l&#32;=&#32;<link linkend="_lstate_8h_1a4f233ba369144fad9fd5fc6c513da1ac">gco2t</link>(l)-&gt;gclist)&#32;{
00721 &#32;&#32;&#32;&#32;<link linkend="_struct_table">Table</link>&#32;*h&#32;=&#32;<link linkend="_lstate_8h_1a4f233ba369144fad9fd5fc6c513da1ac">gco2t</link>(l);
00722 &#32;&#32;&#32;&#32;<link linkend="_union_node">Node</link>&#32;*limit&#32;=&#32;<link linkend="_lgc_8c_1a43ef7b8388b613e737dd3ec7eb493f47">gnodelast</link>(h);
00723 &#32;&#32;&#32;&#32;<link linkend="_union_node">Node</link>&#32;*n;
00724 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(n&#32;=&#32;<link linkend="_ltable_8h_1a644cfa3b6d4be1782e818a8340b5f78b">gnode</link>(h,&#32;0);&#32;n&#32;&lt;&#32;limit;&#32;n++)&#32;{
00725 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8c_1acae02b6cdb8288e654682baf4117e8ab">iscleared</link>(g,&#32;<link linkend="_lobject_8h_1a228a192019c3bf44b6027d8f4a38c904">gckeyN</link>(n)))&#32;&#32;<emphasis role="comment">/*&#32;unmarked&#32;key?&#32;*/</emphasis>
00726 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lobject_8h_1a1504584244b6d1260c52a41cab9306d0">setempty</link>(<link linkend="_ltable_8h_1acbbecd9bd8fbb72a17f6e2f5acf7113d">gval</link>(n));&#32;&#32;<emphasis role="comment">/*&#32;remove&#32;entry&#32;*/</emphasis>
00727 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lobject_8h_1a5345ae49ed16dfecdfef95ec5399b000">isempty</link>(<link linkend="_ltable_8h_1acbbecd9bd8fbb72a17f6e2f5acf7113d">gval</link>(n)))&#32;&#32;<emphasis role="comment">/*&#32;is&#32;entry&#32;empty?&#32;*/</emphasis>
00728 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ae5b5bd4c69910951078ac627fa1654da">clearkey</link>(n);&#32;&#32;<emphasis role="comment">/*&#32;clear&#32;its&#32;key&#32;*/</emphasis>
00729 &#32;&#32;&#32;&#32;}
00730 &#32;&#32;}
00731 }
00732 
00733 
00734 <emphasis role="comment">/*</emphasis>
00735 <emphasis role="comment">**&#32;clear&#32;entries&#32;with&#32;unmarked&#32;values&#32;from&#32;all&#32;weaktables&#32;in&#32;list&#32;&apos;l&apos;&#32;up</emphasis>
00736 <emphasis role="comment">**&#32;to&#32;element&#32;&apos;f&apos;</emphasis>
00737 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00738"/><link linkend="_lgc_8c_1a634862684194c98758caa196038d7033">00738</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a634862684194c98758caa196038d7033">clearbyvalues</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*l,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*f)&#32;{
00739 &#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(;&#32;l&#32;!=&#32;f;&#32;l&#32;=&#32;<link linkend="_lstate_8h_1a4f233ba369144fad9fd5fc6c513da1ac">gco2t</link>(l)-&gt;gclist)&#32;{
00740 &#32;&#32;&#32;&#32;<link linkend="_struct_table">Table</link>&#32;*h&#32;=&#32;<link linkend="_lstate_8h_1a4f233ba369144fad9fd5fc6c513da1ac">gco2t</link>(l);
00741 &#32;&#32;&#32;&#32;<link linkend="_union_node">Node</link>&#32;*n,&#32;*limit&#32;=&#32;<link linkend="_lgc_8c_1a43ef7b8388b613e737dd3ec7eb493f47">gnodelast</link>(h);
00742 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">unsigned</emphasis>&#32;<emphasis role="keywordtype">int</emphasis>&#32;i;
00743 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">unsigned</emphasis>&#32;<emphasis role="keywordtype">int</emphasis>&#32;asize&#32;=&#32;<link linkend="_ltable_8c_1a8f20a204b7a78780847939086b847781">luaH_realasize</link>(h);
00744 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(i&#32;=&#32;0;&#32;i&#32;&lt;&#32;asize;&#32;i++)&#32;{
00745 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_struct_t_value">TValue</link>&#32;*o&#32;=&#32;&amp;h-&gt;<link linkend="_struct_table_1a6ce25078468c6681674e2f56432a27b9">array</link>[i];
00746 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8c_1acae02b6cdb8288e654682baf4117e8ab">iscleared</link>(g,&#32;<link linkend="_lgc_8c_1a7c7f051ea3f0945577e90c480ebeee88">gcvalueN</link>(o)))&#32;&#32;<emphasis role="comment">/*&#32;value&#32;was&#32;collected?&#32;*/</emphasis>
00747 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lobject_8h_1a1504584244b6d1260c52a41cab9306d0">setempty</link>(o);&#32;&#32;<emphasis role="comment">/*&#32;remove&#32;entry&#32;*/</emphasis>
00748 &#32;&#32;&#32;&#32;}
00749 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(n&#32;=&#32;<link linkend="_ltable_8h_1a644cfa3b6d4be1782e818a8340b5f78b">gnode</link>(h,&#32;0);&#32;n&#32;&lt;&#32;limit;&#32;n++)&#32;{
00750 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8c_1acae02b6cdb8288e654682baf4117e8ab">iscleared</link>(g,&#32;<link linkend="_lgc_8c_1a7c7f051ea3f0945577e90c480ebeee88">gcvalueN</link>(<link linkend="_ltable_8h_1acbbecd9bd8fbb72a17f6e2f5acf7113d">gval</link>(n))))&#32;&#32;<emphasis role="comment">/*&#32;unmarked&#32;value?&#32;*/</emphasis>
00751 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lobject_8h_1a1504584244b6d1260c52a41cab9306d0">setempty</link>(<link linkend="_ltable_8h_1acbbecd9bd8fbb72a17f6e2f5acf7113d">gval</link>(n));&#32;&#32;<emphasis role="comment">/*&#32;remove&#32;entry&#32;*/</emphasis>
00752 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lobject_8h_1a5345ae49ed16dfecdfef95ec5399b000">isempty</link>(<link linkend="_ltable_8h_1acbbecd9bd8fbb72a17f6e2f5acf7113d">gval</link>(n)))&#32;&#32;<emphasis role="comment">/*&#32;is&#32;entry&#32;empty?&#32;*/</emphasis>
00753 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ae5b5bd4c69910951078ac627fa1654da">clearkey</link>(n);&#32;&#32;<emphasis role="comment">/*&#32;clear&#32;its&#32;key&#32;*/</emphasis>
00754 &#32;&#32;&#32;&#32;}
00755 &#32;&#32;}
00756 }
00757 
00758 
<anchor xml:id="_lgc_8c_source_1l00759"/><link linkend="_lgc_8c_1a41b4adb59140172e2cd717fb921cd372">00759</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a41b4adb59140172e2cd717fb921cd372">freeupval</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<link linkend="_struct_up_val">UpVal</link>&#32;*uv)&#32;{
00760 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lfunc_8h_1a26a8ecd7d58d326f7f6f20bc8bc8bb55">upisopen</link>(uv))
00761 &#32;&#32;&#32;&#32;<link linkend="_lfunc_8c_1a3b5a5ae122e85af5c941e9b4ffff53bd">luaF_unlinkupval</link>(uv);
00762 &#32;&#32;<link linkend="_lmem_8h_1ad927ceb6a17a9e89a00b83dcc4482988">luaM_free</link>(L,&#32;uv);
00763 }
00764 
00765 
<anchor xml:id="_lgc_8c_source_1l00766"/><link linkend="_lgc_8c_1aa198d7da2a8502ed70adfe1f7ed38f46">00766</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1aa198d7da2a8502ed70adfe1f7ed38f46">freeobj</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*o)&#32;{
00767 &#32;&#32;<emphasis role="keywordflow">switch</emphasis>&#32;(o-&gt;tt)&#32;{
00768 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1a1c6c32cba3e6d0c897f68ceb273dd757">LUA_VPROTO</link>:
00769 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lfunc_8c_1a117c26fb473f6165ee84d70d49a741b7">luaF_freeproto</link>(L,&#32;<link linkend="_lstate_8h_1a8792af5dd4539a71f6ed8ddb31d079c3">gco2p</link>(o));
00770 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
00771 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1ae982db94518ed52587579ed70d822ad5">LUA_VUPVAL</link>:
00772 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a41b4adb59140172e2cd717fb921cd372">freeupval</link>(L,&#32;<link linkend="_lstate_8h_1a1633a3ec133e64956014aafd04e31cce">gco2upv</link>(o));
00773 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
00774 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1a5d0e6e41ea93960667095501aa5745c1">LUA_VLCL</link>:
00775 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lmem_8h_1a159fd0a4f45c4aa195990526f9d0bf01">luaM_freemem</link>(L,&#32;o,&#32;<link linkend="_lfunc_8h_1ab5551e284145e5258a8032a97806cfe1">sizeLclosure</link>(<link linkend="_lstate_8h_1adaac0379079b200986d6ae72b65aefaf">gco2lcl</link>(o)-&gt;nupvalues));
00776 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
00777 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1a2361d923ddb7fc1468b978fe043e35c2">LUA_VCCL</link>:
00778 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lmem_8h_1a159fd0a4f45c4aa195990526f9d0bf01">luaM_freemem</link>(L,&#32;o,&#32;<link linkend="_lfunc_8h_1ae0283669f47da8432046d0a24c1db93e">sizeCclosure</link>(<link linkend="_lstate_8h_1a1dcf2ea170c68fe70adb5af7ae04c71e">gco2ccl</link>(o)-&gt;nupvalues));
00779 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
00780 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1afaf24d5b79b9027ad768d023778669df">LUA_VTABLE</link>:
00781 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_ltable_8c_1ac6d94de2e83b5b0865b4aca30dec5c8c">luaH_free</link>(L,&#32;<link linkend="_lstate_8h_1a4f233ba369144fad9fd5fc6c513da1ac">gco2t</link>(o));
00782 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
00783 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1ad224258ccc4e8f79f148d54d32ddbd00">LUA_VTHREAD</link>:
00784 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lstate_8c_1a8c121cf8444c9c54e934aeb509c4b73a">luaE_freethread</link>(L,&#32;<link linkend="_lstate_8h_1a52c467e11bd40cad5ca78372f7f67b4d">gco2th</link>(o));
00785 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
00786 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1af45b44d4031e7e869195dd97759d2ca3">LUA_VUSERDATA</link>:&#32;{
00787 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_struct_udata">Udata</link>&#32;*u&#32;=&#32;<link linkend="_lstate_8h_1a55e9a228ad0d3a82ee9cfc353002fd8a">gco2u</link>(o);
00788 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lmem_8h_1a159fd0a4f45c4aa195990526f9d0bf01">luaM_freemem</link>(L,&#32;o,&#32;<link linkend="_lobject_8h_1a762595cf399516b83e0f5580a9a3a7b9">sizeudata</link>(u-&gt;<link linkend="_struct_udata_1a73b0125a5ce1394f28d43c93751a9db5">nuvalue</link>,&#32;u-&gt;<link linkend="_struct_udata_1a7360b55975153b822efc5217b7734e6a">len</link>));
00789 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
00790 &#32;&#32;&#32;&#32;}
00791 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1a794410ffd7267ef873eb05ac695b1ba6">LUA_VSHRSTR</link>:
00792 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lstring_8c_1a7cac97a1c8f2564c7f0669119dd776fe">luaS_remove</link>(L,&#32;<link linkend="_lstate_8h_1af6c16f3aa27ad97ea1bcaa31e05e0b06">gco2ts</link>(o));&#32;&#32;<emphasis role="comment">/*&#32;remove&#32;it&#32;from&#32;hash&#32;table&#32;*/</emphasis>
00793 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lmem_8h_1a159fd0a4f45c4aa195990526f9d0bf01">luaM_freemem</link>(L,&#32;o,&#32;<link linkend="_lstring_8h_1a160d701eba216310b09be7447f47794d">sizelstring</link>(<link linkend="_lstate_8h_1af6c16f3aa27ad97ea1bcaa31e05e0b06">gco2ts</link>(o)-&gt;shrlen));
00794 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
00795 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lobject_8h_1a6869fcb0a0178b6d70d431eae1683199">LUA_VLNGSTR</link>:
00796 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lmem_8h_1a159fd0a4f45c4aa195990526f9d0bf01">luaM_freemem</link>(L,&#32;o,&#32;<link linkend="_lstring_8h_1a160d701eba216310b09be7447f47794d">sizelstring</link>(<link linkend="_lstate_8h_1af6c16f3aa27ad97ea1bcaa31e05e0b06">gco2ts</link>(o)-&gt;u.lnglen));
00797 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
00798 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">default</emphasis>:&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(0);
00799 &#32;&#32;}
00800 }
00801 
00802 
00803 <emphasis role="comment">/*</emphasis>
00804 <emphasis role="comment">**&#32;sweep&#32;at&#32;most&#32;&apos;countin&apos;&#32;elements&#32;from&#32;a&#32;list&#32;of&#32;GCObjects&#32;erasing&#32;dead</emphasis>
00805 <emphasis role="comment">**&#32;objects,&#32;where&#32;a&#32;dead&#32;object&#32;is&#32;one&#32;marked&#32;with&#32;the&#32;old&#32;(non&#32;current)</emphasis>
00806 <emphasis role="comment">**&#32;white;&#32;change&#32;all&#32;non-dead&#32;objects&#32;back&#32;to&#32;white,&#32;preparing&#32;for&#32;next</emphasis>
00807 <emphasis role="comment">**&#32;collection&#32;cycle.&#32;Return&#32;where&#32;to&#32;continue&#32;the&#32;traversal&#32;or&#32;NULL&#32;if</emphasis>
00808 <emphasis role="comment">**&#32;list&#32;is&#32;finished.&#32;(&apos;*countout&apos;&#32;gets&#32;the&#32;number&#32;of&#32;elements&#32;traversed.)</emphasis>
00809 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00810"/><link linkend="_lgc_8c_1a88abd139efb3d69379bf4ee92b84a65d">00810</link> <emphasis role="keyword">static</emphasis>&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;**<link linkend="_lgc_8c_1a88abd139efb3d69379bf4ee92b84a65d">sweeplist</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;**p,&#32;<emphasis role="keywordtype">int</emphasis>&#32;countin,
00811 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;*countout)&#32;{
00812 &#32;&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g&#32;=&#32;<link linkend="_lstate_8h_1a103db2de6edf3420c6c6c9a282562406">G</link>(L);
00813 &#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;ow&#32;=&#32;<link linkend="_lgc_8h_1a486df16493498577d4081a8c231154f0">otherwhite</link>(g);
00814 &#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;i;
00815 &#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;white&#32;=&#32;<link linkend="_lgc_8h_1afaa8a52c4097cf3a5eacd88db94092da">luaC_white</link>(g);&#32;&#32;<emphasis role="comment">/*&#32;current&#32;white&#32;*/</emphasis>
00816 &#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(i&#32;=&#32;0;&#32;*p&#32;!=&#32;NULL&#32;&amp;&amp;&#32;i&#32;&lt;&#32;countin;&#32;i++)&#32;{
00817 &#32;&#32;&#32;&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*curr&#32;=&#32;*p;
00818 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;marked&#32;=&#32;curr-&gt;marked;
00819 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8h_1a0540e865b6cd21e83104cf427c968c86">isdeadm</link>(ow,&#32;marked))&#32;{&#32;&#32;<emphasis role="comment">/*&#32;is&#32;&apos;curr&apos;&#32;dead?&#32;*/</emphasis>
00820 &#32;&#32;&#32;&#32;&#32;&#32;*p&#32;=&#32;curr-&gt;next;&#32;&#32;<emphasis role="comment">/*&#32;remove&#32;&apos;curr&apos;&#32;from&#32;list&#32;*/</emphasis>
00821 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1aa198d7da2a8502ed70adfe1f7ed38f46">freeobj</link>(L,&#32;curr);&#32;&#32;<emphasis role="comment">/*&#32;erase&#32;&apos;curr&apos;&#32;*/</emphasis>
00822 &#32;&#32;&#32;&#32;}
00823 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;{&#32;&#32;<emphasis role="comment">/*&#32;change&#32;mark&#32;to&#32;&apos;white&apos;&#32;*/</emphasis>
00824 &#32;&#32;&#32;&#32;&#32;&#32;curr-&gt;marked&#32;=&#32;<link linkend="_llimits_8h_1a596f5b6e992f53a5a4e5732083448dd4">cast_byte</link>((marked&#32;&amp;&#32;~<link linkend="_lgc_8c_1a3ea4c714396849e66d63d88a8987f149">maskgcbits</link>)&#32;|&#32;white);
00825 &#32;&#32;&#32;&#32;&#32;&#32;p&#32;=&#32;&amp;curr-&gt;next;&#32;&#32;<emphasis role="comment">/*&#32;go&#32;to&#32;next&#32;element&#32;*/</emphasis>
00826 &#32;&#32;&#32;&#32;}
00827 &#32;&#32;}
00828 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(countout)
00829 &#32;&#32;&#32;&#32;*countout&#32;=&#32;i;&#32;&#32;<emphasis role="comment">/*&#32;number&#32;of&#32;elements&#32;traversed&#32;*/</emphasis>
00830 &#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;(*p&#32;==&#32;NULL)&#32;?&#32;NULL&#32;:&#32;p;
00831 }
00832 
00833 
00834 <emphasis role="comment">/*</emphasis>
00835 <emphasis role="comment">**&#32;sweep&#32;a&#32;list&#32;until&#32;a&#32;live&#32;object&#32;(or&#32;end&#32;of&#32;list)</emphasis>
00836 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00837"/><link linkend="_lgc_8c_1ab518b7adba50d2e796e206dbc96a9d52">00837</link> <emphasis role="keyword">static</emphasis>&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;**<link linkend="_lgc_8c_1ab518b7adba50d2e796e206dbc96a9d52">sweeptolive</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;**p)&#32;{
00838 &#32;&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;**old&#32;=&#32;p;
00839 &#32;&#32;<emphasis role="keywordflow">do</emphasis>&#32;{
00840 &#32;&#32;&#32;&#32;p&#32;=&#32;<link linkend="_lgc_8c_1a88abd139efb3d69379bf4ee92b84a65d">sweeplist</link>(L,&#32;p,&#32;1,&#32;NULL);
00841 &#32;&#32;}&#32;<emphasis role="keywordflow">while</emphasis>&#32;(p&#32;==&#32;old);
00842 &#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;p;
00843 }
00844 
00845 <emphasis role="comment">/*&#32;}======================================================&#32;*/</emphasis>
00846 
00847 
00848 <emphasis role="comment">/*</emphasis>
00849 <emphasis role="comment">**&#32;{======================================================</emphasis>
00850 <emphasis role="comment">**&#32;Finalization</emphasis>
00851 <emphasis role="comment">**&#32;=======================================================</emphasis>
00852 <emphasis role="comment">*/</emphasis>
00853 
00854 <emphasis role="comment">/*</emphasis>
00855 <emphasis role="comment">**&#32;If&#32;possible,&#32;shrink&#32;string&#32;table.</emphasis>
00856 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00857"/><link linkend="_lgc_8c_1a1b2909449f815733deb4bc35c0103002">00857</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a1b2909449f815733deb4bc35c0103002">checkSizes</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g)&#32;{
00858 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(!g-&gt;<link linkend="_structglobal___state_1ae6cc757dac1c965fb147c2886d48e1fa">gcemergency</link>)&#32;{
00859 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(g-&gt;<link linkend="_structglobal___state_1a8a49c5693b4e171bf57b33e32c254f52">strt</link>.<link linkend="_structstringtable_1aa69d4be70d4410a0e505187f4b56e824">nuse</link>&#32;&lt;&#32;g-&gt;<link linkend="_structglobal___state_1a8a49c5693b4e171bf57b33e32c254f52">strt</link>.<link linkend="_structstringtable_1a439227feff9d7f55384e8780cfc2eb82">size</link>&#32;/&#32;4)&#32;{&#32;&#32;<emphasis role="comment">/*&#32;string&#32;table&#32;too&#32;big?&#32;*/</emphasis>
00860 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_llimits_8h_1a24fc195087e262c99a4cf0f9b346a684">l_mem</link>&#32;olddebt&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1ae466d806319d4ba1b672bbff60f369f9">GCdebt</link>;
00861 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lstring_8c_1ad47f5961683a728dd3f6d80040d1dd92">luaS_resize</link>(L,&#32;g-&gt;<link linkend="_structglobal___state_1a8a49c5693b4e171bf57b33e32c254f52">strt</link>.<link linkend="_structstringtable_1a439227feff9d7f55384e8780cfc2eb82">size</link>&#32;/&#32;2);
00862 &#32;&#32;&#32;&#32;&#32;&#32;g-&gt;<link linkend="_structglobal___state_1a6a108191b7f626df294d49cbb4380da1">GCestimate</link>&#32;+=&#32;g-&gt;<link linkend="_structglobal___state_1ae466d806319d4ba1b672bbff60f369f9">GCdebt</link>&#32;-&#32;olddebt;&#32;&#32;<emphasis role="comment">/*&#32;correct&#32;estimate&#32;*/</emphasis>
00863 &#32;&#32;&#32;&#32;}
00864 &#32;&#32;}
00865 }
00866 
00867 
00868 <emphasis role="comment">/*</emphasis>
00869 <emphasis role="comment">**&#32;Get&#32;the&#32;next&#32;udata&#32;to&#32;be&#32;finalized&#32;from&#32;the&#32;&apos;tobefnz&apos;&#32;list,&#32;and</emphasis>
00870 <emphasis role="comment">**&#32;link&#32;it&#32;back&#32;into&#32;the&#32;&apos;allgc&apos;&#32;list.</emphasis>
00871 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00872"/><link linkend="_lgc_8c_1a1b500eec5a67ec92ad263021bd7d9435">00872</link> <emphasis role="keyword">static</emphasis>&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*<link linkend="_lgc_8c_1a1b500eec5a67ec92ad263021bd7d9435">udata2finalize</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g)&#32;{
00873 &#32;&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*o&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a26a1a773fdf19f6aa0be08d5b8395c26">tobefnz</link>;&#32;&#32;<emphasis role="comment">/*&#32;get&#32;first&#32;element&#32;*/</emphasis>
00874 &#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(<link linkend="_lgc_8h_1a6d17f226d57a796f7741f457400cf8bd">tofinalize</link>(o));
00875 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1a26a1a773fdf19f6aa0be08d5b8395c26">tobefnz</link>&#32;=&#32;o-&gt;next;&#32;&#32;<emphasis role="comment">/*&#32;remove&#32;it&#32;from&#32;&apos;tobefnz&apos;&#32;list&#32;*/</emphasis>
00876 &#32;&#32;o-&gt;next&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a3239e7c69845ec6df350dc5b6f1d5291">allgc</link>;&#32;&#32;<emphasis role="comment">/*&#32;return&#32;it&#32;to&#32;&apos;allgc&apos;&#32;list&#32;*/</emphasis>
00877 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1a3239e7c69845ec6df350dc5b6f1d5291">allgc</link>&#32;=&#32;o;
00878 &#32;&#32;<link linkend="_lgc_8h_1aca0beb244185329a1b8f0e695ef47748">resetbit</link>(o-&gt;marked,&#32;<link linkend="_lgc_8h_1a92211ad01420ac616819ba8f61ca7365">FINALIZEDBIT</link>);&#32;&#32;<emphasis role="comment">/*&#32;object&#32;is&#32;&quot;normal&quot;&#32;again&#32;*/</emphasis>
00879 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8h_1a860db734bc919435aba75c30e4fe261b">issweepphase</link>(g))
00880 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ada061b1d508c516b2e53f546521b3eeb">makewhite</link>(g,&#32;o);&#32;&#32;<emphasis role="comment">/*&#32;&quot;sweep&quot;&#32;object&#32;*/</emphasis>
00881 &#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8h_1ae68465c1574c4b45a05a6548ad934235">getage</link>(o)&#32;==&#32;<link linkend="_lgc_8h_1a266a8ec4a8dbacf8d7b99dca3adcac90">G_OLD1</link>)
00882 &#32;&#32;&#32;&#32;g-&gt;<link linkend="_structglobal___state_1a531fb511fec0766c7a35ab1a0c3450cb">firstold1</link>&#32;=&#32;o;&#32;&#32;<emphasis role="comment">/*&#32;it&#32;is&#32;the&#32;first&#32;OLD1&#32;object&#32;in&#32;the&#32;list&#32;*/</emphasis>
00883 &#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;o;
00884 }
00885 
00886 
<anchor xml:id="_lgc_8c_source_1l00887"/><link linkend="_lgc_8c_1a929058f72c03750fa82374f6bfa639ee">00887</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a929058f72c03750fa82374f6bfa639ee">dothecall</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<emphasis role="keywordtype">void</emphasis>&#32;*ud)&#32;{
00888 &#32;&#32;<link linkend="_llimits_8h_1a86d500a34c624c2cae56bc25a31b12f3">UNUSED</link>(ud);
00889 &#32;&#32;<link linkend="_ldo_8c_1a61c0a0185ef5ae1493dad10027f4db7e">luaD_callnoyield</link>(L,&#32;L-&gt;<link linkend="_structlua___state_1afeb5dbe379fc406b35fe5f8a5fcfc5d7">top</link>&#32;-&#32;2,&#32;0);
00890 }
00891 
00892 
<anchor xml:id="_lgc_8c_source_1l00893"/><link linkend="_lgc_8c_1aaf7c6e9e6a93da6bb64ffe7654668ba3">00893</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1aaf7c6e9e6a93da6bb64ffe7654668ba3">GCTM</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L)&#32;{
00894 &#32;&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g&#32;=&#32;<link linkend="_lstate_8h_1a103db2de6edf3420c6c6c9a282562406">G</link>(L);
00895 &#32;&#32;<emphasis role="keyword">const</emphasis>&#32;<link linkend="_struct_t_value">TValue</link>&#32;*tm;
00896 &#32;&#32;<link linkend="_struct_t_value">TValue</link>&#32;v;
00897 &#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(!g-&gt;<link linkend="_structglobal___state_1ae6cc757dac1c965fb147c2886d48e1fa">gcemergency</link>);
00898 &#32;&#32;<link linkend="_lobject_8h_1a977fe2a01691b55cdd5eabefb4114434">setgcovalue</link>(L,&#32;&amp;v,&#32;<link linkend="_lgc_8c_1a1b500eec5a67ec92ad263021bd7d9435">udata2finalize</link>(g));
00899 &#32;&#32;tm&#32;=&#32;<link linkend="_ltm_8c_1a0a3a3df9d6e7f17d806f74d411e59b2d">luaT_gettmbyobj</link>(L,&#32;&amp;v,&#32;<link linkend="_ltm_8h_1a69e345ae253d250b61a03f1d6871c8d1a01e1b0be5e2785471e19db3665960536">TM_GC</link>);
00900 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(!<link linkend="_ltm_8h_1a219a766ba661fa51758627615c22e632">notm</link>(tm))&#32;{&#32;&#32;<emphasis role="comment">/*&#32;is&#32;there&#32;a&#32;finalizer?&#32;*/</emphasis>
00901 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;status;
00902 &#32;&#32;&#32;&#32;<link linkend="_llimits_8h_1ae1fe9ac10d9803bd1d7bdf30b18bad68">lu_byte</link>&#32;oldah&#32;=&#32;L-&gt;<link linkend="_structlua___state_1ae027b098c1d274d696f69fdac344e236">allowhook</link>;
00903 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;running&#32;&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a39557d352dfca7f1553b694d54c0b662">gcrunning</link>;
00904 &#32;&#32;&#32;&#32;L-&gt;<link linkend="_structlua___state_1ae027b098c1d274d696f69fdac344e236">allowhook</link>&#32;=&#32;0;&#32;&#32;<emphasis role="comment">/*&#32;stop&#32;debug&#32;hooks&#32;during&#32;GC&#32;metamethod&#32;*/</emphasis>
00905 &#32;&#32;&#32;&#32;g-&gt;<link linkend="_structglobal___state_1a39557d352dfca7f1553b694d54c0b662">gcrunning</link>&#32;=&#32;0;&#32;&#32;<emphasis role="comment">/*&#32;avoid&#32;GC&#32;steps&#32;*/</emphasis>
00906 &#32;&#32;&#32;&#32;<link linkend="_lobject_8h_1add70d29b431f66a1dee29a0cb286de6e">setobj2s</link>(L,&#32;L-&gt;<link linkend="_structlua___state_1afeb5dbe379fc406b35fe5f8a5fcfc5d7">top</link>++,&#32;tm);&#32;&#32;<emphasis role="comment">/*&#32;push&#32;finalizer...&#32;*/</emphasis>
00907 &#32;&#32;&#32;&#32;<link linkend="_lobject_8h_1add70d29b431f66a1dee29a0cb286de6e">setobj2s</link>(L,&#32;L-&gt;<link linkend="_structlua___state_1afeb5dbe379fc406b35fe5f8a5fcfc5d7">top</link>++,&#32;&amp;v);&#32;&#32;<emphasis role="comment">/*&#32;...&#32;and&#32;its&#32;argument&#32;*/</emphasis>
00908 &#32;&#32;&#32;&#32;L-&gt;<link linkend="_structlua___state_1a8764223139091552413c85d3fc0bb1eb">ci</link>-&gt;<link linkend="_struct_call_info_1a1551d635e86dcf5c62f9bc718512d89b">callstatus</link>&#32;|=&#32;<link linkend="_lstate_8h_1a6238abb19ba287875358e796aacb9473">CIST_FIN</link>;&#32;&#32;<emphasis role="comment">/*&#32;will&#32;run&#32;a&#32;finalizer&#32;*/</emphasis>
00909 &#32;&#32;&#32;&#32;status&#32;=&#32;<link linkend="_ldo_8c_1a1ad7f845cc62b110e3fcc0ae187d7c85">luaD_pcall</link>(L,&#32;<link linkend="_lgc_8c_1a929058f72c03750fa82374f6bfa639ee">dothecall</link>,&#32;NULL,&#32;<link linkend="_ldo_8h_1a3534573bbeec89c6dbdb3eae5a54f9b9">savestack</link>(L,&#32;L-&gt;<link linkend="_structlua___state_1afeb5dbe379fc406b35fe5f8a5fcfc5d7">top</link>&#32;-&#32;2),&#32;0);
00910 &#32;&#32;&#32;&#32;L-&gt;<link linkend="_structlua___state_1a8764223139091552413c85d3fc0bb1eb">ci</link>-&gt;<link linkend="_struct_call_info_1a1551d635e86dcf5c62f9bc718512d89b">callstatus</link>&#32;&amp;=&#32;~<link linkend="_lstate_8h_1a6238abb19ba287875358e796aacb9473">CIST_FIN</link>;&#32;&#32;<emphasis role="comment">/*&#32;not&#32;running&#32;a&#32;finalizer&#32;anymore&#32;*/</emphasis>
00911 &#32;&#32;&#32;&#32;L-&gt;<link linkend="_structlua___state_1ae027b098c1d274d696f69fdac344e236">allowhook</link>&#32;=&#32;oldah;&#32;&#32;<emphasis role="comment">/*&#32;restore&#32;hooks&#32;*/</emphasis>
00912 &#32;&#32;&#32;&#32;g-&gt;<link linkend="_structglobal___state_1a39557d352dfca7f1553b694d54c0b662">gcrunning</link>&#32;=&#32;running;&#32;&#32;<emphasis role="comment">/*&#32;restore&#32;state&#32;*/</emphasis>
00913 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_llimits_8h_1ac6c45889010c1bd68631771b64f18101">unlikely</link>(status&#32;!=&#32;<link linkend="_lua_8h_1ab969ff78cb1b63efa2bba3bdfa6fff5c">LUA_OK</link>))&#32;{&#32;&#32;<emphasis role="comment">/*&#32;error&#32;while&#32;running&#32;__gc?&#32;*/</emphasis>
00914 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lstate_8c_1a242ebb018d637c41f24b84a2bbc78f34">luaE_warnerror</link>(L,&#32;<emphasis role="stringliteral">&quot;__gc&#32;metamethod&quot;</emphasis>);
00915 &#32;&#32;&#32;&#32;&#32;&#32;L-&gt;<link linkend="_structlua___state_1afeb5dbe379fc406b35fe5f8a5fcfc5d7">top</link>--;&#32;&#32;<emphasis role="comment">/*&#32;pops&#32;error&#32;object&#32;*/</emphasis>
00916 &#32;&#32;&#32;&#32;}
00917 &#32;&#32;}
00918 }
00919 
00920 
00921 <emphasis role="comment">/*</emphasis>
00922 <emphasis role="comment">**&#32;Call&#32;a&#32;few&#32;finalizers</emphasis>
00923 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00924"/><link linkend="_lgc_8c_1a5ba38781fc577f890c6f97af9beef40a">00924</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_lgc_8c_1a5ba38781fc577f890c6f97af9beef40a">runafewfinalizers</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<emphasis role="keywordtype">int</emphasis>&#32;n)&#32;{
00925 &#32;&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g&#32;=&#32;<link linkend="_lstate_8h_1a103db2de6edf3420c6c6c9a282562406">G</link>(L);
00926 &#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;i;
00927 &#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(i&#32;=&#32;0;&#32;i&#32;&lt;&#32;n&#32;&amp;&amp;&#32;g-&gt;<link linkend="_structglobal___state_1a26a1a773fdf19f6aa0be08d5b8395c26">tobefnz</link>;&#32;i++)
00928 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1aaf7c6e9e6a93da6bb64ffe7654668ba3">GCTM</link>(L);&#32;&#32;<emphasis role="comment">/*&#32;call&#32;one&#32;finalizer&#32;*/</emphasis>
00929 &#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;i;
00930 }
00931 
00932 
00933 <emphasis role="comment">/*</emphasis>
00934 <emphasis role="comment">**&#32;call&#32;all&#32;pending&#32;finalizers</emphasis>
00935 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00936"/><link linkend="_lgc_8c_1a3c6f43e1b63924361ed0ce31b6d30f8b">00936</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a3c6f43e1b63924361ed0ce31b6d30f8b">callallpendingfinalizers</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L)&#32;{
00937 &#32;&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g&#32;=&#32;<link linkend="_lstate_8h_1a103db2de6edf3420c6c6c9a282562406">G</link>(L);
00938 &#32;&#32;<emphasis role="keywordflow">while</emphasis>&#32;(g-&gt;<link linkend="_structglobal___state_1a26a1a773fdf19f6aa0be08d5b8395c26">tobefnz</link>)
00939 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1aaf7c6e9e6a93da6bb64ffe7654668ba3">GCTM</link>(L);
00940 }
00941 
00942 
00943 <emphasis role="comment">/*</emphasis>
00944 <emphasis role="comment">**&#32;find&#32;last&#32;&apos;next&apos;&#32;field&#32;in&#32;list&#32;&apos;p&apos;&#32;list&#32;(to&#32;add&#32;elements&#32;in&#32;its&#32;end)</emphasis>
00945 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00946"/><link linkend="_lgc_8c_1a00546669316a08c1286570927e676496">00946</link> <emphasis role="keyword">static</emphasis>&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;**<link linkend="_lgc_8c_1a00546669316a08c1286570927e676496">findlast</link>&#32;(<link linkend="_struct_g_c_object">GCObject</link>&#32;**p)&#32;{
00947 &#32;&#32;<emphasis role="keywordflow">while</emphasis>&#32;(*p&#32;!=&#32;NULL)
00948 &#32;&#32;&#32;&#32;p&#32;=&#32;&amp;(*p)-&gt;next;
00949 &#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;p;
00950 }
00951 
00952 
00953 <emphasis role="comment">/*</emphasis>
00954 <emphasis role="comment">**&#32;Move&#32;all&#32;unreachable&#32;objects&#32;(or&#32;&apos;all&apos;&#32;objects)&#32;that&#32;need</emphasis>
00955 <emphasis role="comment">**&#32;finalization&#32;from&#32;list&#32;&apos;finobj&apos;&#32;to&#32;list&#32;&apos;tobefnz&apos;&#32;(to&#32;be&#32;finalized).</emphasis>
00956 <emphasis role="comment">**&#32;(Note&#32;that&#32;objects&#32;after&#32;&apos;finobjold1&apos;&#32;cannot&#32;be&#32;white,&#32;so&#32;they</emphasis>
00957 <emphasis role="comment">**&#32;don&apos;t&#32;need&#32;to&#32;be&#32;traversed.&#32;In&#32;incremental&#32;mode,&#32;&apos;finobjold1&apos;&#32;is&#32;NULL,</emphasis>
00958 <emphasis role="comment">**&#32;so&#32;the&#32;whole&#32;list&#32;is&#32;traversed.)</emphasis>
00959 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00960"/><link linkend="_lgc_8c_1a39f98f28e85cc750b7cca70b10e79ee9">00960</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a39f98f28e85cc750b7cca70b10e79ee9">separatetobefnz</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g,&#32;<emphasis role="keywordtype">int</emphasis>&#32;all)&#32;{
00961 &#32;&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*curr;
00962 &#32;&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;**p&#32;=&#32;&amp;g-&gt;<link linkend="_structglobal___state_1a7c1118954ba5fdca801f48c9242c1a23">finobj</link>;
00963 &#32;&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;**lastnext&#32;=&#32;<link linkend="_lgc_8c_1a00546669316a08c1286570927e676496">findlast</link>(&amp;g-&gt;<link linkend="_structglobal___state_1a26a1a773fdf19f6aa0be08d5b8395c26">tobefnz</link>);
00964 &#32;&#32;<emphasis role="keywordflow">while</emphasis>&#32;((curr&#32;=&#32;*p)&#32;!=&#32;g-&gt;<link linkend="_structglobal___state_1a497482949c2da7caedb86741c6364395">finobjold1</link>)&#32;{&#32;&#32;<emphasis role="comment">/*&#32;traverse&#32;all&#32;finalizable&#32;objects&#32;*/</emphasis>
00965 &#32;&#32;&#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(<link linkend="_lgc_8h_1a6d17f226d57a796f7741f457400cf8bd">tofinalize</link>(curr));
00966 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(!(<link linkend="_lgc_8h_1a4c0ce78d476460d2e54914301f4a4bf7">iswhite</link>(curr)&#32;||&#32;all))&#32;&#32;<emphasis role="comment">/*&#32;not&#32;being&#32;collected?&#32;*/</emphasis>
00967 &#32;&#32;&#32;&#32;&#32;&#32;p&#32;=&#32;&amp;curr-&gt;next;&#32;&#32;<emphasis role="comment">/*&#32;don&apos;t&#32;bother&#32;with&#32;it&#32;*/</emphasis>
00968 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;{
00969 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(curr&#32;==&#32;g-&gt;<link linkend="_structglobal___state_1a81edc846b7bf03a2c636df88e04d9688">finobjsur</link>)&#32;&#32;<emphasis role="comment">/*&#32;removing&#32;&apos;finobjsur&apos;?&#32;*/</emphasis>
00970 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;g-&gt;<link linkend="_structglobal___state_1a81edc846b7bf03a2c636df88e04d9688">finobjsur</link>&#32;=&#32;curr-&gt;next;&#32;&#32;<emphasis role="comment">/*&#32;correct&#32;it&#32;*/</emphasis>
00971 &#32;&#32;&#32;&#32;&#32;&#32;*p&#32;=&#32;curr-&gt;next;&#32;&#32;<emphasis role="comment">/*&#32;remove&#32;&apos;curr&apos;&#32;from&#32;&apos;finobj&apos;&#32;list&#32;*/</emphasis>
00972 &#32;&#32;&#32;&#32;&#32;&#32;curr-&gt;next&#32;=&#32;*lastnext;&#32;&#32;<emphasis role="comment">/*&#32;link&#32;at&#32;the&#32;end&#32;of&#32;&apos;tobefnz&apos;&#32;list&#32;*/</emphasis>
00973 &#32;&#32;&#32;&#32;&#32;&#32;*lastnext&#32;=&#32;curr;
00974 &#32;&#32;&#32;&#32;&#32;&#32;lastnext&#32;=&#32;&amp;curr-&gt;next;
00975 &#32;&#32;&#32;&#32;}
00976 &#32;&#32;}
00977 }
00978 
00979 
00980 <emphasis role="comment">/*</emphasis>
00981 <emphasis role="comment">**&#32;If&#32;pointer&#32;&apos;p&apos;&#32;points&#32;to&#32;&apos;o&apos;,&#32;move&#32;it&#32;to&#32;the&#32;next&#32;element.</emphasis>
00982 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00983"/><link linkend="_lgc_8c_1a212c5bd6d46038d032294f4c53a7533e">00983</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a212c5bd6d46038d032294f4c53a7533e">checkpointer</link>&#32;(<link linkend="_struct_g_c_object">GCObject</link>&#32;**p,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*o)&#32;{
00984 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(o&#32;==&#32;*p)
00985 &#32;&#32;&#32;&#32;*p&#32;=&#32;o-&gt;next;
00986 }
00987 
00988 
00989 <emphasis role="comment">/*</emphasis>
00990 <emphasis role="comment">**&#32;Correct&#32;pointers&#32;to&#32;objects&#32;inside&#32;&apos;allgc&apos;&#32;list&#32;when</emphasis>
00991 <emphasis role="comment">**&#32;object&#32;&apos;o&apos;&#32;is&#32;being&#32;removed&#32;from&#32;the&#32;list.</emphasis>
00992 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l00993"/><link linkend="_lgc_8c_1a91d1c9f1242ce44318a52de3e549583e">00993</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a91d1c9f1242ce44318a52de3e549583e">correctpointers</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*o)&#32;{
00994 &#32;&#32;<link linkend="_lgc_8c_1a212c5bd6d46038d032294f4c53a7533e">checkpointer</link>(&amp;g-&gt;<link linkend="_structglobal___state_1a1162d3f249bfeebcf52bd0f70e0cc200">survival</link>,&#32;o);
00995 &#32;&#32;<link linkend="_lgc_8c_1a212c5bd6d46038d032294f4c53a7533e">checkpointer</link>(&amp;g-&gt;<link linkend="_structglobal___state_1a70eec2b8218810b4e2d880f1b9c0eedc">old1</link>,&#32;o);
00996 &#32;&#32;<link linkend="_lgc_8c_1a212c5bd6d46038d032294f4c53a7533e">checkpointer</link>(&amp;g-&gt;<link linkend="_structglobal___state_1abc84a52466de1f5c97cb7b16c88dbe95">reallyold</link>,&#32;o);
00997 &#32;&#32;<link linkend="_lgc_8c_1a212c5bd6d46038d032294f4c53a7533e">checkpointer</link>(&amp;g-&gt;<link linkend="_structglobal___state_1a531fb511fec0766c7a35ab1a0c3450cb">firstold1</link>,&#32;o);
00998 }
00999 
01000 
01001 <emphasis role="comment">/*</emphasis>
01002 <emphasis role="comment">**&#32;if&#32;object&#32;&apos;o&apos;&#32;has&#32;a&#32;finalizer,&#32;remove&#32;it&#32;from&#32;&apos;allgc&apos;&#32;list&#32;(must</emphasis>
01003 <emphasis role="comment">**&#32;search&#32;the&#32;list&#32;to&#32;find&#32;it)&#32;and&#32;link&#32;it&#32;in&#32;&apos;finobj&apos;&#32;list.</emphasis>
01004 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l01005"/><link linkend="_lgc_8h_1a15870c09448216ce5c4e1ff63d39e0a9">01005</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a0d4f5fb6a8831817e117cfff473aeb0e">luaC_checkfinalizer</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*o,&#32;<link linkend="_struct_table">Table</link>&#32;*mt)&#32;{
01006 &#32;&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g&#32;=&#32;<link linkend="_lstate_8h_1a103db2de6edf3420c6c6c9a282562406">G</link>(L);
01007 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8h_1a6d17f226d57a796f7741f457400cf8bd">tofinalize</link>(o)&#32;||&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;obj.&#32;is&#32;already&#32;marked...&#32;*/</emphasis>
01008 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_ltm_8h_1ab067446141992fa1bfa2f1ca720197fc">gfasttm</link>(g,&#32;mt,&#32;<link linkend="_ltm_8h_1a69e345ae253d250b61a03f1d6871c8d1a01e1b0be5e2785471e19db3665960536">TM_GC</link>)&#32;==&#32;NULL)&#32;&#32;&#32;<emphasis role="comment">/*&#32;or&#32;has&#32;no&#32;finalizer?&#32;*/</emphasis>
01009 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>;&#32;&#32;<emphasis role="comment">/*&#32;nothing&#32;to&#32;be&#32;done&#32;*/</emphasis>
01010 &#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;{&#32;&#32;<emphasis role="comment">/*&#32;move&#32;&apos;o&apos;&#32;to&#32;&apos;finobj&apos;&#32;list&#32;*/</emphasis>
01011 &#32;&#32;&#32;&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;**p;
01012 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8h_1a860db734bc919435aba75c30e4fe261b">issweepphase</link>(g))&#32;{
01013 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ada061b1d508c516b2e53f546521b3eeb">makewhite</link>(g,&#32;o);&#32;&#32;<emphasis role="comment">/*&#32;&quot;sweep&quot;&#32;object&#32;&apos;o&apos;&#32;*/</emphasis>
01014 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(g-&gt;<link linkend="_structglobal___state_1a6955215dfc015c08152e21f5f225e84a">sweepgc</link>&#32;==&#32;&amp;o-&gt;next)&#32;&#32;<emphasis role="comment">/*&#32;should&#32;not&#32;remove&#32;&apos;sweepgc&apos;&#32;object&#32;*/</emphasis>
01015 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;g-&gt;<link linkend="_structglobal___state_1a6955215dfc015c08152e21f5f225e84a">sweepgc</link>&#32;=&#32;<link linkend="_lgc_8c_1ab518b7adba50d2e796e206dbc96a9d52">sweeptolive</link>(L,&#32;g-&gt;<link linkend="_structglobal___state_1a6955215dfc015c08152e21f5f225e84a">sweepgc</link>);&#32;&#32;<emphasis role="comment">/*&#32;change&#32;&apos;sweepgc&apos;&#32;*/</emphasis>
01016 &#32;&#32;&#32;&#32;}
01017 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>
01018 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a91d1c9f1242ce44318a52de3e549583e">correctpointers</link>(g,&#32;o);
01019 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;search&#32;for&#32;pointer&#32;pointing&#32;to&#32;&apos;o&apos;&#32;*/</emphasis>
01020 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(p&#32;=&#32;&amp;g-&gt;<link linkend="_structglobal___state_1a3239e7c69845ec6df350dc5b6f1d5291">allgc</link>;&#32;*p&#32;!=&#32;o;&#32;p&#32;=&#32;&amp;(*p)-&gt;next)&#32;{&#32;<emphasis role="comment">/*&#32;empty&#32;*/</emphasis>&#32;}
01021 &#32;&#32;&#32;&#32;*p&#32;=&#32;o-&gt;next;&#32;&#32;<emphasis role="comment">/*&#32;remove&#32;&apos;o&apos;&#32;from&#32;&apos;allgc&apos;&#32;list&#32;*/</emphasis>
01022 &#32;&#32;&#32;&#32;o-&gt;next&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a7c1118954ba5fdca801f48c9242c1a23">finobj</link>;&#32;&#32;<emphasis role="comment">/*&#32;link&#32;it&#32;in&#32;&apos;finobj&apos;&#32;list&#32;*/</emphasis>
01023 &#32;&#32;&#32;&#32;g-&gt;<link linkend="_structglobal___state_1a7c1118954ba5fdca801f48c9242c1a23">finobj</link>&#32;=&#32;o;
01024 &#32;&#32;&#32;&#32;<link linkend="_lgc_8h_1aad559b25ee580ea2894c540dc817e41f">l_setbit</link>(o-&gt;marked,&#32;<link linkend="_lgc_8h_1a92211ad01420ac616819ba8f61ca7365">FINALIZEDBIT</link>);&#32;&#32;<emphasis role="comment">/*&#32;mark&#32;it&#32;as&#32;such&#32;*/</emphasis>
01025 &#32;&#32;}
01026 }
01027 
01028 <emphasis role="comment">/*&#32;}======================================================&#32;*/</emphasis>
01029 
01030 
01031 <emphasis role="comment">/*</emphasis>
01032 <emphasis role="comment">**&#32;{======================================================</emphasis>
01033 <emphasis role="comment">**&#32;Generational&#32;Collector</emphasis>
01034 <emphasis role="comment">**&#32;=======================================================</emphasis>
01035 <emphasis role="comment">*/</emphasis>
01036 
01037 <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1ab1a2b0658321a52d5ae0c139b0bf5494">setpause</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g);
01038 
01039 
01040 <emphasis role="comment">/*</emphasis>
01041 <emphasis role="comment">**&#32;Sweep&#32;a&#32;list&#32;of&#32;objects&#32;to&#32;enter&#32;generational&#32;mode.&#32;&#32;Deletes&#32;dead</emphasis>
01042 <emphasis role="comment">**&#32;objects&#32;and&#32;turns&#32;the&#32;non&#32;dead&#32;to&#32;old.&#32;All&#32;non-dead&#32;threads---which</emphasis>
01043 <emphasis role="comment">**&#32;are&#32;now&#32;old---must&#32;be&#32;in&#32;a&#32;gray&#32;list.&#32;Everything&#32;else&#32;is&#32;not&#32;in&#32;a</emphasis>
01044 <emphasis role="comment">**&#32;gray&#32;list.&#32;Open&#32;upvalues&#32;are&#32;also&#32;kept&#32;gray.</emphasis>
01045 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l01046"/><link linkend="_lgc_8c_1a85b353f49bd76eb0199fa5966ee37895">01046</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a85b353f49bd76eb0199fa5966ee37895">sweep2old</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;**p)&#32;{
01047 &#32;&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*curr;
01048 &#32;&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g&#32;=&#32;<link linkend="_lstate_8h_1a103db2de6edf3420c6c6c9a282562406">G</link>(L);
01049 &#32;&#32;<emphasis role="keywordflow">while</emphasis>&#32;((curr&#32;=&#32;*p)&#32;!=&#32;NULL)&#32;{
01050 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8h_1a4c0ce78d476460d2e54914301f4a4bf7">iswhite</link>(curr))&#32;{&#32;&#32;<emphasis role="comment">/*&#32;is&#32;&apos;curr&apos;&#32;dead?&#32;*/</emphasis>
01051 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(<link linkend="_lgc_8h_1acc409eb45f598d23d8388fc9e96189ea">isdead</link>(g,&#32;curr));
01052 &#32;&#32;&#32;&#32;&#32;&#32;*p&#32;=&#32;curr-&gt;next;&#32;&#32;<emphasis role="comment">/*&#32;remove&#32;&apos;curr&apos;&#32;from&#32;list&#32;*/</emphasis>
01053 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1aa198d7da2a8502ed70adfe1f7ed38f46">freeobj</link>(L,&#32;curr);&#32;&#32;<emphasis role="comment">/*&#32;erase&#32;&apos;curr&apos;&#32;*/</emphasis>
01054 &#32;&#32;&#32;&#32;}
01055 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;{&#32;&#32;<emphasis role="comment">/*&#32;all&#32;surviving&#32;objects&#32;become&#32;old&#32;*/</emphasis>
01056 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8h_1a42f07cc5f8f0a9d97989f7769f00c3f2">setage</link>(curr,&#32;<link linkend="_lgc_8h_1a96372e9b92aa939f300e0477ba112716">G_OLD</link>);
01057 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(curr-&gt;tt&#32;==&#32;<link linkend="_lobject_8h_1ad224258ccc4e8f79f148d54d32ddbd00">LUA_VTHREAD</link>)&#32;{&#32;&#32;<emphasis role="comment">/*&#32;threads&#32;must&#32;be&#32;watched&#32;*/</emphasis>
01058 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_structlua___state">lua_State</link>&#32;*th&#32;=&#32;<link linkend="_lstate_8h_1a52c467e11bd40cad5ca78372f7f67b4d">gco2th</link>(curr);
01059 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ad63f9d59a67a756d3c3540d9795cdcbe">linkgclist</link>(th,&#32;g-&gt;<link linkend="_structglobal___state_1af6b3198325143bc0a9a529e9b14ff29a">grayagain</link>);&#32;&#32;<emphasis role="comment">/*&#32;insert&#32;into&#32;&apos;grayagain&apos;&#32;list&#32;*/</emphasis>
01060 &#32;&#32;&#32;&#32;&#32;&#32;}
01061 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;<emphasis role="keywordflow">if</emphasis>&#32;(curr-&gt;tt&#32;==&#32;<link linkend="_lobject_8h_1ae982db94518ed52587579ed70d822ad5">LUA_VUPVAL</link>&#32;&amp;&amp;&#32;<link linkend="_lfunc_8h_1a26a8ecd7d58d326f7f6f20bc8bc8bb55">upisopen</link>(<link linkend="_lstate_8h_1a1633a3ec133e64956014aafd04e31cce">gco2upv</link>(curr)))
01062 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ac0d91118389ea51c074e2baf41e03ccb">set2gray</link>(curr);&#32;&#32;<emphasis role="comment">/*&#32;open&#32;upvalues&#32;are&#32;always&#32;gray&#32;*/</emphasis>
01063 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;&#32;<emphasis role="comment">/*&#32;everything&#32;else&#32;is&#32;black&#32;*/</emphasis>
01064 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8h_1a990de0d171d8b5425a5515d0bff78789">nw2black</link>(curr);
01065 &#32;&#32;&#32;&#32;&#32;&#32;p&#32;=&#32;&amp;curr-&gt;next;&#32;&#32;<emphasis role="comment">/*&#32;go&#32;to&#32;next&#32;element&#32;*/</emphasis>
01066 &#32;&#32;&#32;&#32;}
01067 &#32;&#32;}
01068 }
01069 
01070 
01071 <emphasis role="comment">/*</emphasis>
01072 <emphasis role="comment">**&#32;Sweep&#32;for&#32;generational&#32;mode.&#32;Delete&#32;dead&#32;objects.&#32;(Because&#32;the</emphasis>
01073 <emphasis role="comment">**&#32;collection&#32;is&#32;not&#32;incremental,&#32;there&#32;are&#32;no&#32;&quot;new&#32;white&quot;&#32;objects</emphasis>
01074 <emphasis role="comment">**&#32;during&#32;the&#32;sweep.&#32;So,&#32;any&#32;white&#32;object&#32;must&#32;be&#32;dead.)&#32;For</emphasis>
01075 <emphasis role="comment">**&#32;non-dead&#32;objects,&#32;advance&#32;their&#32;ages&#32;and&#32;clear&#32;the&#32;color&#32;of</emphasis>
01076 <emphasis role="comment">**&#32;new&#32;objects.&#32;(Old&#32;objects&#32;keep&#32;their&#32;colors.)</emphasis>
01077 <emphasis role="comment">**&#32;The&#32;ages&#32;of&#32;G_TOUCHED1&#32;and&#32;G_TOUCHED2&#32;objects&#32;cannot&#32;be&#32;advanced</emphasis>
01078 <emphasis role="comment">**&#32;here,&#32;because&#32;these&#32;old-generation&#32;objects&#32;are&#32;usually&#32;not&#32;swept</emphasis>
01079 <emphasis role="comment">**&#32;here.&#32;&#32;They&#32;will&#32;all&#32;be&#32;advanced&#32;in&#32;&apos;correctgraylist&apos;.&#32;That&#32;function</emphasis>
01080 <emphasis role="comment">**&#32;will&#32;also&#32;remove&#32;objects&#32;turned&#32;white&#32;here&#32;from&#32;any&#32;gray&#32;list.</emphasis>
01081 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l01082"/><link linkend="_lgc_8c_1ad2640fd798d0468b3832b8b64f1c94f1">01082</link> <emphasis role="keyword">static</emphasis>&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;**<link linkend="_lgc_8c_1ad2640fd798d0468b3832b8b64f1c94f1">sweepgen</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;**p,
01083 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*limit,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;**pfirstold1)&#32;{
01084 &#32;&#32;<emphasis role="keyword">static</emphasis>&#32;<emphasis role="keyword">const</emphasis>&#32;<link linkend="_llimits_8h_1ae1fe9ac10d9803bd1d7bdf30b18bad68">lu_byte</link>&#32;nextage[]&#32;=&#32;{
01085 &#32;&#32;&#32;&#32;<link linkend="_lgc_8h_1aa8c9510ab591432a3b80e90519156116">G_SURVIVAL</link>,&#32;&#32;<emphasis role="comment">/*&#32;from&#32;G_NEW&#32;*/</emphasis>
01086 &#32;&#32;&#32;&#32;<link linkend="_lgc_8h_1a266a8ec4a8dbacf8d7b99dca3adcac90">G_OLD1</link>,&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;from&#32;G_SURVIVAL&#32;*/</emphasis>
01087 &#32;&#32;&#32;&#32;<link linkend="_lgc_8h_1a266a8ec4a8dbacf8d7b99dca3adcac90">G_OLD1</link>,&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;from&#32;G_OLD0&#32;*/</emphasis>
01088 &#32;&#32;&#32;&#32;<link linkend="_lgc_8h_1a96372e9b92aa939f300e0477ba112716">G_OLD</link>,&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;from&#32;G_OLD1&#32;*/</emphasis>
01089 &#32;&#32;&#32;&#32;<link linkend="_lgc_8h_1a96372e9b92aa939f300e0477ba112716">G_OLD</link>,&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;from&#32;G_OLD&#32;(do&#32;not&#32;change)&#32;*/</emphasis>
01090 &#32;&#32;&#32;&#32;<link linkend="_lgc_8h_1ae2c1796f4fb3359730723ce0acd2d162">G_TOUCHED1</link>,&#32;&#32;<emphasis role="comment">/*&#32;from&#32;G_TOUCHED1&#32;(do&#32;not&#32;change)&#32;*/</emphasis>
01091 &#32;&#32;&#32;&#32;<link linkend="_lgc_8h_1ac2b8a2255c79c9f43f88d1625767e1bf">G_TOUCHED2</link>&#32;&#32;&#32;<emphasis role="comment">/*&#32;from&#32;G_TOUCHED2&#32;(do&#32;not&#32;change)&#32;*/</emphasis>
01092 &#32;&#32;};
01093 &#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;white&#32;=&#32;<link linkend="_lgc_8h_1afaa8a52c4097cf3a5eacd88db94092da">luaC_white</link>(g);
01094 &#32;&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*curr;
01095 &#32;&#32;<emphasis role="keywordflow">while</emphasis>&#32;((curr&#32;=&#32;*p)&#32;!=&#32;limit)&#32;{
01096 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8h_1a4c0ce78d476460d2e54914301f4a4bf7">iswhite</link>(curr))&#32;{&#32;&#32;<emphasis role="comment">/*&#32;is&#32;&apos;curr&apos;&#32;dead?&#32;*/</emphasis>
01097 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(!<link linkend="_lgc_8h_1a24d47e523ecf2d6e475a34913ce06b05">isold</link>(curr)&#32;&amp;&amp;&#32;<link linkend="_lgc_8h_1acc409eb45f598d23d8388fc9e96189ea">isdead</link>(g,&#32;curr));
01098 &#32;&#32;&#32;&#32;&#32;&#32;*p&#32;=&#32;curr-&gt;next;&#32;&#32;<emphasis role="comment">/*&#32;remove&#32;&apos;curr&apos;&#32;from&#32;list&#32;*/</emphasis>
01099 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1aa198d7da2a8502ed70adfe1f7ed38f46">freeobj</link>(L,&#32;curr);&#32;&#32;<emphasis role="comment">/*&#32;erase&#32;&apos;curr&apos;&#32;*/</emphasis>
01100 &#32;&#32;&#32;&#32;}
01101 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;{&#32;&#32;<emphasis role="comment">/*&#32;correct&#32;mark&#32;and&#32;age&#32;*/</emphasis>
01102 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8h_1ae68465c1574c4b45a05a6548ad934235">getage</link>(curr)&#32;==&#32;<link linkend="_lgc_8h_1a611544eedb63012098eab46a011fe618">G_NEW</link>)&#32;{&#32;&#32;<emphasis role="comment">/*&#32;new&#32;objects&#32;go&#32;back&#32;to&#32;white&#32;*/</emphasis>
01103 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;marked&#32;=&#32;curr-&gt;marked&#32;&amp;&#32;~<link linkend="_lgc_8c_1a3ea4c714396849e66d63d88a8987f149">maskgcbits</link>;&#32;&#32;<emphasis role="comment">/*&#32;erase&#32;GC&#32;bits&#32;*/</emphasis>
01104 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;curr-&gt;marked&#32;=&#32;<link linkend="_llimits_8h_1a596f5b6e992f53a5a4e5732083448dd4">cast_byte</link>(marked&#32;|&#32;<link linkend="_lgc_8h_1aa8c9510ab591432a3b80e90519156116">G_SURVIVAL</link>&#32;|&#32;white);
01105 &#32;&#32;&#32;&#32;&#32;&#32;}
01106 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;{&#32;&#32;<emphasis role="comment">/*&#32;all&#32;other&#32;objects&#32;will&#32;be&#32;old,&#32;and&#32;so&#32;keep&#32;their&#32;color&#32;*/</emphasis>
01107 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8h_1a42f07cc5f8f0a9d97989f7769f00c3f2">setage</link>(curr,&#32;nextage[<link linkend="_lgc_8h_1ae68465c1574c4b45a05a6548ad934235">getage</link>(curr)]);
01108 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8h_1ae68465c1574c4b45a05a6548ad934235">getage</link>(curr)&#32;==&#32;<link linkend="_lgc_8h_1a266a8ec4a8dbacf8d7b99dca3adcac90">G_OLD1</link>&#32;&amp;&amp;&#32;*pfirstold1&#32;==&#32;NULL)
01109 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;*pfirstold1&#32;=&#32;curr;&#32;&#32;<emphasis role="comment">/*&#32;first&#32;OLD1&#32;object&#32;in&#32;the&#32;list&#32;*/</emphasis>
01110 &#32;&#32;&#32;&#32;&#32;&#32;}
01111 &#32;&#32;&#32;&#32;&#32;&#32;p&#32;=&#32;&amp;curr-&gt;next;&#32;&#32;<emphasis role="comment">/*&#32;go&#32;to&#32;next&#32;element&#32;*/</emphasis>
01112 &#32;&#32;&#32;&#32;}
01113 &#32;&#32;}
01114 &#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;p;
01115 }
01116 
01117 
01118 <emphasis role="comment">/*</emphasis>
01119 <emphasis role="comment">**&#32;Traverse&#32;a&#32;list&#32;making&#32;all&#32;its&#32;elements&#32;white&#32;and&#32;clearing&#32;their</emphasis>
01120 <emphasis role="comment">**&#32;age.&#32;In&#32;incremental&#32;mode,&#32;all&#32;objects&#32;are&#32;&apos;new&apos;&#32;all&#32;the&#32;time,</emphasis>
01121 <emphasis role="comment">**&#32;except&#32;for&#32;fixed&#32;strings&#32;(which&#32;are&#32;always&#32;old).</emphasis>
01122 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l01123"/><link linkend="_lgc_8c_1a7bb7ff4928b82e65d5844fcaca7d59d8">01123</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a7bb7ff4928b82e65d5844fcaca7d59d8">whitelist</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*p)&#32;{
01124 &#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;white&#32;=&#32;<link linkend="_lgc_8h_1afaa8a52c4097cf3a5eacd88db94092da">luaC_white</link>(g);
01125 &#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(;&#32;p&#32;!=&#32;NULL;&#32;p&#32;=&#32;p-&gt;next)
01126 &#32;&#32;&#32;&#32;p-&gt;marked&#32;=&#32;<link linkend="_llimits_8h_1a596f5b6e992f53a5a4e5732083448dd4">cast_byte</link>((p-&gt;marked&#32;&amp;&#32;~<link linkend="_lgc_8c_1a3ea4c714396849e66d63d88a8987f149">maskgcbits</link>)&#32;|&#32;white);
01127 }
01128 
01129 
01130 <emphasis role="comment">/*</emphasis>
01131 <emphasis role="comment">**&#32;Correct&#32;a&#32;list&#32;of&#32;gray&#32;objects.&#32;Return&#32;pointer&#32;to&#32;where&#32;rest&#32;of&#32;the</emphasis>
01132 <emphasis role="comment">**&#32;list&#32;should&#32;be&#32;linked.</emphasis>
01133 <emphasis role="comment">**&#32;Because&#32;this&#32;correction&#32;is&#32;done&#32;after&#32;sweeping,&#32;young&#32;objects&#32;might</emphasis>
01134 <emphasis role="comment">**&#32;be&#32;turned&#32;white&#32;and&#32;still&#32;be&#32;in&#32;the&#32;list.&#32;They&#32;are&#32;only&#32;removed.</emphasis>
01135 <emphasis role="comment">**&#32;&apos;TOUCHED1&apos;&#32;objects&#32;are&#32;advanced&#32;to&#32;&apos;TOUCHED2&apos;&#32;and&#32;remain&#32;on&#32;the&#32;list;</emphasis>
01136 <emphasis role="comment">**&#32;Non-white&#32;threads&#32;also&#32;remain&#32;on&#32;the&#32;list;&#32;&apos;TOUCHED2&apos;&#32;objects&#32;become</emphasis>
01137 <emphasis role="comment">**&#32;regular&#32;old;&#32;they&#32;and&#32;anything&#32;else&#32;are&#32;removed&#32;from&#32;the&#32;list.</emphasis>
01138 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l01139"/><link linkend="_lgc_8c_1af7188b6e4cd31e997c857b6e010a6d4a">01139</link> <emphasis role="keyword">static</emphasis>&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;**<link linkend="_lgc_8c_1af7188b6e4cd31e997c857b6e010a6d4a">correctgraylist</link>&#32;(<link linkend="_struct_g_c_object">GCObject</link>&#32;**p)&#32;{
01140 &#32;&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*curr;
01141 &#32;&#32;<emphasis role="keywordflow">while</emphasis>&#32;((curr&#32;=&#32;*p)&#32;!=&#32;NULL)&#32;{
01142 &#32;&#32;&#32;&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;**<link linkend="_llex_8c_1a8ab976102fb046f9974c53caaf5a1995">next</link>&#32;=&#32;<link linkend="_lgc_8c_1a10a95d9a52dbdb6f36c090f5e2870007">getgclist</link>(curr);
01143 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8h_1a4c0ce78d476460d2e54914301f4a4bf7">iswhite</link>(curr))
01144 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">goto</emphasis>&#32;remove;&#32;&#32;<emphasis role="comment">/*&#32;remove&#32;all&#32;white&#32;objects&#32;*/</emphasis>
01145 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8h_1ae68465c1574c4b45a05a6548ad934235">getage</link>(curr)&#32;==&#32;<link linkend="_lgc_8h_1ae2c1796f4fb3359730723ce0acd2d162">G_TOUCHED1</link>)&#32;{&#32;&#32;<emphasis role="comment">/*&#32;touched&#32;in&#32;this&#32;cycle?&#32;*/</emphasis>
01146 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(<link linkend="_lgc_8h_1ad417e22072630b33cf74a3055b27d8d7">isgray</link>(curr));
01147 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8h_1a990de0d171d8b5425a5515d0bff78789">nw2black</link>(curr);&#32;&#32;<emphasis role="comment">/*&#32;make&#32;it&#32;black,&#32;for&#32;next&#32;barrier&#32;*/</emphasis>
01148 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8h_1a61d44df5c26bb4efcf4e19b500933bbb">changeage</link>(curr,&#32;<link linkend="_lgc_8h_1ae2c1796f4fb3359730723ce0acd2d162">G_TOUCHED1</link>,&#32;<link linkend="_lgc_8h_1ac2b8a2255c79c9f43f88d1625767e1bf">G_TOUCHED2</link>);
01149 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">goto</emphasis>&#32;remain;&#32;&#32;<emphasis role="comment">/*&#32;keep&#32;it&#32;in&#32;the&#32;list&#32;and&#32;go&#32;to&#32;next&#32;element&#32;*/</emphasis>
01150 &#32;&#32;&#32;&#32;}
01151 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;<emphasis role="keywordflow">if</emphasis>&#32;(curr-&gt;tt&#32;==&#32;<link linkend="_lobject_8h_1ad224258ccc4e8f79f148d54d32ddbd00">LUA_VTHREAD</link>)&#32;{
01152 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(<link linkend="_lgc_8h_1ad417e22072630b33cf74a3055b27d8d7">isgray</link>(curr));
01153 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">goto</emphasis>&#32;remain;&#32;&#32;<emphasis role="comment">/*&#32;keep&#32;non-white&#32;threads&#32;on&#32;the&#32;list&#32;*/</emphasis>
01154 &#32;&#32;&#32;&#32;}
01155 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;{&#32;&#32;<emphasis role="comment">/*&#32;everything&#32;else&#32;is&#32;removed&#32;*/</emphasis>
01156 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(<link linkend="_lgc_8h_1a24d47e523ecf2d6e475a34913ce06b05">isold</link>(curr));&#32;&#32;<emphasis role="comment">/*&#32;young&#32;objects&#32;should&#32;be&#32;white&#32;here&#32;*/</emphasis>
01157 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8h_1ae68465c1574c4b45a05a6548ad934235">getage</link>(curr)&#32;==&#32;<link linkend="_lgc_8h_1ac2b8a2255c79c9f43f88d1625767e1bf">G_TOUCHED2</link>)&#32;&#32;<emphasis role="comment">/*&#32;advance&#32;from&#32;TOUCHED2...&#32;*/</emphasis>
01158 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8h_1a61d44df5c26bb4efcf4e19b500933bbb">changeage</link>(curr,&#32;<link linkend="_lgc_8h_1ac2b8a2255c79c9f43f88d1625767e1bf">G_TOUCHED2</link>,&#32;<link linkend="_lgc_8h_1a96372e9b92aa939f300e0477ba112716">G_OLD</link>);&#32;&#32;<emphasis role="comment">/*&#32;...&#32;to&#32;OLD&#32;*/</emphasis>
01159 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8h_1a990de0d171d8b5425a5515d0bff78789">nw2black</link>(curr);&#32;&#32;<emphasis role="comment">/*&#32;make&#32;object&#32;black&#32;(to&#32;be&#32;removed)&#32;*/</emphasis>
01160 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">goto</emphasis>&#32;remove;
01161 &#32;&#32;&#32;&#32;}
01162 &#32;&#32;&#32;&#32;remove:&#32;*p&#32;=&#32;*<link linkend="_llex_8c_1a8ab976102fb046f9974c53caaf5a1995">next</link>;&#32;<emphasis role="keywordflow">continue</emphasis>;
01163 &#32;&#32;&#32;&#32;remain:&#32;p&#32;=&#32;<link linkend="_llex_8c_1a8ab976102fb046f9974c53caaf5a1995">next</link>;&#32;<emphasis role="keywordflow">continue</emphasis>;
01164 &#32;&#32;}
01165 &#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;p;
01166 }
01167 
01168 
01169 <emphasis role="comment">/*</emphasis>
01170 <emphasis role="comment">**&#32;Correct&#32;all&#32;gray&#32;lists,&#32;coalescing&#32;them&#32;into&#32;&apos;grayagain&apos;.</emphasis>
01171 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l01172"/><link linkend="_lgc_8c_1a528264d2f4073b4a22b7844098a36f7d">01172</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a528264d2f4073b4a22b7844098a36f7d">correctgraylists</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g)&#32;{
01173 &#32;&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;**list&#32;=&#32;<link linkend="_lgc_8c_1af7188b6e4cd31e997c857b6e010a6d4a">correctgraylist</link>(&amp;g-&gt;<link linkend="_structglobal___state_1af6b3198325143bc0a9a529e9b14ff29a">grayagain</link>);
01174 &#32;&#32;*list&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a26d09b5385bf38c15ca56a9e44b5ef6d">weak</link>;&#32;g-&gt;<link linkend="_structglobal___state_1a26d09b5385bf38c15ca56a9e44b5ef6d">weak</link>&#32;=&#32;NULL;
01175 &#32;&#32;list&#32;=&#32;<link linkend="_lgc_8c_1af7188b6e4cd31e997c857b6e010a6d4a">correctgraylist</link>(list);
01176 &#32;&#32;*list&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a97f9bda9b7e1f18bb0c68608e6609c89">allweak</link>;&#32;g-&gt;<link linkend="_structglobal___state_1a97f9bda9b7e1f18bb0c68608e6609c89">allweak</link>&#32;=&#32;NULL;
01177 &#32;&#32;list&#32;=&#32;<link linkend="_lgc_8c_1af7188b6e4cd31e997c857b6e010a6d4a">correctgraylist</link>(list);
01178 &#32;&#32;*list&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1aac8b3202114d8c99a73328fff0c3c79c">ephemeron</link>;&#32;g-&gt;<link linkend="_structglobal___state_1aac8b3202114d8c99a73328fff0c3c79c">ephemeron</link>&#32;=&#32;NULL;
01179 &#32;&#32;<link linkend="_lgc_8c_1af7188b6e4cd31e997c857b6e010a6d4a">correctgraylist</link>(list);
01180 }
01181 
01182 
01183 <emphasis role="comment">/*</emphasis>
01184 <emphasis role="comment">**&#32;Mark&#32;black&#32;&apos;OLD1&apos;&#32;objects&#32;when&#32;starting&#32;a&#32;new&#32;young&#32;collection.</emphasis>
01185 <emphasis role="comment">**&#32;Gray&#32;objects&#32;are&#32;already&#32;in&#32;some&#32;gray&#32;list,&#32;and&#32;so&#32;will&#32;be&#32;visited</emphasis>
01186 <emphasis role="comment">**&#32;in&#32;the&#32;atomic&#32;step.</emphasis>
01187 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l01188"/><link linkend="_lgc_8c_1ae4013fea3c735a4c2802a6adf08e4b3c">01188</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1ae4013fea3c735a4c2802a6adf08e4b3c">markold</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*from,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*to)&#32;{
01189 &#32;&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*p;
01190 &#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(p&#32;=&#32;from;&#32;p&#32;!=&#32;to;&#32;p&#32;=&#32;p-&gt;next)&#32;{
01191 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8h_1ae68465c1574c4b45a05a6548ad934235">getage</link>(p)&#32;==&#32;<link linkend="_lgc_8h_1a266a8ec4a8dbacf8d7b99dca3adcac90">G_OLD1</link>)&#32;{
01192 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(!<link linkend="_lgc_8h_1a4c0ce78d476460d2e54914301f4a4bf7">iswhite</link>(p));
01193 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8h_1a61d44df5c26bb4efcf4e19b500933bbb">changeage</link>(p,&#32;<link linkend="_lgc_8h_1a266a8ec4a8dbacf8d7b99dca3adcac90">G_OLD1</link>,&#32;<link linkend="_lgc_8h_1a96372e9b92aa939f300e0477ba112716">G_OLD</link>);&#32;&#32;<emphasis role="comment">/*&#32;now&#32;they&#32;are&#32;old&#32;*/</emphasis>
01194 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8h_1ac1e4847ad9a91e4cea36520dc9078365">isblack</link>(p))
01195 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1aacf3c8ee0eebd5d5b1cd09da000ad53c">reallymarkobject</link>(g,&#32;p);
01196 &#32;&#32;&#32;&#32;}
01197 &#32;&#32;}
01198 }
01199 
01200 
01201 <emphasis role="comment">/*</emphasis>
01202 <emphasis role="comment">**&#32;Finish&#32;a&#32;young-generation&#32;collection.</emphasis>
01203 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l01204"/><link linkend="_lgc_8c_1ad14690f3e78fd31ce7eddc3acdbeec5b">01204</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1ad14690f3e78fd31ce7eddc3acdbeec5b">finishgencycle</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g)&#32;{
01205 &#32;&#32;<link linkend="_lgc_8c_1a528264d2f4073b4a22b7844098a36f7d">correctgraylists</link>(g);
01206 &#32;&#32;<link linkend="_lgc_8c_1a1b2909449f815733deb4bc35c0103002">checkSizes</link>(L,&#32;g);
01207 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1aec22885c483e649f2d65368c3507cd9a">gcstate</link>&#32;=&#32;<link linkend="_lgc_8h_1a2ed301793747f3a2d0a7fc7d64d482fd">GCSpropagate</link>;&#32;&#32;<emphasis role="comment">/*&#32;skip&#32;restart&#32;*/</emphasis>
01208 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(!g-&gt;<link linkend="_structglobal___state_1ae6cc757dac1c965fb147c2886d48e1fa">gcemergency</link>)
01209 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a3c6f43e1b63924361ed0ce31b6d30f8b">callallpendingfinalizers</link>(L);
01210 }
01211 
01212 
01213 <emphasis role="comment">/*</emphasis>
01214 <emphasis role="comment">**&#32;Does&#32;a&#32;young&#32;collection.&#32;First,&#32;mark&#32;&apos;OLD1&apos;&#32;objects.&#32;Then&#32;does&#32;the</emphasis>
01215 <emphasis role="comment">**&#32;atomic&#32;step.&#32;Then,&#32;sweep&#32;all&#32;lists&#32;and&#32;advance&#32;pointers.&#32;Finally,</emphasis>
01216 <emphasis role="comment">**&#32;finish&#32;the&#32;collection.</emphasis>
01217 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l01218"/><link linkend="_lgc_8c_1a7528878b4bb9da15db0a23fab038a339">01218</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a7528878b4bb9da15db0a23fab038a339">youngcollection</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g)&#32;{
01219 &#32;&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;**psurvival;&#32;&#32;<emphasis role="comment">/*&#32;to&#32;point&#32;to&#32;first&#32;non-dead&#32;survival&#32;object&#32;*/</emphasis>
01220 &#32;&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*<link linkend="_lstrlib_8c_1a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</link>;&#32;&#32;<emphasis role="comment">/*&#32;dummy&#32;out&#32;parameter&#32;to&#32;&apos;sweepgen&apos;&#32;*/</emphasis>
01221 &#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(g-&gt;<link linkend="_structglobal___state_1aec22885c483e649f2d65368c3507cd9a">gcstate</link>&#32;==&#32;<link linkend="_lgc_8h_1a2ed301793747f3a2d0a7fc7d64d482fd">GCSpropagate</link>);
01222 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(g-&gt;<link linkend="_structglobal___state_1a531fb511fec0766c7a35ab1a0c3450cb">firstold1</link>)&#32;{&#32;&#32;<emphasis role="comment">/*&#32;are&#32;there&#32;regular&#32;OLD1&#32;objects?&#32;*/</emphasis>
01223 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ae4013fea3c735a4c2802a6adf08e4b3c">markold</link>(g,&#32;g-&gt;<link linkend="_structglobal___state_1a531fb511fec0766c7a35ab1a0c3450cb">firstold1</link>,&#32;g-&gt;<link linkend="_structglobal___state_1abc84a52466de1f5c97cb7b16c88dbe95">reallyold</link>);&#32;&#32;<emphasis role="comment">/*&#32;mark&#32;them&#32;*/</emphasis>
01224 &#32;&#32;&#32;&#32;g-&gt;<link linkend="_structglobal___state_1a531fb511fec0766c7a35ab1a0c3450cb">firstold1</link>&#32;=&#32;NULL;&#32;&#32;<emphasis role="comment">/*&#32;no&#32;more&#32;OLD1&#32;objects&#32;(for&#32;now)&#32;*/</emphasis>
01225 &#32;&#32;}
01226 &#32;&#32;<link linkend="_lgc_8c_1ae4013fea3c735a4c2802a6adf08e4b3c">markold</link>(g,&#32;g-&gt;<link linkend="_structglobal___state_1a7c1118954ba5fdca801f48c9242c1a23">finobj</link>,&#32;g-&gt;<link linkend="_structglobal___state_1a55ebc92b222c1b8367c3e0e8a36f4bd6">finobjrold</link>);
01227 &#32;&#32;<link linkend="_lgc_8c_1ae4013fea3c735a4c2802a6adf08e4b3c">markold</link>(g,&#32;g-&gt;<link linkend="_structglobal___state_1a26a1a773fdf19f6aa0be08d5b8395c26">tobefnz</link>,&#32;NULL);
01228 &#32;&#32;<link linkend="_lgc_8c_1a41eded2c85eaf7e1911cd95da36882d9">atomic</link>(L);
01229 
01230 &#32;&#32;<emphasis role="comment">/*&#32;sweep&#32;nursery&#32;and&#32;get&#32;a&#32;pointer&#32;to&#32;its&#32;last&#32;live&#32;element&#32;*/</emphasis>
01231 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1aec22885c483e649f2d65368c3507cd9a">gcstate</link>&#32;=&#32;<link linkend="_lgc_8h_1aac9b5b472434aa8d38a89b46b6b29196">GCSswpallgc</link>;
01232 &#32;&#32;psurvival&#32;=&#32;<link linkend="_lgc_8c_1ad2640fd798d0468b3832b8b64f1c94f1">sweepgen</link>(L,&#32;g,&#32;&amp;g-&gt;<link linkend="_structglobal___state_1a3239e7c69845ec6df350dc5b6f1d5291">allgc</link>,&#32;g-&gt;<link linkend="_structglobal___state_1a1162d3f249bfeebcf52bd0f70e0cc200">survival</link>,&#32;&amp;g-&gt;<link linkend="_structglobal___state_1a531fb511fec0766c7a35ab1a0c3450cb">firstold1</link>);
01233 &#32;&#32;<emphasis role="comment">/*&#32;sweep&#32;&apos;survival&apos;&#32;*/</emphasis>
01234 &#32;&#32;<link linkend="_lgc_8c_1ad2640fd798d0468b3832b8b64f1c94f1">sweepgen</link>(L,&#32;g,&#32;psurvival,&#32;g-&gt;<link linkend="_structglobal___state_1a70eec2b8218810b4e2d880f1b9c0eedc">old1</link>,&#32;&amp;g-&gt;<link linkend="_structglobal___state_1a531fb511fec0766c7a35ab1a0c3450cb">firstold1</link>);
01235 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1abc84a52466de1f5c97cb7b16c88dbe95">reallyold</link>&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a70eec2b8218810b4e2d880f1b9c0eedc">old1</link>;
01236 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1a70eec2b8218810b4e2d880f1b9c0eedc">old1</link>&#32;=&#32;*psurvival;&#32;&#32;<emphasis role="comment">/*&#32;&apos;survival&apos;&#32;survivals&#32;are&#32;old&#32;now&#32;*/</emphasis>
01237 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1a1162d3f249bfeebcf52bd0f70e0cc200">survival</link>&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a3239e7c69845ec6df350dc5b6f1d5291">allgc</link>;&#32;&#32;<emphasis role="comment">/*&#32;all&#32;news&#32;are&#32;survivals&#32;*/</emphasis>
01238 
01239 &#32;&#32;<emphasis role="comment">/*&#32;repeat&#32;for&#32;&apos;finobj&apos;&#32;lists&#32;*/</emphasis>
01240 &#32;&#32;<link linkend="_lstrlib_8c_1a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</link>&#32;=&#32;NULL;&#32;&#32;<emphasis role="comment">/*&#32;no&#32;&apos;firstold1&apos;&#32;optimization&#32;for&#32;&apos;finobj&apos;&#32;lists&#32;*/</emphasis>
01241 &#32;&#32;psurvival&#32;=&#32;<link linkend="_lgc_8c_1ad2640fd798d0468b3832b8b64f1c94f1">sweepgen</link>(L,&#32;g,&#32;&amp;g-&gt;<link linkend="_structglobal___state_1a7c1118954ba5fdca801f48c9242c1a23">finobj</link>,&#32;g-&gt;<link linkend="_structglobal___state_1a81edc846b7bf03a2c636df88e04d9688">finobjsur</link>,&#32;&amp;<link linkend="_lstrlib_8c_1a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</link>);
01242 &#32;&#32;<emphasis role="comment">/*&#32;sweep&#32;&apos;survival&apos;&#32;*/</emphasis>
01243 &#32;&#32;<link linkend="_lgc_8c_1ad2640fd798d0468b3832b8b64f1c94f1">sweepgen</link>(L,&#32;g,&#32;psurvival,&#32;g-&gt;<link linkend="_structglobal___state_1a497482949c2da7caedb86741c6364395">finobjold1</link>,&#32;&amp;<link linkend="_lstrlib_8c_1a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</link>);
01244 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1a55ebc92b222c1b8367c3e0e8a36f4bd6">finobjrold</link>&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a497482949c2da7caedb86741c6364395">finobjold1</link>;
01245 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1a497482949c2da7caedb86741c6364395">finobjold1</link>&#32;=&#32;*psurvival;&#32;&#32;<emphasis role="comment">/*&#32;&apos;survival&apos;&#32;survivals&#32;are&#32;old&#32;now&#32;*/</emphasis>
01246 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1a81edc846b7bf03a2c636df88e04d9688">finobjsur</link>&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a7c1118954ba5fdca801f48c9242c1a23">finobj</link>;&#32;&#32;<emphasis role="comment">/*&#32;all&#32;news&#32;are&#32;survivals&#32;*/</emphasis>
01247 
01248 &#32;&#32;<link linkend="_lgc_8c_1ad2640fd798d0468b3832b8b64f1c94f1">sweepgen</link>(L,&#32;g,&#32;&amp;g-&gt;<link linkend="_structglobal___state_1a26a1a773fdf19f6aa0be08d5b8395c26">tobefnz</link>,&#32;NULL,&#32;&amp;<link linkend="_lstrlib_8c_1a7c1d654b7b6114d7a0abc8d351dd1bcd">dummy</link>);
01249 &#32;&#32;<link linkend="_lgc_8c_1ad14690f3e78fd31ce7eddc3acdbeec5b">finishgencycle</link>(L,&#32;g);
01250 }
01251 
01252 
01253 <emphasis role="comment">/*</emphasis>
01254 <emphasis role="comment">**&#32;Clears&#32;all&#32;gray&#32;lists,&#32;sweeps&#32;objects,&#32;and&#32;prepare&#32;sublists&#32;to&#32;enter</emphasis>
01255 <emphasis role="comment">**&#32;generational&#32;mode.&#32;The&#32;sweeps&#32;remove&#32;dead&#32;objects&#32;and&#32;turn&#32;all</emphasis>
01256 <emphasis role="comment">**&#32;surviving&#32;objects&#32;to&#32;old.&#32;Threads&#32;go&#32;back&#32;to&#32;&apos;grayagain&apos;;&#32;everything</emphasis>
01257 <emphasis role="comment">**&#32;else&#32;is&#32;turned&#32;black&#32;(not&#32;in&#32;any&#32;gray&#32;list).</emphasis>
01258 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l01259"/><link linkend="_lgc_8c_1a12beeec7fb7ed46e54b5e7633db83ad9">01259</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a12beeec7fb7ed46e54b5e7633db83ad9">atomic2gen</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g)&#32;{
01260 &#32;&#32;<link linkend="_lgc_8c_1a1811355ed318887d7fd2fdbdc3767eea">cleargraylists</link>(g);
01261 &#32;&#32;<emphasis role="comment">/*&#32;sweep&#32;all&#32;elements&#32;making&#32;them&#32;old&#32;*/</emphasis>
01262 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1aec22885c483e649f2d65368c3507cd9a">gcstate</link>&#32;=&#32;<link linkend="_lgc_8h_1aac9b5b472434aa8d38a89b46b6b29196">GCSswpallgc</link>;
01263 &#32;&#32;<link linkend="_lgc_8c_1a85b353f49bd76eb0199fa5966ee37895">sweep2old</link>(L,&#32;&amp;g-&gt;<link linkend="_structglobal___state_1a3239e7c69845ec6df350dc5b6f1d5291">allgc</link>);
01264 &#32;&#32;<emphasis role="comment">/*&#32;everything&#32;alive&#32;now&#32;is&#32;old&#32;*/</emphasis>
01265 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1abc84a52466de1f5c97cb7b16c88dbe95">reallyold</link>&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a70eec2b8218810b4e2d880f1b9c0eedc">old1</link>&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a1162d3f249bfeebcf52bd0f70e0cc200">survival</link>&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a3239e7c69845ec6df350dc5b6f1d5291">allgc</link>;
01266 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1a531fb511fec0766c7a35ab1a0c3450cb">firstold1</link>&#32;=&#32;NULL;&#32;&#32;<emphasis role="comment">/*&#32;there&#32;are&#32;no&#32;OLD1&#32;objects&#32;anywhere&#32;*/</emphasis>
01267 
01268 &#32;&#32;<emphasis role="comment">/*&#32;repeat&#32;for&#32;&apos;finobj&apos;&#32;lists&#32;*/</emphasis>
01269 &#32;&#32;<link linkend="_lgc_8c_1a85b353f49bd76eb0199fa5966ee37895">sweep2old</link>(L,&#32;&amp;g-&gt;<link linkend="_structglobal___state_1a7c1118954ba5fdca801f48c9242c1a23">finobj</link>);
01270 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1a55ebc92b222c1b8367c3e0e8a36f4bd6">finobjrold</link>&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a497482949c2da7caedb86741c6364395">finobjold1</link>&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a81edc846b7bf03a2c636df88e04d9688">finobjsur</link>&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a7c1118954ba5fdca801f48c9242c1a23">finobj</link>;
01271 
01272 &#32;&#32;<link linkend="_lgc_8c_1a85b353f49bd76eb0199fa5966ee37895">sweep2old</link>(L,&#32;&amp;g-&gt;<link linkend="_structglobal___state_1a26a1a773fdf19f6aa0be08d5b8395c26">tobefnz</link>);
01273 
01274 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1a603b7a85bbaf95ecc2ac48bf08ffe0e6">gckind</link>&#32;=&#32;<link linkend="_lstate_8h_1aa2765fe939333ebc895ba9cedbaa30a0">KGC_GEN</link>;
01275 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1a8c26163424397bcdf9f7d639ff008d0f">lastatomic</link>&#32;=&#32;0;
01276 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1a6a108191b7f626df294d49cbb4380da1">GCestimate</link>&#32;=&#32;<link linkend="_lstate_8h_1a27490dbb57469f3fa83a73d4b7a79df2">gettotalbytes</link>(g);&#32;&#32;<emphasis role="comment">/*&#32;base&#32;for&#32;memory&#32;control&#32;*/</emphasis>
01277 &#32;&#32;<link linkend="_lgc_8c_1ad14690f3e78fd31ce7eddc3acdbeec5b">finishgencycle</link>(L,&#32;g);
01278 }
01279 
01280 
01281 <emphasis role="comment">/*</emphasis>
01282 <emphasis role="comment">**&#32;Enter&#32;generational&#32;mode.&#32;Must&#32;go&#32;until&#32;the&#32;end&#32;of&#32;an&#32;atomic&#32;cycle</emphasis>
01283 <emphasis role="comment">**&#32;to&#32;ensure&#32;that&#32;all&#32;objects&#32;are&#32;correctly&#32;marked&#32;and&#32;weak&#32;tables</emphasis>
01284 <emphasis role="comment">**&#32;are&#32;cleared.&#32;Then,&#32;turn&#32;all&#32;objects&#32;into&#32;old&#32;and&#32;finishes&#32;the</emphasis>
01285 <emphasis role="comment">**&#32;collection.</emphasis>
01286 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l01287"/><link linkend="_lgc_8c_1a2f8aa4c5cfd7f907a35deaa695ca4d3b">01287</link> <emphasis role="keyword">static</emphasis>&#32;<link linkend="_llimits_8h_1aac8c50ca0aa51c80523376da77c2c4d8">lu_mem</link>&#32;<link linkend="_lgc_8c_1a2f8aa4c5cfd7f907a35deaa695ca4d3b">entergen</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g)&#32;{
01288 &#32;&#32;<link linkend="_llimits_8h_1aac8c50ca0aa51c80523376da77c2c4d8">lu_mem</link>&#32;numobjs;
01289 &#32;&#32;<link linkend="_lgc_8c_1a97086b84273579d4c9b42a782f30410d">luaC_runtilstate</link>(L,&#32;<link linkend="_lgc_8h_1af25866c39979dd1f72110cbd3a1a427d">bitmask</link>(<link linkend="_lgc_8h_1ab546d91106ec5cfdba254de13e5b5c5f">GCSpause</link>));&#32;&#32;<emphasis role="comment">/*&#32;prepare&#32;to&#32;start&#32;a&#32;new&#32;cycle&#32;*/</emphasis>
01290 &#32;&#32;<link linkend="_lgc_8c_1a97086b84273579d4c9b42a782f30410d">luaC_runtilstate</link>(L,&#32;<link linkend="_lgc_8h_1af25866c39979dd1f72110cbd3a1a427d">bitmask</link>(<link linkend="_lgc_8h_1a2ed301793747f3a2d0a7fc7d64d482fd">GCSpropagate</link>));&#32;&#32;<emphasis role="comment">/*&#32;start&#32;new&#32;cycle&#32;*/</emphasis>
01291 &#32;&#32;numobjs&#32;=&#32;<link linkend="_lgc_8c_1a41eded2c85eaf7e1911cd95da36882d9">atomic</link>(L);&#32;&#32;<emphasis role="comment">/*&#32;propagates&#32;all&#32;and&#32;then&#32;do&#32;the&#32;atomic&#32;stuff&#32;*/</emphasis>
01292 &#32;&#32;<link linkend="_lgc_8c_1a12beeec7fb7ed46e54b5e7633db83ad9">atomic2gen</link>(L,&#32;g);
01293 &#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;numobjs;
01294 }
01295 
01296 
01297 <emphasis role="comment">/*</emphasis>
01298 <emphasis role="comment">**&#32;Enter&#32;incremental&#32;mode.&#32;Turn&#32;all&#32;objects&#32;white,&#32;make&#32;all</emphasis>
01299 <emphasis role="comment">**&#32;intermediate&#32;lists&#32;point&#32;to&#32;NULL&#32;(to&#32;avoid&#32;invalid&#32;pointers),</emphasis>
01300 <emphasis role="comment">**&#32;and&#32;go&#32;to&#32;the&#32;pause&#32;state.</emphasis>
01301 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l01302"/><link linkend="_lgc_8c_1afed5a93f2093f2a754fb26f31b5207b0">01302</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1afed5a93f2093f2a754fb26f31b5207b0">enterinc</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g)&#32;{
01303 &#32;&#32;<link linkend="_lgc_8c_1a7bb7ff4928b82e65d5844fcaca7d59d8">whitelist</link>(g,&#32;g-&gt;<link linkend="_structglobal___state_1a3239e7c69845ec6df350dc5b6f1d5291">allgc</link>);
01304 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1abc84a52466de1f5c97cb7b16c88dbe95">reallyold</link>&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a70eec2b8218810b4e2d880f1b9c0eedc">old1</link>&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a1162d3f249bfeebcf52bd0f70e0cc200">survival</link>&#32;=&#32;NULL;
01305 &#32;&#32;<link linkend="_lgc_8c_1a7bb7ff4928b82e65d5844fcaca7d59d8">whitelist</link>(g,&#32;g-&gt;<link linkend="_structglobal___state_1a7c1118954ba5fdca801f48c9242c1a23">finobj</link>);
01306 &#32;&#32;<link linkend="_lgc_8c_1a7bb7ff4928b82e65d5844fcaca7d59d8">whitelist</link>(g,&#32;g-&gt;<link linkend="_structglobal___state_1a26a1a773fdf19f6aa0be08d5b8395c26">tobefnz</link>);
01307 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1a55ebc92b222c1b8367c3e0e8a36f4bd6">finobjrold</link>&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a497482949c2da7caedb86741c6364395">finobjold1</link>&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a81edc846b7bf03a2c636df88e04d9688">finobjsur</link>&#32;=&#32;NULL;
01308 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1aec22885c483e649f2d65368c3507cd9a">gcstate</link>&#32;=&#32;<link linkend="_lgc_8h_1ab546d91106ec5cfdba254de13e5b5c5f">GCSpause</link>;
01309 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1a603b7a85bbaf95ecc2ac48bf08ffe0e6">gckind</link>&#32;=&#32;<link linkend="_lstate_8h_1a52c54e51ee8ad2218ac72b745afc2f7d">KGC_INC</link>;
01310 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1a8c26163424397bcdf9f7d639ff008d0f">lastatomic</link>&#32;=&#32;0;
01311 }
01312 
01313 
01314 <emphasis role="comment">/*</emphasis>
01315 <emphasis role="comment">**&#32;Change&#32;collector&#32;mode&#32;to&#32;&apos;newmode&apos;.</emphasis>
01316 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l01317"/><link linkend="_lgc_8h_1a45671ff26d738167ce8e421cc233fc59">01317</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1ac88d5c236307393937e02bc82c10f970">luaC_changemode</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<emphasis role="keywordtype">int</emphasis>&#32;newmode)&#32;{
01318 &#32;&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g&#32;=&#32;<link linkend="_lstate_8h_1a103db2de6edf3420c6c6c9a282562406">G</link>(L);
01319 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(newmode&#32;!=&#32;g-&gt;<link linkend="_structglobal___state_1a603b7a85bbaf95ecc2ac48bf08ffe0e6">gckind</link>)&#32;{
01320 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(newmode&#32;==&#32;<link linkend="_lstate_8h_1aa2765fe939333ebc895ba9cedbaa30a0">KGC_GEN</link>)&#32;&#32;<emphasis role="comment">/*&#32;entering&#32;generational&#32;mode?&#32;*/</emphasis>
01321 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a2f8aa4c5cfd7f907a35deaa695ca4d3b">entergen</link>(L,&#32;g);
01322 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>
01323 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1afed5a93f2093f2a754fb26f31b5207b0">enterinc</link>(g);&#32;&#32;<emphasis role="comment">/*&#32;entering&#32;incremental&#32;mode&#32;*/</emphasis>
01324 &#32;&#32;}
01325 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1a8c26163424397bcdf9f7d639ff008d0f">lastatomic</link>&#32;=&#32;0;
01326 }
01327 
01328 
01329 <emphasis role="comment">/*</emphasis>
01330 <emphasis role="comment">**&#32;Does&#32;a&#32;full&#32;collection&#32;in&#32;generational&#32;mode.</emphasis>
01331 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l01332"/><link linkend="_lgc_8c_1a270a46ab08adc0bb728eeb67b5cc45a9">01332</link> <emphasis role="keyword">static</emphasis>&#32;<link linkend="_llimits_8h_1aac8c50ca0aa51c80523376da77c2c4d8">lu_mem</link>&#32;<link linkend="_lgc_8c_1a270a46ab08adc0bb728eeb67b5cc45a9">fullgen</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g)&#32;{
01333 &#32;&#32;<link linkend="_lgc_8c_1afed5a93f2093f2a754fb26f31b5207b0">enterinc</link>(g);
01334 &#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;<link linkend="_lgc_8c_1a2f8aa4c5cfd7f907a35deaa695ca4d3b">entergen</link>(L,&#32;g);
01335 }
01336 
01337 
01338 <emphasis role="comment">/*</emphasis>
01339 <emphasis role="comment">**&#32;Set&#32;debt&#32;for&#32;the&#32;next&#32;minor&#32;collection,&#32;which&#32;will&#32;happen&#32;when</emphasis>
01340 <emphasis role="comment">**&#32;memory&#32;grows&#32;&apos;genminormul&apos;%.</emphasis>
01341 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l01342"/><link linkend="_lgc_8c_1ab446273aaf611d661bb4c8b6e95360f1">01342</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1ab446273aaf611d661bb4c8b6e95360f1">setminordebt</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g)&#32;{
01343 &#32;&#32;<link linkend="_lstate_8c_1a42e891d6a8e1dc58d9a1487cefd9c236">luaE_setdebt</link>(g,&#32;-(<link linkend="_llimits_8h_1af17d62ec9e237a7644de6b9b34a48a34">cast</link>(<link linkend="_llimits_8h_1a24fc195087e262c99a4cf0f9b346a684">l_mem</link>,&#32;(<link linkend="_lstate_8h_1a27490dbb57469f3fa83a73d4b7a79df2">gettotalbytes</link>(g)&#32;/&#32;100))&#32;*&#32;g-&gt;<link linkend="_structglobal___state_1a8c94405dfaa56f002f0df59c53598658">genminormul</link>));
01344 }
01345 
01346 
01347 <emphasis role="comment">/*</emphasis>
01348 <emphasis role="comment">**&#32;Does&#32;a&#32;major&#32;collection&#32;after&#32;last&#32;collection&#32;was&#32;a&#32;&quot;bad&#32;collection&quot;.</emphasis>
01349 <emphasis role="comment">**</emphasis>
01350 <emphasis role="comment">**&#32;When&#32;the&#32;program&#32;is&#32;building&#32;a&#32;big&#32;structure,&#32;it&#32;allocates&#32;lots&#32;of</emphasis>
01351 <emphasis role="comment">**&#32;memory&#32;but&#32;generates&#32;very&#32;little&#32;garbage.&#32;In&#32;those&#32;scenarios,</emphasis>
01352 <emphasis role="comment">**&#32;the&#32;generational&#32;mode&#32;just&#32;wastes&#32;time&#32;doing&#32;small&#32;collections,&#32;and</emphasis>
01353 <emphasis role="comment">**&#32;major&#32;collections&#32;are&#32;frequently&#32;what&#32;we&#32;call&#32;a&#32;&quot;bad&#32;collection&quot;,&#32;a</emphasis>
01354 <emphasis role="comment">**&#32;collection&#32;that&#32;frees&#32;too&#32;few&#32;objects.&#32;To&#32;avoid&#32;the&#32;cost&#32;of&#32;switching</emphasis>
01355 <emphasis role="comment">**&#32;between&#32;generational&#32;mode&#32;and&#32;the&#32;incremental&#32;mode&#32;needed&#32;for&#32;full</emphasis>
01356 <emphasis role="comment">**&#32;(major)&#32;collections,&#32;the&#32;collector&#32;tries&#32;to&#32;stay&#32;in&#32;incremental&#32;mode</emphasis>
01357 <emphasis role="comment">**&#32;after&#32;a&#32;bad&#32;collection,&#32;and&#32;to&#32;switch&#32;back&#32;to&#32;generational&#32;mode&#32;only</emphasis>
01358 <emphasis role="comment">**&#32;after&#32;a&#32;&quot;good&quot;&#32;collection&#32;(one&#32;that&#32;traverses&#32;less&#32;than&#32;9/8&#32;objects</emphasis>
01359 <emphasis role="comment">**&#32;of&#32;the&#32;previous&#32;one).</emphasis>
01360 <emphasis role="comment">**&#32;The&#32;collector&#32;must&#32;choose&#32;whether&#32;to&#32;stay&#32;in&#32;incremental&#32;mode&#32;or&#32;to</emphasis>
01361 <emphasis role="comment">**&#32;switch&#32;back&#32;to&#32;generational&#32;mode&#32;before&#32;sweeping.&#32;At&#32;this&#32;point,&#32;it</emphasis>
01362 <emphasis role="comment">**&#32;does&#32;not&#32;know&#32;the&#32;real&#32;memory&#32;in&#32;use,&#32;so&#32;it&#32;cannot&#32;use&#32;memory&#32;to</emphasis>
01363 <emphasis role="comment">**&#32;decide&#32;whether&#32;to&#32;return&#32;to&#32;generational&#32;mode.&#32;Instead,&#32;it&#32;uses&#32;the</emphasis>
01364 <emphasis role="comment">**&#32;number&#32;of&#32;objects&#32;traversed&#32;(returned&#32;by&#32;&apos;atomic&apos;)&#32;as&#32;a&#32;proxy.&#32;The</emphasis>
01365 <emphasis role="comment">**&#32;field&#32;&apos;g-&gt;lastatomic&apos;&#32;keeps&#32;this&#32;count&#32;from&#32;the&#32;last&#32;collection.</emphasis>
01366 <emphasis role="comment">**&#32;(&apos;g-&gt;lastatomic&#32;!=&#32;0&apos;&#32;also&#32;means&#32;that&#32;the&#32;last&#32;collection&#32;was&#32;bad.)</emphasis>
01367 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l01368"/><link linkend="_lgc_8c_1a6a3515ae97e70e9ccd0fb50acebc62d1">01368</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a6a3515ae97e70e9ccd0fb50acebc62d1">stepgenfull</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g)&#32;{
01369 &#32;&#32;<link linkend="_llimits_8h_1aac8c50ca0aa51c80523376da77c2c4d8">lu_mem</link>&#32;newatomic;&#32;&#32;<emphasis role="comment">/*&#32;count&#32;of&#32;traversed&#32;objects&#32;*/</emphasis>
01370 &#32;&#32;<link linkend="_llimits_8h_1aac8c50ca0aa51c80523376da77c2c4d8">lu_mem</link>&#32;lastatomic&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a8c26163424397bcdf9f7d639ff008d0f">lastatomic</link>;&#32;&#32;<emphasis role="comment">/*&#32;count&#32;from&#32;last&#32;collection&#32;*/</emphasis>
01371 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(g-&gt;<link linkend="_structglobal___state_1a603b7a85bbaf95ecc2ac48bf08ffe0e6">gckind</link>&#32;==&#32;<link linkend="_lstate_8h_1aa2765fe939333ebc895ba9cedbaa30a0">KGC_GEN</link>)&#32;&#32;<emphasis role="comment">/*&#32;still&#32;in&#32;generational&#32;mode?&#32;*/</emphasis>
01372 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1afed5a93f2093f2a754fb26f31b5207b0">enterinc</link>(g);&#32;&#32;<emphasis role="comment">/*&#32;enter&#32;incremental&#32;mode&#32;*/</emphasis>
01373 &#32;&#32;<link linkend="_lgc_8c_1a97086b84273579d4c9b42a782f30410d">luaC_runtilstate</link>(L,&#32;<link linkend="_lgc_8h_1af25866c39979dd1f72110cbd3a1a427d">bitmask</link>(<link linkend="_lgc_8h_1a2ed301793747f3a2d0a7fc7d64d482fd">GCSpropagate</link>));&#32;&#32;<emphasis role="comment">/*&#32;start&#32;new&#32;cycle&#32;*/</emphasis>
01374 &#32;&#32;newatomic&#32;=&#32;<link linkend="_lgc_8c_1a41eded2c85eaf7e1911cd95da36882d9">atomic</link>(L);&#32;&#32;<emphasis role="comment">/*&#32;mark&#32;everybody&#32;*/</emphasis>
01375 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(newatomic&#32;&lt;&#32;lastatomic&#32;+&#32;(lastatomic&#32;&gt;&gt;&#32;3))&#32;{&#32;&#32;<emphasis role="comment">/*&#32;good&#32;collection?&#32;*/</emphasis>
01376 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a12beeec7fb7ed46e54b5e7633db83ad9">atomic2gen</link>(L,&#32;g);&#32;&#32;<emphasis role="comment">/*&#32;return&#32;to&#32;generational&#32;mode&#32;*/</emphasis>
01377 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ab446273aaf611d661bb4c8b6e95360f1">setminordebt</link>(g);
01378 &#32;&#32;}
01379 &#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;{&#32;&#32;<emphasis role="comment">/*&#32;another&#32;bad&#32;collection;&#32;stay&#32;in&#32;incremental&#32;mode&#32;*/</emphasis>
01380 &#32;&#32;&#32;&#32;g-&gt;<link linkend="_structglobal___state_1a6a108191b7f626df294d49cbb4380da1">GCestimate</link>&#32;=&#32;<link linkend="_lstate_8h_1a27490dbb57469f3fa83a73d4b7a79df2">gettotalbytes</link>(g);&#32;&#32;<emphasis role="comment">/*&#32;first&#32;estimate&#32;*/</emphasis>;
01381 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1aea46d650b68fac11368a752058b80ab7">entersweep</link>(L);
01382 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a97086b84273579d4c9b42a782f30410d">luaC_runtilstate</link>(L,&#32;<link linkend="_lgc_8h_1af25866c39979dd1f72110cbd3a1a427d">bitmask</link>(<link linkend="_lgc_8h_1ab546d91106ec5cfdba254de13e5b5c5f">GCSpause</link>));&#32;&#32;<emphasis role="comment">/*&#32;finish&#32;collection&#32;*/</emphasis>
01383 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ab1a2b0658321a52d5ae0c139b0bf5494">setpause</link>(g);
01384 &#32;&#32;&#32;&#32;g-&gt;<link linkend="_structglobal___state_1a8c26163424397bcdf9f7d639ff008d0f">lastatomic</link>&#32;=&#32;newatomic;
01385 &#32;&#32;}
01386 }
01387 
01388 
01389 <emphasis role="comment">/*</emphasis>
01390 <emphasis role="comment">**&#32;Does&#32;a&#32;generational&#32;&quot;step&quot;.</emphasis>
01391 <emphasis role="comment">**&#32;Usually,&#32;this&#32;means&#32;doing&#32;a&#32;minor&#32;collection&#32;and&#32;setting&#32;the&#32;debt&#32;to</emphasis>
01392 <emphasis role="comment">**&#32;make&#32;another&#32;collection&#32;when&#32;memory&#32;grows&#32;&apos;genminormul&apos;%&#32;larger.</emphasis>
01393 <emphasis role="comment">**</emphasis>
01394 <emphasis role="comment">**&#32;However,&#32;there&#32;are&#32;exceptions.&#32;&#32;If&#32;memory&#32;grows&#32;&apos;genmajormul&apos;%</emphasis>
01395 <emphasis role="comment">**&#32;larger&#32;than&#32;it&#32;was&#32;at&#32;the&#32;end&#32;of&#32;the&#32;last&#32;major&#32;collection&#32;(kept</emphasis>
01396 <emphasis role="comment">**&#32;in&#32;&apos;g-&gt;GCestimate&apos;),&#32;the&#32;function&#32;does&#32;a&#32;major&#32;collection.&#32;At&#32;the</emphasis>
01397 <emphasis role="comment">**&#32;end,&#32;it&#32;checks&#32;whether&#32;the&#32;major&#32;collection&#32;was&#32;able&#32;to&#32;free&#32;a</emphasis>
01398 <emphasis role="comment">**&#32;decent&#32;amount&#32;of&#32;memory&#32;(at&#32;least&#32;half&#32;the&#32;growth&#32;in&#32;memory&#32;since</emphasis>
01399 <emphasis role="comment">**&#32;previous&#32;major&#32;collection).&#32;If&#32;so,&#32;the&#32;collector&#32;keeps&#32;its&#32;state,</emphasis>
01400 <emphasis role="comment">**&#32;and&#32;the&#32;next&#32;collection&#32;will&#32;probably&#32;be&#32;minor&#32;again.&#32;Otherwise,</emphasis>
01401 <emphasis role="comment">**&#32;we&#32;have&#32;what&#32;we&#32;call&#32;a&#32;&quot;bad&#32;collection&quot;.&#32;In&#32;that&#32;case,&#32;set&#32;the&#32;field</emphasis>
01402 <emphasis role="comment">**&#32;&apos;g-&gt;lastatomic&apos;&#32;to&#32;signal&#32;that&#32;fact,&#32;so&#32;that&#32;the&#32;next&#32;collection&#32;will</emphasis>
01403 <emphasis role="comment">**&#32;go&#32;to&#32;&apos;stepgenfull&apos;.</emphasis>
01404 <emphasis role="comment">**</emphasis>
01405 <emphasis role="comment">**&#32;&apos;GCdebt&#32;&lt;=&#32;0&apos;&#32;means&#32;an&#32;explicit&#32;call&#32;to&#32;GC&#32;step&#32;with&#32;&quot;size&quot;&#32;zero;</emphasis>
01406 <emphasis role="comment">**&#32;in&#32;that&#32;case,&#32;do&#32;a&#32;minor&#32;collection.</emphasis>
01407 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l01408"/><link linkend="_lgc_8c_1a3035567259cf4d2269426622ccc0d022">01408</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a3035567259cf4d2269426622ccc0d022">genstep</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g)&#32;{
01409 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(g-&gt;<link linkend="_structglobal___state_1a8c26163424397bcdf9f7d639ff008d0f">lastatomic</link>&#32;!=&#32;0)&#32;&#32;<emphasis role="comment">/*&#32;last&#32;collection&#32;was&#32;a&#32;bad&#32;one?&#32;*/</emphasis>
01410 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a6a3515ae97e70e9ccd0fb50acebc62d1">stepgenfull</link>(L,&#32;g);&#32;&#32;<emphasis role="comment">/*&#32;do&#32;a&#32;full&#32;step&#32;*/</emphasis>
01411 &#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;{
01412 &#32;&#32;&#32;&#32;<link linkend="_llimits_8h_1aac8c50ca0aa51c80523376da77c2c4d8">lu_mem</link>&#32;majorbase&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a6a108191b7f626df294d49cbb4380da1">GCestimate</link>;&#32;&#32;<emphasis role="comment">/*&#32;memory&#32;after&#32;last&#32;major&#32;collection&#32;*/</emphasis>
01413 &#32;&#32;&#32;&#32;<link linkend="_llimits_8h_1aac8c50ca0aa51c80523376da77c2c4d8">lu_mem</link>&#32;majorinc&#32;=&#32;(majorbase&#32;/&#32;100)&#32;*&#32;<link linkend="_lgc_8h_1a1991625e57703760cf5236bc02cd8858">getgcparam</link>(g-&gt;<link linkend="_structglobal___state_1af742f5e67f1ead7df0044b4903a65771">genmajormul</link>);
01414 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(g-&gt;<link linkend="_structglobal___state_1ae466d806319d4ba1b672bbff60f369f9">GCdebt</link>&#32;&gt;&#32;0&#32;&amp;&amp;&#32;<link linkend="_lstate_8h_1a27490dbb57469f3fa83a73d4b7a79df2">gettotalbytes</link>(g)&#32;&gt;&#32;majorbase&#32;+&#32;majorinc)&#32;{
01415 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_llimits_8h_1aac8c50ca0aa51c80523376da77c2c4d8">lu_mem</link>&#32;numobjs&#32;=&#32;<link linkend="_lgc_8c_1a270a46ab08adc0bb728eeb67b5cc45a9">fullgen</link>(L,&#32;g);&#32;&#32;<emphasis role="comment">/*&#32;do&#32;a&#32;major&#32;collection&#32;*/</emphasis>
01416 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lstate_8h_1a27490dbb57469f3fa83a73d4b7a79df2">gettotalbytes</link>(g)&#32;&lt;&#32;majorbase&#32;+&#32;(majorinc&#32;/&#32;2))&#32;{
01417 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;collected&#32;at&#32;least&#32;half&#32;of&#32;memory&#32;growth&#32;since&#32;last&#32;major</emphasis>
01418 <emphasis role="comment">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;collection;&#32;keep&#32;doing&#32;minor&#32;collections&#32;*/</emphasis>
01419 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ab446273aaf611d661bb4c8b6e95360f1">setminordebt</link>(g);
01420 &#32;&#32;&#32;&#32;&#32;&#32;}
01421 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;{&#32;&#32;<emphasis role="comment">/*&#32;bad&#32;collection&#32;*/</emphasis>
01422 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;g-&gt;<link linkend="_structglobal___state_1a8c26163424397bcdf9f7d639ff008d0f">lastatomic</link>&#32;=&#32;numobjs;&#32;&#32;<emphasis role="comment">/*&#32;signal&#32;that&#32;last&#32;collection&#32;was&#32;bad&#32;*/</emphasis>
01423 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ab1a2b0658321a52d5ae0c139b0bf5494">setpause</link>(g);&#32;&#32;<emphasis role="comment">/*&#32;do&#32;a&#32;long&#32;wait&#32;for&#32;next&#32;(major)&#32;collection&#32;*/</emphasis>
01424 &#32;&#32;&#32;&#32;&#32;&#32;}
01425 &#32;&#32;&#32;&#32;}
01426 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;{&#32;&#32;<emphasis role="comment">/*&#32;regular&#32;case;&#32;do&#32;a&#32;minor&#32;collection&#32;*/</emphasis>
01427 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a7528878b4bb9da15db0a23fab038a339">youngcollection</link>(L,&#32;g);
01428 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ab446273aaf611d661bb4c8b6e95360f1">setminordebt</link>(g);
01429 &#32;&#32;&#32;&#32;&#32;&#32;g-&gt;<link linkend="_structglobal___state_1a6a108191b7f626df294d49cbb4380da1">GCestimate</link>&#32;=&#32;majorbase;&#32;&#32;<emphasis role="comment">/*&#32;preserve&#32;base&#32;value&#32;*/</emphasis>
01430 &#32;&#32;&#32;&#32;}
01431 &#32;&#32;}
01432 &#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(<link linkend="_lgc_8h_1a634f3aa786242e81eb2d29da7cdacf4a">isdecGCmodegen</link>(g));
01433 }
01434 
01435 <emphasis role="comment">/*&#32;}======================================================&#32;*/</emphasis>
01436 
01437 
01438 <emphasis role="comment">/*</emphasis>
01439 <emphasis role="comment">**&#32;{======================================================</emphasis>
01440 <emphasis role="comment">**&#32;GC&#32;control</emphasis>
01441 <emphasis role="comment">**&#32;=======================================================</emphasis>
01442 <emphasis role="comment">*/</emphasis>
01443 
01444 
01445 <emphasis role="comment">/*</emphasis>
01446 <emphasis role="comment">**&#32;Set&#32;the&#32;&quot;time&quot;&#32;to&#32;wait&#32;before&#32;starting&#32;a&#32;new&#32;GC&#32;cycle;&#32;cycle&#32;will</emphasis>
01447 <emphasis role="comment">**&#32;start&#32;when&#32;memory&#32;use&#32;hits&#32;the&#32;threshold&#32;of&#32;(&apos;estimate&apos;&#32;*&#32;pause&#32;/</emphasis>
01448 <emphasis role="comment">**&#32;PAUSEADJ).&#32;(Division&#32;by&#32;&apos;estimate&apos;&#32;should&#32;be&#32;OK:&#32;it&#32;cannot&#32;be&#32;zero,</emphasis>
01449 <emphasis role="comment">**&#32;because&#32;Lua&#32;cannot&#32;even&#32;start&#32;with&#32;less&#32;than&#32;PAUSEADJ&#32;bytes).</emphasis>
01450 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l01451"/><link linkend="_lgc_8c_1ab1a2b0658321a52d5ae0c139b0bf5494">01451</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1ab1a2b0658321a52d5ae0c139b0bf5494">setpause</link>&#32;(<link linkend="_structglobal___state">global_State</link>&#32;*g)&#32;{
01452 &#32;&#32;<link linkend="_llimits_8h_1a24fc195087e262c99a4cf0f9b346a684">l_mem</link>&#32;threshold,&#32;debt;
01453 &#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;pause&#32;=&#32;<link linkend="_lgc_8h_1a1991625e57703760cf5236bc02cd8858">getgcparam</link>(g-&gt;<link linkend="_structglobal___state_1af8555bb94d52c1ab47ba9f877ae40494">gcpause</link>);
01454 &#32;&#32;<link linkend="_llimits_8h_1a24fc195087e262c99a4cf0f9b346a684">l_mem</link>&#32;estimate&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a6a108191b7f626df294d49cbb4380da1">GCestimate</link>&#32;/&#32;<link linkend="_lgc_8c_1a79ef06ea1e24ee7e3d343f67e954d68c">PAUSEADJ</link>;&#32;&#32;<emphasis role="comment">/*&#32;adjust&#32;&apos;estimate&apos;&#32;*/</emphasis>
01455 &#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(estimate&#32;&gt;&#32;0);
01456 &#32;&#32;threshold&#32;=&#32;(pause&#32;&lt;&#32;<link linkend="_llimits_8h_1a99e52005f8b99ce8e36df841b281078e">MAX_LMEM</link>&#32;/&#32;estimate)&#32;&#32;<emphasis role="comment">/*&#32;overflow?&#32;*/</emphasis>
01457 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;?&#32;estimate&#32;*&#32;pause&#32;&#32;<emphasis role="comment">/*&#32;no&#32;overflow&#32;*/</emphasis>
01458 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;:&#32;<link linkend="_llimits_8h_1a99e52005f8b99ce8e36df841b281078e">MAX_LMEM</link>;&#32;&#32;<emphasis role="comment">/*&#32;overflow;&#32;truncate&#32;to&#32;maximum&#32;*/</emphasis>
01459 &#32;&#32;debt&#32;=&#32;<link linkend="_lstate_8h_1a27490dbb57469f3fa83a73d4b7a79df2">gettotalbytes</link>(g)&#32;-&#32;threshold;
01460 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(debt&#32;&gt;&#32;0)&#32;debt&#32;=&#32;0;
01461 &#32;&#32;<link linkend="_lstate_8c_1a42e891d6a8e1dc58d9a1487cefd9c236">luaE_setdebt</link>(g,&#32;debt);
01462 }
01463 
01464 
01465 <emphasis role="comment">/*</emphasis>
01466 <emphasis role="comment">**&#32;Enter&#32;first&#32;sweep&#32;phase.</emphasis>
01467 <emphasis role="comment">**&#32;The&#32;call&#32;to&#32;&apos;sweeptolive&apos;&#32;makes&#32;the&#32;pointer&#32;point&#32;to&#32;an&#32;object</emphasis>
01468 <emphasis role="comment">**&#32;inside&#32;the&#32;list&#32;(instead&#32;of&#32;to&#32;the&#32;header),&#32;so&#32;that&#32;the&#32;real&#32;sweep&#32;do</emphasis>
01469 <emphasis role="comment">**&#32;not&#32;need&#32;to&#32;skip&#32;objects&#32;created&#32;between&#32;&quot;now&quot;&#32;and&#32;the&#32;start&#32;of&#32;the</emphasis>
01470 <emphasis role="comment">**&#32;real&#32;sweep.</emphasis>
01471 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l01472"/><link linkend="_lgc_8c_1aea46d650b68fac11368a752058b80ab7">01472</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1aea46d650b68fac11368a752058b80ab7">entersweep</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L)&#32;{
01473 &#32;&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g&#32;=&#32;<link linkend="_lstate_8h_1a103db2de6edf3420c6c6c9a282562406">G</link>(L);
01474 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1aec22885c483e649f2d65368c3507cd9a">gcstate</link>&#32;=&#32;<link linkend="_lgc_8h_1aac9b5b472434aa8d38a89b46b6b29196">GCSswpallgc</link>;
01475 &#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(g-&gt;<link linkend="_structglobal___state_1a6955215dfc015c08152e21f5f225e84a">sweepgc</link>&#32;==&#32;NULL);
01476 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1a6955215dfc015c08152e21f5f225e84a">sweepgc</link>&#32;=&#32;<link linkend="_lgc_8c_1ab518b7adba50d2e796e206dbc96a9d52">sweeptolive</link>(L,&#32;&amp;g-&gt;<link linkend="_structglobal___state_1a3239e7c69845ec6df350dc5b6f1d5291">allgc</link>);
01477 }
01478 
01479 
01480 <emphasis role="comment">/*</emphasis>
01481 <emphasis role="comment">**&#32;Delete&#32;all&#32;objects&#32;in&#32;list&#32;&apos;p&apos;&#32;until&#32;(but&#32;not&#32;including)&#32;object</emphasis>
01482 <emphasis role="comment">**&#32;&apos;limit&apos;.</emphasis>
01483 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l01484"/><link linkend="_lgc_8c_1af9982b911970c350d2a8c071f7c90fb1">01484</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1af9982b911970c350d2a8c071f7c90fb1">deletelist</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*p,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*limit)&#32;{
01485 &#32;&#32;<emphasis role="keywordflow">while</emphasis>&#32;(p&#32;!=&#32;limit)&#32;{
01486 &#32;&#32;&#32;&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*<link linkend="_llex_8c_1a8ab976102fb046f9974c53caaf5a1995">next</link>&#32;=&#32;p-&gt;next;
01487 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1aa198d7da2a8502ed70adfe1f7ed38f46">freeobj</link>(L,&#32;p);
01488 &#32;&#32;&#32;&#32;p&#32;=&#32;<link linkend="_llex_8c_1a8ab976102fb046f9974c53caaf5a1995">next</link>;
01489 &#32;&#32;}
01490 }
01491 
01492 
01493 <emphasis role="comment">/*</emphasis>
01494 <emphasis role="comment">**&#32;Call&#32;all&#32;finalizers&#32;of&#32;the&#32;objects&#32;in&#32;the&#32;given&#32;Lua&#32;state,&#32;and</emphasis>
01495 <emphasis role="comment">**&#32;then&#32;free&#32;all&#32;objects,&#32;except&#32;for&#32;the&#32;main&#32;thread.</emphasis>
01496 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l01497"/><link linkend="_lgc_8h_1a9aa52a500c9cc2076edb1707e6d8a045">01497</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1abad938b33f011ec1088d1a79508c6ac9">luaC_freeallobjects</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L)&#32;{
01498 &#32;&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g&#32;=&#32;<link linkend="_lstate_8h_1a103db2de6edf3420c6c6c9a282562406">G</link>(L);
01499 &#32;&#32;<link linkend="_lgc_8c_1ac88d5c236307393937e02bc82c10f970">luaC_changemode</link>(L,&#32;<link linkend="_lstate_8h_1a52c54e51ee8ad2218ac72b745afc2f7d">KGC_INC</link>);
01500 &#32;&#32;<link linkend="_lgc_8c_1a39f98f28e85cc750b7cca70b10e79ee9">separatetobefnz</link>(g,&#32;1);&#32;&#32;<emphasis role="comment">/*&#32;separate&#32;all&#32;objects&#32;with&#32;finalizers&#32;*/</emphasis>
01501 &#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(g-&gt;<link linkend="_structglobal___state_1a7c1118954ba5fdca801f48c9242c1a23">finobj</link>&#32;==&#32;NULL);
01502 &#32;&#32;<link linkend="_lgc_8c_1a3c6f43e1b63924361ed0ce31b6d30f8b">callallpendingfinalizers</link>(L);
01503 &#32;&#32;<link linkend="_lgc_8c_1af9982b911970c350d2a8c071f7c90fb1">deletelist</link>(L,&#32;g-&gt;<link linkend="_structglobal___state_1a3239e7c69845ec6df350dc5b6f1d5291">allgc</link>,&#32;<link linkend="_lstate_8h_1a254ca29aba03e47440082d4591a9734e">obj2gco</link>(g-&gt;<link linkend="_structglobal___state_1a90da27c9046a3da7fed43ef75957e379">mainthread</link>));
01504 &#32;&#32;<link linkend="_lgc_8c_1af9982b911970c350d2a8c071f7c90fb1">deletelist</link>(L,&#32;g-&gt;<link linkend="_structglobal___state_1a7c1118954ba5fdca801f48c9242c1a23">finobj</link>,&#32;NULL);
01505 &#32;&#32;<link linkend="_lgc_8c_1af9982b911970c350d2a8c071f7c90fb1">deletelist</link>(L,&#32;g-&gt;<link linkend="_structglobal___state_1aaae4d624f0c53c83a285c2dc30a26eb5">fixedgc</link>,&#32;NULL);&#32;&#32;<emphasis role="comment">/*&#32;collect&#32;fixed&#32;objects&#32;*/</emphasis>
01506 &#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(g-&gt;<link linkend="_structglobal___state_1a8a49c5693b4e171bf57b33e32c254f52">strt</link>.<link linkend="_structstringtable_1aa69d4be70d4410a0e505187f4b56e824">nuse</link>&#32;==&#32;0);
01507 }
01508 
01509 
<anchor xml:id="_lgc_8c_source_1l01510"/><link linkend="_lgc_8c_1a41eded2c85eaf7e1911cd95da36882d9">01510</link> <emphasis role="keyword">static</emphasis>&#32;<link linkend="_llimits_8h_1aac8c50ca0aa51c80523376da77c2c4d8">lu_mem</link>&#32;<link linkend="_lgc_8c_1a41eded2c85eaf7e1911cd95da36882d9">atomic</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L)&#32;{
01511 &#32;&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g&#32;=&#32;<link linkend="_lstate_8h_1a103db2de6edf3420c6c6c9a282562406">G</link>(L);
01512 &#32;&#32;<link linkend="_llimits_8h_1aac8c50ca0aa51c80523376da77c2c4d8">lu_mem</link>&#32;work&#32;=&#32;0;
01513 &#32;&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*origweak,&#32;*origall;
01514 &#32;&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;*grayagain&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1af6b3198325143bc0a9a529e9b14ff29a">grayagain</link>;&#32;&#32;<emphasis role="comment">/*&#32;save&#32;original&#32;list&#32;*/</emphasis>
01515 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1af6b3198325143bc0a9a529e9b14ff29a">grayagain</link>&#32;=&#32;NULL;
01516 &#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(g-&gt;<link linkend="_structglobal___state_1aac8b3202114d8c99a73328fff0c3c79c">ephemeron</link>&#32;==&#32;NULL&#32;&amp;&amp;&#32;g-&gt;<link linkend="_structglobal___state_1a26d09b5385bf38c15ca56a9e44b5ef6d">weak</link>&#32;==&#32;NULL);
01517 &#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(!<link linkend="_lgc_8h_1a4c0ce78d476460d2e54914301f4a4bf7">iswhite</link>(g-&gt;<link linkend="_structglobal___state_1a90da27c9046a3da7fed43ef75957e379">mainthread</link>));
01518 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1aec22885c483e649f2d65368c3507cd9a">gcstate</link>&#32;=&#32;<link linkend="_lgc_8h_1a7c7806ab609fa3c19ed9c2b688e10730">GCSatomic</link>;
01519 &#32;&#32;<link linkend="_lgc_8c_1a6ae72c43e48b29944e55933df7f15482">markobject</link>(g,&#32;L);&#32;&#32;<emphasis role="comment">/*&#32;mark&#32;running&#32;thread&#32;*/</emphasis>
01520 &#32;&#32;<emphasis role="comment">/*&#32;registry&#32;and&#32;global&#32;metatables&#32;may&#32;be&#32;changed&#32;by&#32;API&#32;*/</emphasis>
01521 &#32;&#32;<link linkend="_lgc_8c_1a2dd4136ac29665568973c074bc450849">markvalue</link>(g,&#32;&amp;g-&gt;<link linkend="_structglobal___state_1af2551dd930744b33fb4c2964076101fe">l_registry</link>);
01522 &#32;&#32;<link linkend="_lgc_8c_1a9e8dd447c32dde7eeb9fc5da83df09b1">markmt</link>(g);&#32;&#32;<emphasis role="comment">/*&#32;mark&#32;global&#32;metatables&#32;*/</emphasis>
01523 &#32;&#32;work&#32;+=&#32;<link linkend="_lgc_8c_1a344b3515bc8cbe737fbdd9fa1521d17d">propagateall</link>(g);&#32;&#32;<emphasis role="comment">/*&#32;empties&#32;&apos;gray&apos;&#32;list&#32;*/</emphasis>
01524 &#32;&#32;<emphasis role="comment">/*&#32;remark&#32;occasional&#32;upvalues&#32;of&#32;(maybe)&#32;dead&#32;threads&#32;*/</emphasis>
01525 &#32;&#32;work&#32;+=&#32;<link linkend="_lgc_8c_1a563e20dbbab2390ef4ac0ac254f59b71">remarkupvals</link>(g);
01526 &#32;&#32;work&#32;+=&#32;<link linkend="_lgc_8c_1a344b3515bc8cbe737fbdd9fa1521d17d">propagateall</link>(g);&#32;&#32;<emphasis role="comment">/*&#32;propagate&#32;changes&#32;*/</emphasis>
01527 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1a212d17a5d31cf9cd949ba66f16d63139">gray</link>&#32;=&#32;grayagain;
01528 &#32;&#32;work&#32;+=&#32;<link linkend="_lgc_8c_1a344b3515bc8cbe737fbdd9fa1521d17d">propagateall</link>(g);&#32;&#32;<emphasis role="comment">/*&#32;traverse&#32;&apos;grayagain&apos;&#32;list&#32;*/</emphasis>
01529 &#32;&#32;<link linkend="_lgc_8c_1a467150a6e5a6ef4402432c4964817ffc">convergeephemerons</link>(g);
01530 &#32;&#32;<emphasis role="comment">/*&#32;at&#32;this&#32;point,&#32;all&#32;strongly&#32;accessible&#32;objects&#32;are&#32;marked.&#32;*/</emphasis>
01531 &#32;&#32;<emphasis role="comment">/*&#32;Clear&#32;values&#32;from&#32;weak&#32;tables,&#32;before&#32;checking&#32;finalizers&#32;*/</emphasis>
01532 &#32;&#32;<link linkend="_lgc_8c_1a634862684194c98758caa196038d7033">clearbyvalues</link>(g,&#32;g-&gt;<link linkend="_structglobal___state_1a26d09b5385bf38c15ca56a9e44b5ef6d">weak</link>,&#32;NULL);
01533 &#32;&#32;<link linkend="_lgc_8c_1a634862684194c98758caa196038d7033">clearbyvalues</link>(g,&#32;g-&gt;<link linkend="_structglobal___state_1a97f9bda9b7e1f18bb0c68608e6609c89">allweak</link>,&#32;NULL);
01534 &#32;&#32;origweak&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a26d09b5385bf38c15ca56a9e44b5ef6d">weak</link>;&#32;origall&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1a97f9bda9b7e1f18bb0c68608e6609c89">allweak</link>;
01535 &#32;&#32;<link linkend="_lgc_8c_1a39f98f28e85cc750b7cca70b10e79ee9">separatetobefnz</link>(g,&#32;0);&#32;&#32;<emphasis role="comment">/*&#32;separate&#32;objects&#32;to&#32;be&#32;finalized&#32;*/</emphasis>
01536 &#32;&#32;work&#32;+=&#32;<link linkend="_lgc_8c_1afdc11f26c812a8356585e0e6a67b9982">markbeingfnz</link>(g);&#32;&#32;<emphasis role="comment">/*&#32;mark&#32;objects&#32;that&#32;will&#32;be&#32;finalized&#32;*/</emphasis>
01537 &#32;&#32;work&#32;+=&#32;<link linkend="_lgc_8c_1a344b3515bc8cbe737fbdd9fa1521d17d">propagateall</link>(g);&#32;&#32;<emphasis role="comment">/*&#32;remark,&#32;to&#32;propagate&#32;&apos;resurrection&apos;&#32;*/</emphasis>
01538 &#32;&#32;<link linkend="_lgc_8c_1a467150a6e5a6ef4402432c4964817ffc">convergeephemerons</link>(g);
01539 &#32;&#32;<emphasis role="comment">/*&#32;at&#32;this&#32;point,&#32;all&#32;resurrected&#32;objects&#32;are&#32;marked.&#32;*/</emphasis>
01540 &#32;&#32;<emphasis role="comment">/*&#32;remove&#32;dead&#32;objects&#32;from&#32;weak&#32;tables&#32;*/</emphasis>
01541 &#32;&#32;<link linkend="_lgc_8c_1a56ce6be91da7747cf9d93826cf5c8f28">clearbykeys</link>(g,&#32;g-&gt;<link linkend="_structglobal___state_1aac8b3202114d8c99a73328fff0c3c79c">ephemeron</link>);&#32;&#32;<emphasis role="comment">/*&#32;clear&#32;keys&#32;from&#32;all&#32;ephemeron&#32;tables&#32;*/</emphasis>
01542 &#32;&#32;<link linkend="_lgc_8c_1a56ce6be91da7747cf9d93826cf5c8f28">clearbykeys</link>(g,&#32;g-&gt;<link linkend="_structglobal___state_1a97f9bda9b7e1f18bb0c68608e6609c89">allweak</link>);&#32;&#32;<emphasis role="comment">/*&#32;clear&#32;keys&#32;from&#32;all&#32;&apos;allweak&apos;&#32;tables&#32;*/</emphasis>
01543 &#32;&#32;<emphasis role="comment">/*&#32;clear&#32;values&#32;from&#32;resurrected&#32;weak&#32;tables&#32;*/</emphasis>
01544 &#32;&#32;<link linkend="_lgc_8c_1a634862684194c98758caa196038d7033">clearbyvalues</link>(g,&#32;g-&gt;<link linkend="_structglobal___state_1a26d09b5385bf38c15ca56a9e44b5ef6d">weak</link>,&#32;origweak);
01545 &#32;&#32;<link linkend="_lgc_8c_1a634862684194c98758caa196038d7033">clearbyvalues</link>(g,&#32;g-&gt;<link linkend="_structglobal___state_1a97f9bda9b7e1f18bb0c68608e6609c89">allweak</link>,&#32;origall);
01546 &#32;&#32;<link linkend="_lstring_8c_1a10917db68b530e7756e2e1fc6ed4d172">luaS_clearcache</link>(g);
01547 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1aba5efd49f9d630bd5e036fcd063ae6b5">currentwhite</link>&#32;=&#32;<link linkend="_llimits_8h_1a596f5b6e992f53a5a4e5732083448dd4">cast_byte</link>(<link linkend="_lgc_8h_1a486df16493498577d4081a8c231154f0">otherwhite</link>(g));&#32;&#32;<emphasis role="comment">/*&#32;flip&#32;current&#32;white&#32;*/</emphasis>
01548 &#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(g-&gt;<link linkend="_structglobal___state_1a212d17a5d31cf9cd949ba66f16d63139">gray</link>&#32;==&#32;NULL);
01549 &#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;work;&#32;&#32;<emphasis role="comment">/*&#32;estimate&#32;of&#32;slots&#32;marked&#32;by&#32;&apos;atomic&apos;&#32;*/</emphasis>
01550 }
01551 
01552 
<anchor xml:id="_lgc_8c_source_1l01553"/><link linkend="_lgc_8c_1a2669bab5717396ec41dda4e5bc46c140">01553</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_lgc_8c_1a2669bab5717396ec41dda4e5bc46c140">sweepstep</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g,
01554 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;nextstate,&#32;<link linkend="_struct_g_c_object">GCObject</link>&#32;**nextlist)&#32;{
01555 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(g-&gt;<link linkend="_structglobal___state_1a6955215dfc015c08152e21f5f225e84a">sweepgc</link>)&#32;{
01556 &#32;&#32;&#32;&#32;<link linkend="_llimits_8h_1a24fc195087e262c99a4cf0f9b346a684">l_mem</link>&#32;olddebt&#32;=&#32;g-&gt;<link linkend="_structglobal___state_1ae466d806319d4ba1b672bbff60f369f9">GCdebt</link>;
01557 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;count;
01558 &#32;&#32;&#32;&#32;g-&gt;<link linkend="_structglobal___state_1a6955215dfc015c08152e21f5f225e84a">sweepgc</link>&#32;=&#32;<link linkend="_lgc_8c_1a88abd139efb3d69379bf4ee92b84a65d">sweeplist</link>(L,&#32;g-&gt;<link linkend="_structglobal___state_1a6955215dfc015c08152e21f5f225e84a">sweepgc</link>,&#32;<link linkend="_lgc_8c_1ac31abb557425090d41f055c797049ba8">GCSWEEPMAX</link>,&#32;&amp;count);
01559 &#32;&#32;&#32;&#32;g-&gt;<link linkend="_structglobal___state_1a6a108191b7f626df294d49cbb4380da1">GCestimate</link>&#32;+=&#32;g-&gt;<link linkend="_structglobal___state_1ae466d806319d4ba1b672bbff60f369f9">GCdebt</link>&#32;-&#32;olddebt;&#32;&#32;<emphasis role="comment">/*&#32;update&#32;estimate&#32;*/</emphasis>
01560 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;count;
01561 &#32;&#32;}
01562 &#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;{&#32;&#32;<emphasis role="comment">/*&#32;enter&#32;next&#32;state&#32;*/</emphasis>
01563 &#32;&#32;&#32;&#32;g-&gt;<link linkend="_structglobal___state_1aec22885c483e649f2d65368c3507cd9a">gcstate</link>&#32;=&#32;nextstate;
01564 &#32;&#32;&#32;&#32;g-&gt;<link linkend="_structglobal___state_1a6955215dfc015c08152e21f5f225e84a">sweepgc</link>&#32;=&#32;nextlist;
01565 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;0;&#32;&#32;<emphasis role="comment">/*&#32;no&#32;work&#32;done&#32;*/</emphasis>
01566 &#32;&#32;}
01567 }
01568 
01569 
<anchor xml:id="_lgc_8c_source_1l01570"/><link linkend="_lgc_8c_1ae34e22198155f5d365fe500d3735c150">01570</link> <emphasis role="keyword">static</emphasis>&#32;<link linkend="_llimits_8h_1aac8c50ca0aa51c80523376da77c2c4d8">lu_mem</link>&#32;<link linkend="_lgc_8c_1ae34e22198155f5d365fe500d3735c150">singlestep</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L)&#32;{
01571 &#32;&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g&#32;=&#32;<link linkend="_lstate_8h_1a103db2de6edf3420c6c6c9a282562406">G</link>(L);
01572 &#32;&#32;<emphasis role="keywordflow">switch</emphasis>&#32;(g-&gt;<link linkend="_structglobal___state_1aec22885c483e649f2d65368c3507cd9a">gcstate</link>)&#32;{
01573 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lgc_8h_1ab546d91106ec5cfdba254de13e5b5c5f">GCSpause</link>:&#32;{
01574 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1abc346fb7129981227c874ba0e22a480f">restartcollection</link>(g);
01575 &#32;&#32;&#32;&#32;&#32;&#32;g-&gt;<link linkend="_structglobal___state_1aec22885c483e649f2d65368c3507cd9a">gcstate</link>&#32;=&#32;<link linkend="_lgc_8h_1a2ed301793747f3a2d0a7fc7d64d482fd">GCSpropagate</link>;
01576 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;1;
01577 &#32;&#32;&#32;&#32;}
01578 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lgc_8h_1a2ed301793747f3a2d0a7fc7d64d482fd">GCSpropagate</link>:&#32;{
01579 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(g-&gt;<link linkend="_structglobal___state_1a212d17a5d31cf9cd949ba66f16d63139">gray</link>&#32;==&#32;NULL)&#32;{&#32;&#32;<emphasis role="comment">/*&#32;no&#32;more&#32;gray&#32;objects?&#32;*/</emphasis>
01580 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;g-&gt;<link linkend="_structglobal___state_1aec22885c483e649f2d65368c3507cd9a">gcstate</link>&#32;=&#32;<link linkend="_lgc_8h_1a7d4a80ad5991cca9822822f63deef987">GCSenteratomic</link>;&#32;&#32;<emphasis role="comment">/*&#32;finish&#32;propagate&#32;phase&#32;*/</emphasis>
01581 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;0;
01582 &#32;&#32;&#32;&#32;&#32;&#32;}
01583 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>
01584 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;<link linkend="_lgc_8c_1a817005bec4f6438093ec8bff63363f25">propagatemark</link>(g);&#32;&#32;<emphasis role="comment">/*&#32;traverse&#32;one&#32;gray&#32;object&#32;*/</emphasis>
01585 &#32;&#32;&#32;&#32;}
01586 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lgc_8h_1a7d4a80ad5991cca9822822f63deef987">GCSenteratomic</link>:&#32;{
01587 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_llimits_8h_1aac8c50ca0aa51c80523376da77c2c4d8">lu_mem</link>&#32;work&#32;=&#32;<link linkend="_lgc_8c_1a41eded2c85eaf7e1911cd95da36882d9">atomic</link>(L);&#32;&#32;<emphasis role="comment">/*&#32;work&#32;is&#32;what&#32;was&#32;traversed&#32;by&#32;&apos;atomic&apos;&#32;*/</emphasis>
01588 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1aea46d650b68fac11368a752058b80ab7">entersweep</link>(L);
01589 &#32;&#32;&#32;&#32;&#32;&#32;g-&gt;<link linkend="_structglobal___state_1a6a108191b7f626df294d49cbb4380da1">GCestimate</link>&#32;=&#32;<link linkend="_lstate_8h_1a27490dbb57469f3fa83a73d4b7a79df2">gettotalbytes</link>(g);&#32;&#32;<emphasis role="comment">/*&#32;first&#32;estimate&#32;*/</emphasis>;
01590 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;work;
01591 &#32;&#32;&#32;&#32;}
01592 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lgc_8h_1aac9b5b472434aa8d38a89b46b6b29196">GCSswpallgc</link>:&#32;{&#32;&#32;<emphasis role="comment">/*&#32;sweep&#32;&quot;regular&quot;&#32;objects&#32;*/</emphasis>
01593 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;<link linkend="_lgc_8c_1a2669bab5717396ec41dda4e5bc46c140">sweepstep</link>(L,&#32;g,&#32;<link linkend="_lgc_8h_1a9d28766c63918e69c9ea3853a3e6c4c0">GCSswpfinobj</link>,&#32;&amp;g-&gt;<link linkend="_structglobal___state_1a7c1118954ba5fdca801f48c9242c1a23">finobj</link>);
01594 &#32;&#32;&#32;&#32;}
01595 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lgc_8h_1a9d28766c63918e69c9ea3853a3e6c4c0">GCSswpfinobj</link>:&#32;{&#32;&#32;<emphasis role="comment">/*&#32;sweep&#32;objects&#32;with&#32;finalizers&#32;*/</emphasis>
01596 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;<link linkend="_lgc_8c_1a2669bab5717396ec41dda4e5bc46c140">sweepstep</link>(L,&#32;g,&#32;<link linkend="_lgc_8h_1a152f379e712cbc7f0bfa2c6a3e15166d">GCSswptobefnz</link>,&#32;&amp;g-&gt;<link linkend="_structglobal___state_1a26a1a773fdf19f6aa0be08d5b8395c26">tobefnz</link>);
01597 &#32;&#32;&#32;&#32;}
01598 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lgc_8h_1a152f379e712cbc7f0bfa2c6a3e15166d">GCSswptobefnz</link>:&#32;{&#32;&#32;<emphasis role="comment">/*&#32;sweep&#32;objects&#32;to&#32;be&#32;finalized&#32;*/</emphasis>
01599 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;<link linkend="_lgc_8c_1a2669bab5717396ec41dda4e5bc46c140">sweepstep</link>(L,&#32;g,&#32;<link linkend="_lgc_8h_1a4e40597ebd731cafa743cd9a8e0db709">GCSswpend</link>,&#32;NULL);
01600 &#32;&#32;&#32;&#32;}
01601 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lgc_8h_1a4e40597ebd731cafa743cd9a8e0db709">GCSswpend</link>:&#32;{&#32;&#32;<emphasis role="comment">/*&#32;finish&#32;sweeps&#32;*/</emphasis>
01602 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a1b2909449f815733deb4bc35c0103002">checkSizes</link>(L,&#32;g);
01603 &#32;&#32;&#32;&#32;&#32;&#32;g-&gt;<link linkend="_structglobal___state_1aec22885c483e649f2d65368c3507cd9a">gcstate</link>&#32;=&#32;<link linkend="_lgc_8h_1a84094ff0ba3d8c7d4f84984e74f7705a">GCScallfin</link>;
01604 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;0;
01605 &#32;&#32;&#32;&#32;}
01606 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="_lgc_8h_1a84094ff0ba3d8c7d4f84984e74f7705a">GCScallfin</link>:&#32;{&#32;&#32;<emphasis role="comment">/*&#32;call&#32;remaining&#32;finalizers&#32;*/</emphasis>
01607 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(g-&gt;<link linkend="_structglobal___state_1a26a1a773fdf19f6aa0be08d5b8395c26">tobefnz</link>&#32;&amp;&amp;&#32;!g-&gt;<link linkend="_structglobal___state_1ae6cc757dac1c965fb147c2886d48e1fa">gcemergency</link>)&#32;{
01608 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;n&#32;=&#32;<link linkend="_lgc_8c_1a5ba38781fc577f890c6f97af9beef40a">runafewfinalizers</link>(L,&#32;<link linkend="_lgc_8c_1ac3a3667112bce0a226dbef4640edee94">GCFINMAX</link>);
01609 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;n&#32;*&#32;<link linkend="_lgc_8c_1a84dfd5e385ed6792c171df6b6a972179">GCFINALIZECOST</link>;
01610 &#32;&#32;&#32;&#32;&#32;&#32;}
01611 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;{&#32;&#32;<emphasis role="comment">/*&#32;emergency&#32;mode&#32;or&#32;no&#32;more&#32;finalizers&#32;*/</emphasis>
01612 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;g-&gt;<link linkend="_structglobal___state_1aec22885c483e649f2d65368c3507cd9a">gcstate</link>&#32;=&#32;<link linkend="_lgc_8h_1ab546d91106ec5cfdba254de13e5b5c5f">GCSpause</link>;&#32;&#32;<emphasis role="comment">/*&#32;finish&#32;collection&#32;*/</emphasis>
01613 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;0;
01614 &#32;&#32;&#32;&#32;&#32;&#32;}
01615 &#32;&#32;&#32;&#32;}
01616 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">default</emphasis>:&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(0);&#32;<emphasis role="keywordflow">return</emphasis>&#32;0;
01617 &#32;&#32;}
01618 }
01619 
01620 
01621 <emphasis role="comment">/*</emphasis>
01622 <emphasis role="comment">**&#32;advances&#32;the&#32;garbage&#32;collector&#32;until&#32;it&#32;reaches&#32;a&#32;state&#32;allowed</emphasis>
01623 <emphasis role="comment">**&#32;by&#32;&apos;statemask&apos;</emphasis>
01624 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l01625"/><link linkend="_lgc_8h_1a1da32357417ce5766ed5e3ada033c32f">01625</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a97086b84273579d4c9b42a782f30410d">luaC_runtilstate</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<emphasis role="keywordtype">int</emphasis>&#32;statesmask)&#32;{
01626 &#32;&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g&#32;=&#32;<link linkend="_lstate_8h_1a103db2de6edf3420c6c6c9a282562406">G</link>(L);
01627 &#32;&#32;<emphasis role="keywordflow">while</emphasis>&#32;(!<link linkend="_lgc_8h_1a25c19ff3161e2a2395ba69fdef49915f">testbit</link>(statesmask,&#32;g-&gt;<link linkend="_structglobal___state_1aec22885c483e649f2d65368c3507cd9a">gcstate</link>))
01628 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ae34e22198155f5d365fe500d3735c150">singlestep</link>(L);
01629 }
01630 
01631 
01632 <emphasis role="comment">/*</emphasis>
01633 <emphasis role="comment">**&#32;Performs&#32;a&#32;basic&#32;incremental&#32;step.&#32;The&#32;debt&#32;and&#32;step&#32;size&#32;are</emphasis>
01634 <emphasis role="comment">**&#32;converted&#32;from&#32;bytes&#32;to&#32;&quot;units&#32;of&#32;work&quot;;&#32;then&#32;the&#32;function&#32;loops</emphasis>
01635 <emphasis role="comment">**&#32;running&#32;single&#32;steps&#32;until&#32;adding&#32;that&#32;many&#32;units&#32;of&#32;work&#32;or</emphasis>
01636 <emphasis role="comment">**&#32;finishing&#32;a&#32;cycle&#32;(pause&#32;state).&#32;Finally,&#32;it&#32;sets&#32;the&#32;debt&#32;that</emphasis>
01637 <emphasis role="comment">**&#32;controls&#32;when&#32;next&#32;step&#32;will&#32;be&#32;performed.</emphasis>
01638 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l01639"/><link linkend="_lgc_8c_1a3a70dfeab5db063c688d7e200d63a7c1">01639</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1a3a70dfeab5db063c688d7e200d63a7c1">incstep</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g)&#32;{
01640 &#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;stepmul&#32;=&#32;(<link linkend="_lgc_8h_1a1991625e57703760cf5236bc02cd8858">getgcparam</link>(g-&gt;<link linkend="_structglobal___state_1aaf11518fe18dec6b3e2e4d8a9a95f428">gcstepmul</link>)&#32;|&#32;1);&#32;&#32;<emphasis role="comment">/*&#32;avoid&#32;division&#32;by&#32;0&#32;*/</emphasis>
01641 &#32;&#32;<link linkend="_llimits_8h_1a24fc195087e262c99a4cf0f9b346a684">l_mem</link>&#32;debt&#32;=&#32;(g-&gt;<link linkend="_structglobal___state_1ae466d806319d4ba1b672bbff60f369f9">GCdebt</link>&#32;/&#32;<link linkend="_lgc_8c_1a2f1af1a74ed552d994ae1a8f830bd6d2">WORK2MEM</link>)&#32;*&#32;stepmul;
01642 &#32;&#32;<link linkend="_llimits_8h_1a24fc195087e262c99a4cf0f9b346a684">l_mem</link>&#32;stepsize&#32;=&#32;(g-&gt;<link linkend="_structglobal___state_1a20818519922dad51df664111576a73b8">gcstepsize</link>&#32;&lt;=&#32;<link linkend="_llimits_8h_1a201d8e40e2923328862d720d0dc6a952">log2maxs</link>(<link linkend="_llimits_8h_1a24fc195087e262c99a4cf0f9b346a684">l_mem</link>))
01643 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;?&#32;((<link linkend="_llimits_8h_1af17d62ec9e237a7644de6b9b34a48a34">cast</link>(<link linkend="_llimits_8h_1a24fc195087e262c99a4cf0f9b346a684">l_mem</link>,&#32;1)&#32;&lt;&lt;&#32;g-&gt;<link linkend="_structglobal___state_1a20818519922dad51df664111576a73b8">gcstepsize</link>)&#32;/&#32;<link linkend="_lgc_8c_1a2f1af1a74ed552d994ae1a8f830bd6d2">WORK2MEM</link>)&#32;*&#32;stepmul
01644 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;:&#32;<link linkend="_llimits_8h_1a99e52005f8b99ce8e36df841b281078e">MAX_LMEM</link>;&#32;&#32;<emphasis role="comment">/*&#32;overflow;&#32;keep&#32;maximum&#32;value&#32;*/</emphasis>
01645 &#32;&#32;<emphasis role="keywordflow">do</emphasis>&#32;{&#32;&#32;<emphasis role="comment">/*&#32;repeat&#32;until&#32;pause&#32;or&#32;enough&#32;&quot;credit&quot;&#32;(negative&#32;debt)&#32;*/</emphasis>
01646 &#32;&#32;&#32;&#32;<link linkend="_llimits_8h_1aac8c50ca0aa51c80523376da77c2c4d8">lu_mem</link>&#32;work&#32;=&#32;<link linkend="_lgc_8c_1ae34e22198155f5d365fe500d3735c150">singlestep</link>(L);&#32;&#32;<emphasis role="comment">/*&#32;perform&#32;one&#32;single&#32;step&#32;*/</emphasis>
01647 &#32;&#32;&#32;&#32;debt&#32;-=&#32;work;
01648 &#32;&#32;}&#32;<emphasis role="keywordflow">while</emphasis>&#32;(debt&#32;&gt;&#32;-stepsize&#32;&amp;&amp;&#32;g-&gt;<link linkend="_structglobal___state_1aec22885c483e649f2d65368c3507cd9a">gcstate</link>&#32;!=&#32;<link linkend="_lgc_8h_1ab546d91106ec5cfdba254de13e5b5c5f">GCSpause</link>);
01649 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(g-&gt;<link linkend="_structglobal___state_1aec22885c483e649f2d65368c3507cd9a">gcstate</link>&#32;==&#32;<link linkend="_lgc_8h_1ab546d91106ec5cfdba254de13e5b5c5f">GCSpause</link>)
01650 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ab1a2b0658321a52d5ae0c139b0bf5494">setpause</link>(g);&#32;&#32;<emphasis role="comment">/*&#32;pause&#32;until&#32;next&#32;cycle&#32;*/</emphasis>
01651 &#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;{
01652 &#32;&#32;&#32;&#32;debt&#32;=&#32;(debt&#32;/&#32;stepmul)&#32;*&#32;<link linkend="_lgc_8c_1a2f1af1a74ed552d994ae1a8f830bd6d2">WORK2MEM</link>;&#32;&#32;<emphasis role="comment">/*&#32;convert&#32;&apos;work&#32;units&apos;&#32;to&#32;bytes&#32;*/</emphasis>
01653 &#32;&#32;&#32;&#32;<link linkend="_lstate_8c_1a42e891d6a8e1dc58d9a1487cefd9c236">luaE_setdebt</link>(g,&#32;debt);
01654 &#32;&#32;}
01655 }
01656 
01657 <emphasis role="comment">/*</emphasis>
01658 <emphasis role="comment">**&#32;performs&#32;a&#32;basic&#32;GC&#32;step&#32;if&#32;collector&#32;is&#32;running</emphasis>
01659 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l01660"/><link linkend="_lgc_8h_1a6c71cc4b9e503c0e96c0c4ffcff93900">01660</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1ab0133eb7bb37a0a690e0ef71fbc13414">luaC_step</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L)&#32;{
01661 &#32;&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g&#32;=&#32;<link linkend="_lstate_8h_1a103db2de6edf3420c6c6c9a282562406">G</link>(L);
01662 &#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(!g-&gt;<link linkend="_structglobal___state_1ae6cc757dac1c965fb147c2886d48e1fa">gcemergency</link>);
01663 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(g-&gt;<link linkend="_structglobal___state_1a39557d352dfca7f1553b694d54c0b662">gcrunning</link>)&#32;{&#32;&#32;<emphasis role="comment">/*&#32;running?&#32;*/</emphasis>
01664 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>(<link linkend="_lgc_8h_1a634f3aa786242e81eb2d29da7cdacf4a">isdecGCmodegen</link>(g))
01665 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a3035567259cf4d2269426622ccc0d022">genstep</link>(L,&#32;g);
01666 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>
01667 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a3a70dfeab5db063c688d7e200d63a7c1">incstep</link>(L,&#32;g);
01668 &#32;&#32;}
01669 }
01670 
01671 
01672 <emphasis role="comment">/*</emphasis>
01673 <emphasis role="comment">**&#32;Perform&#32;a&#32;full&#32;collection&#32;in&#32;incremental&#32;mode.</emphasis>
01674 <emphasis role="comment">**&#32;Before&#32;running&#32;the&#32;collection,&#32;check&#32;&apos;keepinvariant&apos;;&#32;if&#32;it&#32;is&#32;true,</emphasis>
01675 <emphasis role="comment">**&#32;there&#32;may&#32;be&#32;some&#32;objects&#32;marked&#32;as&#32;black,&#32;so&#32;the&#32;collector&#32;has</emphasis>
01676 <emphasis role="comment">**&#32;to&#32;sweep&#32;all&#32;objects&#32;to&#32;turn&#32;them&#32;back&#32;to&#32;white&#32;(as&#32;white&#32;has&#32;not</emphasis>
01677 <emphasis role="comment">**&#32;changed,&#32;nothing&#32;will&#32;be&#32;collected).</emphasis>
01678 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l01679"/><link linkend="_lgc_8c_1ac6dccdcfb264cbc5f1776cea79c8e375">01679</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1ac6dccdcfb264cbc5f1776cea79c8e375">fullinc</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g)&#32;{
01680 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="_lgc_8h_1a40b40242e96f45f8d04dcf4feb1475ae">keepinvariant</link>(g))&#32;&#32;<emphasis role="comment">/*&#32;black&#32;objects?&#32;*/</emphasis>
01681 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1aea46d650b68fac11368a752058b80ab7">entersweep</link>(L);&#32;<emphasis role="comment">/*&#32;sweep&#32;everything&#32;to&#32;turn&#32;them&#32;back&#32;to&#32;white&#32;*/</emphasis>
01682 &#32;&#32;<emphasis role="comment">/*&#32;finish&#32;any&#32;pending&#32;sweep&#32;phase&#32;to&#32;start&#32;a&#32;new&#32;cycle&#32;*/</emphasis>
01683 &#32;&#32;<link linkend="_lgc_8c_1a97086b84273579d4c9b42a782f30410d">luaC_runtilstate</link>(L,&#32;<link linkend="_lgc_8h_1af25866c39979dd1f72110cbd3a1a427d">bitmask</link>(<link linkend="_lgc_8h_1ab546d91106ec5cfdba254de13e5b5c5f">GCSpause</link>));
01684 &#32;&#32;<link linkend="_lgc_8c_1a97086b84273579d4c9b42a782f30410d">luaC_runtilstate</link>(L,&#32;<link linkend="_lgc_8h_1af25866c39979dd1f72110cbd3a1a427d">bitmask</link>(<link linkend="_lgc_8h_1a84094ff0ba3d8c7d4f84984e74f7705a">GCScallfin</link>));&#32;&#32;<emphasis role="comment">/*&#32;run&#32;up&#32;to&#32;finalizers&#32;*/</emphasis>
01685 &#32;&#32;<emphasis role="comment">/*&#32;estimate&#32;must&#32;be&#32;correct&#32;after&#32;a&#32;full&#32;GC&#32;cycle&#32;*/</emphasis>
01686 &#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(g-&gt;<link linkend="_structglobal___state_1a6a108191b7f626df294d49cbb4380da1">GCestimate</link>&#32;==&#32;<link linkend="_lstate_8h_1a27490dbb57469f3fa83a73d4b7a79df2">gettotalbytes</link>(g));
01687 &#32;&#32;<link linkend="_lgc_8c_1a97086b84273579d4c9b42a782f30410d">luaC_runtilstate</link>(L,&#32;<link linkend="_lgc_8h_1af25866c39979dd1f72110cbd3a1a427d">bitmask</link>(<link linkend="_lgc_8h_1ab546d91106ec5cfdba254de13e5b5c5f">GCSpause</link>));&#32;&#32;<emphasis role="comment">/*&#32;finish&#32;collection&#32;*/</emphasis>
01688 &#32;&#32;<link linkend="_lgc_8c_1ab1a2b0658321a52d5ae0c139b0bf5494">setpause</link>(g);
01689 }
01690 
01691 
01692 <emphasis role="comment">/*</emphasis>
01693 <emphasis role="comment">**&#32;Performs&#32;a&#32;full&#32;GC&#32;cycle;&#32;if&#32;&apos;isemergency&apos;,&#32;set&#32;a&#32;flag&#32;to&#32;avoid</emphasis>
01694 <emphasis role="comment">**&#32;some&#32;operations&#32;which&#32;could&#32;change&#32;the&#32;interpreter&#32;state&#32;in&#32;some</emphasis>
01695 <emphasis role="comment">**&#32;unexpected&#32;ways&#32;(running&#32;finalizers&#32;and&#32;shrinking&#32;some&#32;structures).</emphasis>
01696 <emphasis role="comment">*/</emphasis>
<anchor xml:id="_lgc_8c_source_1l01697"/><link linkend="_lgc_8h_1aa0b753c3ed80e1eed0379ec58592c404">01697</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_lgc_8c_1ac48130e5263ad8be09a9c51dae6125b9">luaC_fullgc</link>&#32;(<link linkend="_structlua___state">lua_State</link>&#32;*L,&#32;<emphasis role="keywordtype">int</emphasis>&#32;isemergency)&#32;{
01698 &#32;&#32;<link linkend="_structglobal___state">global_State</link>&#32;*g&#32;=&#32;<link linkend="_lstate_8h_1a103db2de6edf3420c6c6c9a282562406">G</link>(L);
01699 &#32;&#32;<link linkend="_llimits_8h_1a5978f5fda715bd80e845df1e16ad7780">lua_assert</link>(!g-&gt;<link linkend="_structglobal___state_1ae6cc757dac1c965fb147c2886d48e1fa">gcemergency</link>);
01700 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1ae6cc757dac1c965fb147c2886d48e1fa">gcemergency</link>&#32;=&#32;isemergency;&#32;&#32;<emphasis role="comment">/*&#32;set&#32;flag&#32;*/</emphasis>
01701 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(g-&gt;<link linkend="_structglobal___state_1a603b7a85bbaf95ecc2ac48bf08ffe0e6">gckind</link>&#32;==&#32;<link linkend="_lstate_8h_1a52c54e51ee8ad2218ac72b745afc2f7d">KGC_INC</link>)
01702 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1ac6dccdcfb264cbc5f1776cea79c8e375">fullinc</link>(L,&#32;g);
01703 &#32;&#32;<emphasis role="keywordflow">else</emphasis>
01704 &#32;&#32;&#32;&#32;<link linkend="_lgc_8c_1a270a46ab08adc0bb728eeb67b5cc45a9">fullgen</link>(L,&#32;g);
01705 &#32;&#32;g-&gt;<link linkend="_structglobal___state_1ae6cc757dac1c965fb147c2886d48e1fa">gcemergency</link>&#32;=&#32;0;
01706 }
01707 
01708 <emphasis role="comment">/*&#32;}======================================================&#32;*/</emphasis>
01709 
01710 
</programlisting></section>
